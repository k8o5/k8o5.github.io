<!DOCTYPE html>
<html lang="en" style="--desktop-icon-scale-factor: 1;">
<head>
    <meta charset="UTF-8">
    <title>k8OS v2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Favicons & Meta -->
    <link id="favicon" rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí†</text></svg>">
    
    <!-- Scripts/Imports (Kept Original) -->
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.8.3/dist/es-module-shims.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai",
        "marked": "https://esm.run/marked@4.0.12"
      }
    }
    </script>

    <style>
        /* --- k8OS V2 "Glass Core" CSS --- */
        :root {
            --bg-dark: #09090b;
            --glass-bg: rgba(20, 20, 25, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass-blur: blur(20px);
            --glass-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            --accent: #8b5cf6; /* Violet */
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --font-main: 'Segoe UI', 'Inter', system-ui, sans-serif;
            --font-mono: 'Fira Code', 'Consolas', monospace;
            --desktop-icon-base-size: 48px;
            --desktop-icon-scale-factor: 1.0;
            
            /* Mapped Legacy Variables to V2 Styles for compatibility */
            --win95-bg: var(--bg-dark);
            --win95-light-gray: var(--glass-bg); 
            --win95-dark-gray: rgba(255,255,255,0.2);
            --win95-white: #ffffff;
            --win95-black: #000000;
            --win95-button-face: rgba(255,255,255,0.05);
            --win95-title-blue: transparent;
            --win95-title-text: var(--text-main);
            --win95-font: var(--font-main);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: var(--font-main);
            background-color: #000;
            background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #020203 100%);
            background-size: cover;
            background-position: center;
            margin: 0; padding: 0;
            overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
            color: var(--text-main);
            user-select: none;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* --- Desktop & Icons --- */
        .desktop {
            flex-grow: 1; position: relative; padding: 20px;
            display: flex; flex-direction: column; flex-wrap: wrap;
            align-items: flex-start; align-content: flex-start; gap: 10px;
            z-index: 1;
        }

        .desktop-icon {
            display: flex; flex-direction: column; align-items: center;
            text-align: center; width: 90px; padding: 10px;
            border-radius: 12px; cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .desktop-icon:hover { background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .desktop-icon.selected { background: rgba(139, 92, 246, 0.3); border: 1px solid rgba(139, 92, 246, 0.5); }
        
        .desktop-icon .icon-placeholder {
            font-size: 32px; margin-bottom: 8px;
            background: transparent; border: none;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4));
            width: auto; height: auto; display: block;
        }
        .desktop-icon span { font-size: 12px; font-weight: 500; line-height: 1.2; }

        /* --- Windows (Glassmorphism) --- */
        .window {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
            min-width: 300px; min-height: 200px;
            display: none; flex-direction: column;
            resize: both; overflow: hidden;
            transition: opacity 0.2s, transform 0.2s;
            animation: popIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .window.active { border-color: rgba(255,255,255,0.15); box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .window.minimized { display: none !important; }
        .window.fullscreen { border-radius: 0; border: none; }

        /* Title Bar */
        .title-bar {
            height: 44px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 16px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: grab; font-weight: 600; font-size: 13px;
            color: var(--text-muted);
        }
        .title-bar:active { cursor: grabbing; }
        .title-bar-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Window Controls (Mac-style traffic lights) */
        .title-bar-controls { display: flex; gap: 8px; }
        .title-bar-controls button {
            width: 12px; height: 12px; border-radius: 50%;
            border: none; padding: 0; margin: 0;
            color: transparent; overflow: hidden; cursor: pointer;
            box-shadow: none; transition: transform 0.2s;
        }
        .title-bar-controls button:hover { transform: scale(1.1); opacity: 0.8; }
        .title-bar-controls .close-button { background: #ef4444; }
        .title-bar-controls .minimize-button { background: #eab308; }
        .title-bar-controls .fullscreen-button { background: #22c55e; }

        /* Content Area */
        .window-content {
            padding: 20px; flex-grow: 1; overflow-y: auto;
            background: transparent; color: #e4e4e7;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* --- Form Elements V2 --- */
        input, textarea, select {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white; padding: 10px;
            font-family: var(--font-main); font-size: 13px;
            transition: all 0.2s; width: 100%;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--accent); background: rgba(0,0,0,0.5);
        }
        
        button {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.05);
            color: white; padding: 8px 16px;
            border-radius: 8px; cursor: pointer;
            font-size: 13px; font-weight: 500;
            transition: all 0.2s;
        }
        button:hover { background: rgba(255,255,255,0.15); transform: translateY(-1px); }
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Status Bar */
        .status-bar {
            padding: 8px 16px; font-size: 11px; color: var(--text-muted);
            background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.05);
        }

        /* --- Taskbar (Dock Style) --- */
        .taskbar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: auto; min-width: 400px; max-width: 90vw; height: 60px;
            background: rgba(15, 15, 20, 0.8);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 30px;
            display: flex; align-items: center; padding: 0 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 10000;
        }

        .start-button {
            background: var(--accent); color: white;
            border-radius: 20px; padding: 0 20px; height: 40px;
            border: none; font-weight: bold;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
            margin-right: 15px;
        }

        .taskbar-buttons-container {
            display: flex; gap: 8px; overflow-x: auto; align-items: center;
            padding-right: 15px; border-right: 1px solid rgba(255,255,255,0.1);
            margin-right: 15px;
        }

        .taskbar-button {
            background: rgba(255,255,255,0.05);
            border: none; border-radius: 12px;
            height: 40px; padding: 0 15px;
            max-width: 150px; color: #ddd;
        }
        .taskbar-button:hover { background: rgba(255,255,255,0.15); }
        .taskbar-button.active {
            background: rgba(255,255,255,0.2);
            border-bottom: 3px solid var(--accent);
            border-radius: 12px 12px 4px 4px;
            color: white;
        }

        .clock { font-variant-numeric: tabular-nums; font-size: 14px; color: #fff; margin-left: auto; }

        /* --- Start Menu --- */
        .start-menu {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-180px);
            width: 240px; background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(20px); border: var(--glass-border);
            border-radius: 16px; padding: 8px;
            display: none; flex-direction: column; gap: 4px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 10001;
        }
        .start-menu-item {
            padding: 10px 15px; border-radius: 8px;
            font-size: 13px; color: #eee; cursor: pointer;
            transition: background 0.2s;
        }
        .start-menu-item:hover { background: var(--accent); color: white; }
        .start-menu-separator { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }

        /* --- Context Menu --- */
        .context-menu {
            background: rgba(30, 30, 35, 0.95);
            backdrop-filter: blur(15px); border: var(--glass-border);
            border-radius: 12px; padding: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            min-width: 180px; position: fixed; z-index: 20000;
        }
        .context-menu-item {
            padding: 8px 12px; border-radius: 6px;
            font-size: 13px; color: #eee; cursor: pointer;
        }
        .context-menu-item:hover { background: rgba(255,255,255,0.1); }
        .context-menu-separator { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }

        /* --- App Specific Overrides --- */
        /* Terminal */
        #terminal_content {
            background: rgba(10, 10, 15, 0.95) !important;
            font-family: var(--font-mono); color: #10b981;
            border-radius: 8px;
        }
        .terminal-prompt { color: #a78bfa; }
        
        /* File Explorer */
        #fe_fileListContainer { background: transparent !important; border: none !important; }
        #fe_fileTable { width: 100%; border-collapse: collapse; }
        #fe_fileTable th { text-align: left; padding: 10px; color: var(--text-muted); font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #fe_fileTable td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        #fe_fileList tr:hover { background: rgba(255,255,255,0.05) !important; }
        #fe_fileList tr.selected { background: rgba(139, 92, 246, 0.2) !important; color: white; }
        .fe-item-icon { font-size: 16px; margin-right: 8px; }

        /* Settings Tabs */
        .settings-tabs { display: flex; gap: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; }
        .settings-tab {
            padding: 8px 16px; background: transparent; color: var(--text-muted);
            border: none; border-bottom: 2px solid transparent;
            cursor: pointer; transition: all 0.2s;
        }
        .settings-tab.active { color: white; border-bottom-color: var(--accent); }

        /* Sparky */
        #k8osAssistant_speechBubble {
            background: rgba(255,255,255,0.9);
            color: #000; border: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            border-radius: 16px 16px 16px 2px;
        }
        #k8osAssistant_speechBubble::after { border-top-color: rgba(255,255,255,0.9); }
        #k8osAssistant_inputContainer { background: rgba(30,30,35,0.95); border: var(--glass-border); border-radius: 12px; }

        /* Browser & Games */
        .webBrowserWindow_iframeContent, #gamePlayerWindow_iframe { background: white; border-radius: 0 0 8px 8px; }
        .webBrowserWindow_navControls { background: transparent; border-bottom: 1px solid rgba(255,255,255,0.1); gap: 5px; padding: 10px; }

        /* Calendar */
        .calendar-popup {
            bottom: 90px !important; right: 20px !important;
            background: rgba(20,20,25,0.9); backdrop-filter: blur(20px);
            border: var(--glass-border); border-radius: 16px;
            color: white; padding: 15px;
        }
        .calendar-grid td:hover { background: var(--accent); border-radius: 50%; }
        .calendar-grid .today { color: var(--accent); font-weight: bold; border: 1px solid var(--accent); border-radius: 50%; }

        /* Utils */
        .hidden { display: none !important; }
        code, pre { font-family: var(--font-mono); font-size: 12px; }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .taskbar { width: 100%; max-width: 100%; bottom: 0; border-radius: 0; border-bottom: none; border-left: none; border-right: none; }
            .start-menu { transform: translateX(-50%); width: 90%; bottom: 70px; }
            .window { width: 100% !important; height: calc(100% - 60px) !important; top: 0 !important; left: 0 !important; border-radius: 0; }
        }
    </style>
</head>
<body>

    <!-- Desktop Area -->
    <div class="desktop" id="desktop">
        <!-- Static App Icons -->
        <div class="desktop-icon" data-item-type="app" data-app-id="apiKeySettingsWindow"><div class="icon-placeholder">üîë</div><span>API Key</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="fileExplorerWindow" data-vfs-path-id="root"><div class="icon-placeholder">üìÅ</div><span>Files</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="webBrowserLauncher"><div class="icon-placeholder">üåê</div><span>Browser</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="vibeCreatorWindow"><div class="icon-placeholder">‚ú®</div><span>Vibe Creator</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="gifCreatorWindow"><div class="icon-placeholder">üéûÔ∏è</div><span>GIF Creator</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="gameGeneratorWindow"><div class="icon-placeholder">üïπÔ∏è</div><span>Game Gen</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="musicStudioWindow"><div class="icon-placeholder">üé∂</div><span>Music Studio</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="textEditorWindow"><div class="icon-placeholder">üóíÔ∏è</div><span>Editor</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="systemSettingsWindow"><div class="icon-placeholder">‚öôÔ∏è</div><span>Settings</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="terminalWindow"><div class="icon-placeholder">üí≤</div><span>Terminal</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="imageToCodeWindow"><div class="icon-placeholder">üñºÔ∏è</div><span>Pic to Code</span></div>
        <div class="desktop-icon" data-item-type="app" data-app-id="trashBin"><div class="icon-placeholder">üóëÔ∏è</div><span>Trash</span></div>
        <!-- Dynamic VFS Icons inserted by JS here -->
    </div>

    <!-- Taskbar / Dock -->
    <div class="taskbar">
        <button class="start-button" id="startButton">k8OS</button>
        <div id="taskbarButtonsContainer" class="taskbar-buttons-container">
            <!-- Taskbar Items -->
        </div>
        <div class="clock" id="taskbarClock">12:00 PM</div>
    </div>

    <!-- Start Menu -->
    <div class="start-menu" id="startMenu">
        <div class="start-menu-item" id="startMenuUpdate">Check for Updates</div>
        <div class="start-menu-separator"></div>
        <div class="start-menu-item" id="startMenuReboot">Reboot System</div>
        <div class="start-menu-item" id="startMenuShutdown">Shutdown</div>
        <div class="start-menu-separator"></div>
        <div class="start-menu-item" id="startMenuFactoryReset" style="color: #ff5f56;">Factory Reset</div>
    </div>

    <!-- Calendar Popup -->
    <div id="calendarPopup" class="calendar-popup" style="display: none;">
        <div class="calendar-header" style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <button id="calendarPrevMonth" class="calendar-nav-btn">&lt;</button>
            <span id="calendarMonthYear"></span>
            <button id="calendarNextMonth" class="calendar-nav-btn">&gt;</button>
        </div>
        <table class="calendar-grid" style="width:100%; text-align:center;">
            <thead><tr><th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr></thead>
            <tbody id="calendarDays"></tbody>
        </table>
    </div>

    <!-- Overlay: Reboot -->
    <div class="reboot-overlay" id="rebootOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:99999; align-items:center; justify-content:center; flex-direction:column;">
        <div class="k8os-logo" style="font-size:40px; font-weight:bold; margin-bottom:20px; color:var(--accent);">k8OS</div>
        <p id="rebootProgressText">System halting...</p>
    </div>

    <!-- Context Menus -->
    <div id="desktopContextMenu" class="context-menu" style="display: none;"></div>
    <div id="taskbarContextMenu" class="context-menu" style="display: none;"></div>

    <!-- APP WINDOWS (Initially Hidden) -->

    <!-- 1. API Key Settings -->
    <div id="apiKeySettingsWindow" class="window" style="width: 400px; height: 380px; top: 50px; left: 50px;">
        <div class="title-bar"><span class="title-bar-text">API Connection</span><div class="title-bar-controls"><button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button></div></div>
        <div class="window-content">
            <div class="api-key-warning" style="font-size: 11px; opacity: 0.7; margin-bottom: 10px;">Your keys are stored locally in your browser.</div>
            <label>Provider:</label>
            <select id="apiProviderSelect">
                <option value="gemini">Google Gemini</option>
                <option value="groq">Groq</option>
                <option value="openai">OpenAI</option>
                <option value="openrouter">OpenRouter</option>
                <option value="xai">XAI</option>
                <option value="deepseek">DeepSeek</option>
                <option value="huggingface">Hugging Face</option>
                <option value="transformersjs">Transformers.js (Local)</option>
                <option value="custom">Custom Endpoint</option>
            </select>
            <label id="apiKeyInputLabel" style="margin-top:10px; display:block;">API Key:</label>
            <input type="password" id="apiKeyInput" placeholder="sk-...">
            <p id="apiKeyInfoText" style="font-size:11px; display:none;"></p>
            <button id="saveApiKeyButton" style="margin-top:15px; background:var(--accent);">Connect</button>
            <div id="apiKeyLinksContainer" style="margin-top:10px; font-size:11px;">
                 <a href="#" id="geminiApiKeyLink" class="get-api-key-link" style="color:var(--accent);">Get Gemini Key</a>
                 <a href="#" id="groqApiKeyLink" class="get-api-key-link" style="display:none;color:var(--accent);">Get Groq Key</a>
                 <!-- Other links managed by JS -->
                 <a href="#" id="customSetupLink" style="display:none;color:var(--accent);">Setup Guide</a>
            </div>
            <div id="apiKeyStatus" class="status-bar">Not Connected</div>
        </div>
    </div>

    <!-- 2. File Explorer -->
    <div id="fileExplorerWindow" class="window" style="width: 500px; height: 400px; top: 80px; left: 100px;">
        <div class="title-bar"><span class="title-bar-text">File Explorer</span><div class="title-bar-controls"><button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button></div></div>
        <div class="window-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <div id="fe_folderNameDisplay" style="font-weight:bold;">/</div>
            </div>
            <input type="text" id="fe_fileSearchInput" placeholder="Search files...">
            <div id="fe_fileListContainer" style="flex-grow:1; overflow-y:auto; margin-top:5px;">
                <table id="fe_fileTable">
                    <thead><tr><th class="fe-sortable-header" data-sort-key="name">Name</th><th class="fe-sortable-header" data-sort-key="type">Type</th><th class="fe-sortable-header" data-sort-key="modified">Date</th></tr></thead>
                    <tbody id="fe_fileList"></tbody>
                </table>
            </div>
            <div id="fe_status" class="status-bar">0 items</div>
        </div>
    </div>

    <!-- 3. Vibe Creator -->
    <div id="vibeCreatorWindow" class="window" style="width: 550px; height: 500px; top: 60px; left: 150px;">
        <div class="title-bar"><span class="title-bar-text">Vibe Creator</span><div class="title-bar-controls"><button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button></div></div>
        <div class="window-content">
            <select id="vibe_creator_type_select">
                <option value="svg">SVG Art</option>
                <option value="p5js">p5.js Sketch</option>
                <option value="threejs">Three.js 3D</option>
                <option value="babylonjs">Babylon.js</option>
            </select>
            <textarea id="vibe_promptInput" rows="3" placeholder="Describe the vibe..."></textarea>
            <button id="vibe_generateButton" style="background:var(--accent);">Generate Vibe</button>
            <div id="vibe_loadingIndicator" style="display:none; font-style:italic; font-size:12px;">Dreaming...</div>
            <div id="vibe_container" style="margin-top:10px; background:white; min-height:200px; border-radius:8px; display:flex; justify-content:center; align-items:center; overflow:hidden;"></div>
            <button id="vibe_downloadButton" style="display:none; margin-top:10px;">Download</button>
            <div id="vibe_errorDisplay" class="status-bar">Ready</div>
        </div>
    </div>

    <!-- 4. GIF Creator -->
    <div id="gifCreatorWindow" class="window" style="width: 500px; height: 550px; top: 70px; left: 200px;">
        <div class="title-bar"><span class="title-bar-text">GIF / SVG Anim</span><div class="title-bar-controls"><button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button></div></div>
        <div class="window-content">
            <textarea id="gifCreator_promptInput" rows="2" placeholder="Describe animation..."></textarea>
            <div style="border:1px dashed rgba(255,255,255,0.2); padding:10px; margin:10px 0; border-radius:8px;">
                <label style="font-size:11px;">Or animate existing SVG code:</label>
                <textarea id="gifCreator_svgInput" rows="3" placeholder="<svg>...</svg>"></textarea>
                <button id="gifCreator_importSvgButton" style="font-size:11px; padding:4px 8px; margin-top:5px;">Import from Vibe</button>
                <textarea id="gifCreator_animationPromptInput" rows="2" placeholder="How to animate it?" style="margin-top:5px;"></textarea>
            </div>
            <button id="gifCreator_generateButton">Generate Animation</button>
            <div id="gifCreator_loadingIndicator" style="display:none;">Animating...</div>
            <div id="gifCreator_previewContainer" style="background:white; min-height:150px; margin-top:10px; border-radius:8px; display:flex; justify-content:center; align-items:center;"></div>
            <button id="gifCreator_downloadButton" style="display:none; margin-top:10px;">Download</button>
            <div id="gifCreator_errorDisplay" class="status-bar">Ready</div>
        </div>
    </div>

    <!-- 5. Game Generator -->
    <div id="gameGeneratorWindow" class="window" style="width: 700px; height: 650px; top: 50px; left: 100px;">
        <div class="title-bar"><span class="title-bar-text">Game Generator</span><div class="title-bar-controls"><button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button></div></div>
        <div class="window-content">
            <textarea id="gameGen_prompt" rows="2" placeholder="Describe your game idea..."></textarea>
            <button id="gameGen_generateButton" style="background:var(--accent);">Create Game</button>
            <div id="gameGen_loadingMessage" style="display:none; color:#fbbf24;">AI is building...</div>
            <div id="gameGen_errorMessage" style="display:none; color:#ef4444; background:rgba(255,0,0,0.1); padding:5px;"></div>
            
            <div style="display:flex; gap:10px; height:100%; min-height:0; margin-top:10px;">
                <div style="flex:1; display:flex; flex-direction:column;">
                    <label style="font-size:11px;">Plan:</label>
                    <div id="gameGen_planDisplay" style="flex:1; background:rgba(0,0,0,0.3); font-family:var(--font-mono); font-size:11px; padding:5px; overflow:auto;"></div>
                </div>
                <div style="flex:1; display:flex; flex-direction:column;">
                    <label style="font-size:11px;">Code:</label>
                    <textarea id="gameGen_generatedCode" style="flex:1; font-family:var(--font-mono); font-size:11px;" readonly></textarea>
                </div>
            </div>
            <div id="gameGen_assetStatus" style="font-size:11px; color:var(--text-muted);"></div>
            <button id="gameGen_downloadZipButton" style="display:none; margin-top:5px;">Download ZIP</button>
            
            <div id="gameGen_debugSection" style="display:none; margin-top:10px; border-top:1px solid rgba(255,255,255,0.1); padding-top:5px;">
                <label style="font-size:11px;">Debug Hints:</label>
                <textarea id="gameGen_debugCombinedInput" rows="2" placeholder="Paste errors here..."></textarea>
                <button id="gameGen_debugAttemptButton">Fix with AI</button>
            </div>
            <div id="gameGen_apiErrorDisplay" class="status-bar">Ready</div>
        </div>
    </div>

    <!-- 6. Music Studio -->
    <div id="musicStudioWindow" class="window" style="width: 500px; height: 500px; top: 100px; left: 250px;">
        <div class="title-bar"><span class="title-bar-text">Music Studio</span><div class="title-bar-controls"><button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button></div></div>
        <div class="window-content">
            <textarea id="musicStudio_promptInput" rows="3" placeholder="Describe the sound/music (Web Audio API)..."></textarea>
            <button id="musicStudio_generateButton">Compose</button>
            <div id="musicStudio_loadingIndicator" style="display:none;">Composing...</div>
            <textarea id="musicStudio_generatedCode" rows="10" style="font-family:var(--font-mono); font-size:11px; margin-top:10px;" readonly></textarea>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <button id="musicStudio_playButton" disabled>‚ñ∂ Play</button>
                <button id="musicStudio_stopButton" disabled>‚èπ Stop</button>
                <button id="musicStudio_downloadJsButton" style="display:none;">Save JS</button>
            </div>
            <div id="musicStudio_errorDisplay" class="status-bar">Ready</div>
        </div>
    </div>

    <!-- 7. Text Editor -->
    <div id="textEditorWindow" class="window" style="width: 600px; height: 450px; top: 90px; left: 90px;">
        <div class="title-bar"><span class="title-bar-text">Text Editor</span><div class="title-bar-controls"><button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button></div></div>
        <div class="window-content">
            <div style="display:flex; align-items:center; margin-bottom:5px;">
                <button id="textEditor_saveButton">Save</button>
                <button id="textEditor_sparkyAssistButton" style="margin-left:5px;">‚ú® Assist</button>
                <span id="textEditor_currentFileName" style="margin-left:10px; font-size:12px; opacity:0.7;">Untitled</span>
            </div>
            <textarea id="textEditor_contentArea" style="flex-grow:1; font-family:var(--font-mono); font-size:13px;" placeholder="Type here..."></textarea>
            <div id="textEditor_status" class="status-bar">Idle</div>
        </div>
    </div>

    <!-- 8. Terminal -->
    <div id="terminalWindow" class="window" style="width: 600px; height: 400px; top: 120px; left: 120px;">
        <div class="title-bar"><span class="title-bar-text">Terminal</span><div class="title-bar-controls"><button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button></div></div>
        <div class="window-content" id="terminal_content" style="padding:10px;">
            <div id="terminal_output" style="white-space:pre-wrap; word-break:break-all;">k8OS v2.0 [System Online]</div>
            <div class="terminal-input-line" style="display:flex;">
                <span class="terminal-prompt">$</span>
                <input type="text" id="terminal_input" style="background:transparent; border:none; color:inherit; padding:0; margin:0; flex-grow:1; font-family:inherit;" autocomplete="off" spellcheck="false">
            </div>
        </div>
    </div>

    <!-- 9. Settings -->
    <div id="systemSettingsWindow" class="window" style="width: 500px; height: 600px; top: 60px; left: 200px;">
        <div class="title-bar"><span class="title-bar-text">Settings</span><div class="title-bar-controls"><button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button></div></div>
        <div class="window-content">
            <div class="settings-tabs">
                <div class="settings-tab active" data-tab="appearance">Appearance</div>
                <div class="settings-tab" data-tab="aiConfig">AI Config</div>
                <div class="settings-tab" data-tab="about">About</div>
            </div>
            
            <div id="settingsContent_appearance" class="settings-tab-content active">
                <h3>Desktop</h3>
                <label>Background Color</label>
                <input type="color" id="systemSettings_appearance_bgColorPicker" style="height:40px;">
                <div id="systemSettings_appearance_colorOptions" style="display:flex; gap:5px; margin-top:5px;"></div>
                <button id="systemSettings_appearance_resetButton" style="margin-top:5px;">Reset Color</button>
                
                <h3 style="margin-top:20px;">Wallpaper Image</h3>
                <input type="text" id="systemSettings_appearance_bgImageUrlInput" placeholder="Image URL...">
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <select id="systemSettings_appearance_bgSizeSelect"><option value="cover">Cover</option><option value="contain">Contain</option></select>
                    <select id="systemSettings_appearance_bgRepeatSelect"><option value="no-repeat">No Repeat</option><option value="repeat">Repeat</option></select>
                </div>
                <div style="margin-top:5px;">
                    <button id="systemSettings_appearance_applyBgImageButton">Apply</button>
                    <button id="systemSettings_appearance_clearBgImageButton">Clear</button>
                </div>

                <h3 style="margin-top:20px;">Icons</h3>
                <input type="range" id="systemSettings_iconSizeSlider" min="0.5" max="1.5" step="0.1">
                <span id="systemSettings_iconSizeSliderValue">1.0x</span>
                <button id="systemSettings_iconSizeResetButton">Reset</button>
                
                <div id="secretThemeSection" style="display:none; margin-top:20px;">
                    <label>Theme</label>
                    <select id="themeSelect"><option value="v2">Glass V2</option><option value="aqua">Aqua</option></select>
                </div>
            </div>

            <div id="settingsContent_aiConfig" class="settings-tab-content" style="display:none;">
                <p style="font-size:11px; opacity:0.7;">Fine-tune AI settings for specific providers.</p>
                
                <!-- Settings sections for each provider (hidden by JS based on selection) -->
                <div id="geminiModelSettings">
                    <label>Gemini Model:</label><input type="text" id="systemSettings_ai_modelNameInput">
                    <button id="systemSettings_ai_saveModelButton">Save</button>
                </div>
                <div id="groqModelSettings" style="display:none;">
                    <label>Groq Model:</label><input type="text" id="systemSettings_ai_groqModelInput">
                    <button id="systemSettings_ai_saveGroqModelButton">Save</button>
                    <label>Max Tokens:</label><input type="number" id="systemSettings_ai_groqMaxTokensInput">
                    <button id="systemSettings_ai_saveGroqMaxTokensButton">Save</button>
                </div>
                <!-- ... (Other provider settings blocks preserved structurally from original code, heavily abbreviated for readability but IDs remain) ... -->
                <div id="openaiModelSettings" style="display:none;"><input id="systemSettings_ai_openaiModelInput"><button id="systemSettings_ai_saveOpenaiModelButton">Save</button></div>
                <div id="openrouterModelSettings" style="display:none;"><input id="systemSettings_ai_openrouterModelInput"><button id="systemSettings_ai_saveOpenrouterModelButton">Save</button><input id="systemSettings_ai_openrouterHttpRefererInput"><button id="systemSettings_ai_saveOpenrouterHttpRefererButton">Save</button></div>
                <div id="xaiModelSettings" style="display:none;"><input id="systemSettings_ai_xaiModelInput"><button id="systemSettings_ai_saveXaiModelButton">Save</button></div>
                <div id="deepseekModelSettings" style="display:none;"><input id="systemSettings_ai_deepseekModelInput"><button id="systemSettings_ai_saveDeepseekModelButton">Save</button><input id="systemSettings_ai_deepseekMaxTokensInput"><button id="systemSettings_ai_saveDeepseekMaxTokensButton">Save</button></div>
                <div id="hfModelSettings" style="display:none;"><input id="systemSettings_ai_hfModelIdInput"><button id="systemSettings_ai_saveHfModelButton">Save</button></div>
                <div id="transformersjsModelSettings" style="display:none;">
                    <input id="systemSettings_ai_transformersjsModelIdInput">
                    <button id="systemSettings_ai_saveTransformersjsModelButton">Load Model</button>
                    <div id="systemSettings_transformersJsVersion"></div>
                    <div id="systemSettings_transformersjs_status"></div>
                </div>
                <div id="customProviderSettings" style="display:none;">
                    <input id="systemSettings_ai_customEndpointUrlInput"><input id="systemSettings_ai_customModelIdInput">
                    <button id="systemSettings_ai_saveCustomSettingsButton">Save</button>
                </div>

                <h3>System Instructions</h3>
                <label>Vibe Prompt:</label><textarea id="systemSettings_ai_vibeInstruction"></textarea><button id="systemSettings_ai_saveVibeInstructionButton">Save</button>
                <label>Game Gen Prompt:</label><textarea id="systemSettings_ai_gameGenFinalInstruction"></textarea><button id="systemSettings_ai_saveGameGenFinalInstructionButton">Save</button>
                <label>Music Prompt:</label><textarea id="systemSettings_ai_musicStudioInstruction"></textarea><button id="systemSettings_ai_saveMusicStudioInstructionButton">Save</button>
                <label>GIF (New):</label><textarea id="systemSettings_ai_gifCreatorNewInstruction"></textarea><button id="systemSettings_ai_saveGifCreatorNewInstructionButton">Save</button>
                <label>GIF (Animate):</label><textarea id="systemSettings_ai_gifCreatorAnimateInstruction"></textarea><button id="systemSettings_ai_saveGifCreatorAnimateInstructionButton">Save</button>
            </div>

            <div id="settingsContent_about" class="settings-tab-content" style="display:none;">
                <h3>k8OS v2</h3>
                <p id="systemSettings_about_version">Version: 0.1.15 (V2 Glass)</p>
                <p>Created by k8o5</p>
                <p>A web-based OS environment powered by AI.</p>
            </div>
            <div id="systemSettings_status" class="status-bar">Ready</div>
        </div>
    </div>

    <!-- 10. Pic to Code -->
    <div id="imageToCodeWindow" class="window" style="width: 500px; height: 600px; top: 80px; left: 220px;">
        <div class="title-bar"><span class="title-bar-text">Pic to Code</span><div class="title-bar-controls"><button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button></div></div>
        <div class="window-content">
            <div id="imageToCode_pasteZone" style="border:2px dashed rgba(255,255,255,0.2); height:150px; display:flex; justify-content:center; align-items:center; border-radius:8px; margin-bottom:10px;">
                <span id="imageToCode_pasteInstructions">Click here & Paste Image (Ctrl+V)</span>
                <img id="imageToCode_preview" style="max-height:100%; display:none;">
            </div>
            <input type="text" id="imageToCode_prompt" placeholder="Additional instructions (optional)...">
            <button id="imageToCode_generateButton" style="margin-top:5px; background:var(--accent);">Generate Code</button>
            <textarea id="imageToCode_generatedCode" style="flex-grow:1; font-family:var(--font-mono); font-size:11px; margin-top:10px;" readonly></textarea>
            <div id="imageToCode_status" class="status-bar">Waiting for image...</div>
        </div>
    </div>

    <!-- 11. Sparky Assistant -->
    <div id="k8osAssistant" style="display:none; position:absolute; z-index:20000;">
        <div id="k8osAssistant_inputContainer" style="display:none; flex-direction:column; padding:10px; margin-bottom:10px;">
            <div id="sparky_imagePreviewContainer" style="display:none; margin-bottom:5px;"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="k8osAssistant_commandInput" placeholder="Ask Sparky...">
                <button id="sparky_attachFileButton" class="sparky-attach-file-button">üìé</button>
                <input type="file" id="sparky_fileInput" style="display:none;">
                <button id="k8osAssistant_sendCommandButton">Go</button>
            </div>
        </div>
        
        <div id="k8osAssistant_speechBubble" style="padding:10px; margin-bottom:10px; max-width:200px; font-size:13px; opacity:0; transition:opacity 0.3s;">
            <span id="k8osAssistant_speechText"></span>
        </div>
        
        <div id="k8osAssistant_avatarContainer" style="width:64px; height:64px; cursor:pointer;">
            <!-- Sparky SVG Avatar -->
            <svg id="assistantAvatarSVG" viewBox="0 0 100 100">
                <defs>
                    <radialGradient id="sparkyBodyGradient"><stop offset="0%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#7c3aed"/></radialGradient>
                    <filter id="sparkyGlow"><feGaussianBlur stdDeviation="2.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                </defs>
                <g id="sparkyBobbingGroup">
                    <circle cx="50" cy="50" r="30" fill="url(#sparkyBodyGradient)" filter="url(#sparkyGlow)"/>
                    <ellipse cx="50" cy="45" rx="12" ry="8" fill="white"/>
                    <circle id="sparkyPupil" cx="50" cy="45" r="4" fill="#222"/>
                    <path id="sparkyMouth" d="M 42 58 Q 50 63 58 58" stroke="#333" stroke-width="2" fill="none" stroke-linecap="round"/>
                </g>
            </svg>
        </div>
    </div>

    <!-- 12. Game Player IFrame Window -->
    <div id="gamePlayerWindow" class="window" style="width:800px; height:600px; top:50px; left:50px;">
        <div class="title-bar">
            <span class="title-bar-text" id="gamePlayerWindow_title">Game Player</span>
            <div class="title-bar-controls">
                <button id="gamePlayer_refreshButton" style="background:blue;"></button>
                <button class="minimize-button"></button><button class="fullscreen-button"></button><button class="close-button"></button>
            </div>
        </div>
        <div class="window-content" style="padding:0;">
            <iframe id="gamePlayerWindow_iframe" style="width:100%; height:100%; border:none;"></iframe>
        </div>
    </div>

    <!-- 13. Setup Guide Modal -->
    <div id="setupGuideModal" class="window" style="width:600px; height:500px; top:20%; left:20%; z-index:30000;">
        <div class="title-bar"><span id="setupGuideModalTitle" class="title-bar-text">Guide</span><div class="title-bar-controls"><button id="setupGuideModalCloseButton" class="close-button"></button></div></div>
        <div class="window-content">
            <div id="setupGuideModalInstructions" style="overflow-y:auto; max-height:150px; margin-bottom:10px;"></div>
            <textarea id="setupGuideModalCode" readonly style="flex-grow:1; font-family:var(--font-mono); font-size:11px;"></textarea>
            <button id="setupGuideModalCopyButton" style="margin-top:10px;">Copy Code</button>
            <div id="setupGuideModalStatus" class="status-bar">Ready</div>
        </div>
    </div>

    <!-- 14. Text Editor Assist Modal -->
    <div id="textEditorAssistModal" class="window" style="width:550px; height:500px; top:15%; left:30%; z-index:30001;">
        <div class="title-bar"><span class="title-bar-text">AI Assist</span><div class="title-bar-controls"><button id="textEditorAssist_closeButton" class="close-button"></button></div></div>
        <div class="window-content">
            <div id="textEditorAssist_inputSection">
                <div id="sparkyAssist_imagePreviewContainer" style="display:none;"></div>
                <div style="display:flex; gap:5px;">
                    <textarea id="textEditorAssist_userInput" rows="2" placeholder="How should I change the code?"></textarea>
                    <div style="display:flex; flex-direction:column; gap:2px;">
                         <button id="sparkyAssist_attachFileButton" class="sparky-attach-file-button">üìé</button>
                         <input type="file" id="sparkyAssist_fileInput" style="display:none;">
                    </div>
                </div>
            </div>
            <div id="textEditorAssist_diffContainer" style="flex-grow:1; background:white; color:black; font-family:var(--font-mono); padding:5px; overflow:auto; margin:10px 0;"></div>
            <div style="display:flex; justify-content:flex-end; gap:5px;">
                <button id="textEditorAssist_getSuggestionsButton">Get Suggestions</button>
                <button id="textEditorAssist_rejectButton" style="display:none;">Reject</button>
                <button id="textEditorAssist_acceptButton" style="display:none; background:var(--accent);">Accept</button>
            </div>
            <div id="textEditorAssist_status" class="status-bar">Waiting</div>
        </div>
    </div>

    <!-- CORE LOGIC (Unchanged) -->
<script type="module">
    import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "@google/generative-ai";
    import { marked, Renderer as MarkedRenderer } from 'marked';
    import { pipeline as transformersPipeline, env as transformersEnv } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.5.1';

    // Apply saved theme on load
    (function() {
        const savedTheme = localStorage.getItem('k8os_theme');
        if (savedTheme === 'aqua') {
            document.body.classList.add('aqua-theme');
        }
    })();

    // Transformers.js specific setup
    transformersEnv.allowLocalModels = false; // Only fetch from HF Hub
    transformersEnv.useBrowserCache = true;   // Cache models in browser

    const K8OS_VERSION = "0.1.15"; // Version bump for OpenRouter and GameGen overhaul
    const DEFAULT_GEMINI_AI_MODEL = "gemini-1.5-flash";
    const DEFAULT_GROQ_AI_MODEL = "llama3-8b-8192";
    const DEFAULT_OPENAI_MODEL = "gpt-4-turbo";
    const DEFAULT_OPENROUTER_AI_MODEL = "google/gemini-flash-1.5";
    const DEFAULT_XAI_MODEL = "grok-4";
    const DEFAULT_DEEPSEEK_CHAT_MODEL = "deepseek-chat";
    const DEFAULT_DEEPSEEK_CODER_MODEL = "deepseek-coder";
    const DEFAULT_HF_MODEL_ID = "mistralai/Mistral-7B-Instruct-v0.1";
    const DEFAULT_TRANSFORMERSJS_MODEL_ID = "Xenova/distilgpt2";
    const TRANSFORMERS_JS_VERSION = "3.5.1";

    const DEFAULT_GROQ_MAX_TOKENS = 8192;
    const DEFAULT_DEEPSEEK_MAX_TOKENS = 8192;
    const DEFAULT_HF_MAX_NEW_TOKENS = 4096;
    const DEFAULT_TRANSFORMERSJS_MAX_NEW_TOKENS = 1024;
    const DEFAULT_CUSTOM_MAX_TOKENS = 8192; 


    const DEFAULT_VIBE_SVG_INSTRUCTION = `Generate ONLY raw SVG code for: "{USER_PROMPT}". The SVG should be simple, iconic, and scalable. Start with "<svg" and end with "</svg>". Include 'viewBox'. No explanations, comments, or markdown.`;
    const DEFAULT_VIBE_P5JS_INSTRUCTION = `Generate a complete, self-contained HTML page with p5.js code to create a visual based on: "{USER_PROMPT}". The HTML must include the p5.js library from a CDN. The p5.js sketch should be contained within a <script> tag. The canvas should be dynamically sized to fit its container. Output ONLY the raw HTML code.`;
    const DEFAULT_VIBE_THREEJS_INSTRUCTION = `Generate a complete, self-contained HTML page with Three.js code to create a 3D scene based on: "{USER_PROMPT}". The HTML must include the Three.js library from a CDN. The Three.js code should be contained within a <script type="module"> tag. The renderer should be dynamically sized to fit its container, and there should be a basic animation loop. Output ONLY the raw HTML code.`;
    const DEFAULT_VIBE_BABYLONJS_INSTRUCTION = `Generate a complete, self-contained HTML page with Babylon.js code to create a 3D scene based on: "{USER_PROMPT}". The HTML must include the Babylon.js library from a CDN. The Babylon.js code should be contained within a <script> tag. The engine and scene should be set up to render on a canvas that dynamically sizes to fit its container. Output ONLY the raw HTML code.`;
    const DEFAULT_GAMEGEN_PLAN_INSTRUCTION = `Based on the user's game idea: "{USER_GAME_IDEA}", create a concise game plan. The plan must include: 1. A brief (1-2 sentences) description of the core game mechanic. 2. A list of 3 to 5 essential SVG assets. For each, provide a short, clear description, a boolean "animated" flag, and a unique, URL-safe "filename" ending in .svg. 3. A list of 2 to 3 essential sound effects. For each, provide a short, clear description and a unique, URL-safe "filename" ending in .js. Format the output as a JSON object with three keys: "game_mechanic" (string), "svg_assets" (array of objects), and "sound_effects" (array of objects). Example JSON: { "game_mechanic": "Top-down shooter...", "svg_assets": [{"description": "player ship, blue", "animated": false, "filename": "player.svg"}, {"description": "enemy UFO, rotates slowly", "animated": true, "filename": "enemy.svg"}], "sound_effects": [{"description": "laser shoot sound", "filename": "shoot.js"}, {"description": "explosion fx", "filename": "explosion.js"}] }. Output ONLY the JSON object.`;
    const DEFAULT_GAMEGEN_FINAL_INSTRUCTION = `Generate a COMPLETE, SINGLE-FILE, RUNNABLE HTML/JavaScript game. User's idea: "{USER_GAME_IDEA}". Game Plan: {GAME_PLAN_JSON}. All assets will be provided in a relative './assets/' directory. You MUST load them from there. The asset filenames are: {ASSET_FILENAMES_JSON}. IMPORTANT: For SVGs, use an asynchronous loading mechanism. 1. Create Image objects for each SVG asset using its path (e.g., 'assets/player.svg'). 2. Use onload/onerror handlers. 3. Only start the game loop AFTER all images are loaded. 4. For sound effects, the assets are JavaScript files. You must fetch each JS file (e.g., fetch('assets/shoot.js')), get its text content, and then use 'new Function('audioContext', 'activeSources', THE_FETCHED_CODE)' to create the playable sound function. Manage loading these sound functions asynchronously as well. The game should not start until all assets (SVGs and sounds) are loaded. Output ONLY the single HTML file string. Use pure JS/Canvas or CDN libraries. Include game loop, rendering, input. Self-contained. No markdown/explanations outside HTML. Make game playable, fit description/plan, using all provided assets and triggering sound effects.`;
    const DEFAULT_GAMEGEN_DEBUG_INSTRUCTION = `The HTML/JS game code (original idea: "{USER_GAME_IDEA}") produced error(s) and/or the user has provided hints: "{ERRORS_AND_HINTS}". Analyze the code, errors, and hints. Provide a corrected version of the full HTML/JS game code. Focus on fixing specified issues while preserving the game's original intent. Pay close attention to asynchronous asset loading from the './assets/' folder. Output ONLY the corrected, complete HTML/JS code, starting with <!DOCTYPE html> or <html> and ending with </html>. No explanations or markdown. Problematic code:\n\`\`\`html\n{PROBLEM_CODE}\n\`\`\``;
    const DEFAULT_MUSICSTUDIO_INSTRUCTION = `Generate JavaScript code using the Web Audio API to create music based on the description: "{USER_PROMPT}". The code should be a self-contained function body. It will be executed within a function that receives 'audioContext' and 'activeSources' (an array to push created source nodes to for later stopping) as arguments, like so: new Function('audioContext', 'activeSources', YOUR_CODE_HERE)(audioContextInstance, activeSourcesArray); Your code should use the provided 'audioContext'. It should create and start all necessary audio nodes and push main/looping source nodes to the 'activeSources' array if they are intended to be stopped later. If the description implies a loop or continuous music, structure your code to create and start the loop. If it's a one-shot piece, it should play through once. Generate ONLY the JavaScript function body. No explanations or markdown.`;
    const DEFAULT_GIFCREATOR_ANIMATED_SVG_INSTRUCTION = `Generate ONLY raw SVG code for an animated image based on: "{USER_PROMPT}". The SVG MUST include SMIL animation (<animate>, <animateTransform>, <animateMotion>, etc.) to create a looping, GIF-like effect. Ensure the animation is self-contained within the SVG. Start with "<svg" and end with "</svg>". Include 'viewBox'. No explanations, comments, or markdown outside the SVG code itself.`;
    const DEFAULT_GIFCREATOR_ANIMATE_EXISTING_SVG_INSTRUCTION = `Take the following static SVG code:\n\`\`\`svg\n{STATIC_SVG_CODE}\n\`\`\`\nNow, add SMIL animation elements to this SVG to achieve the following animation described by the user: "{ANIMATION_PROMPT}". Modify the provided SVG code directly. The output should be the complete, modified SVG code with the SMIL animations included. Ensure the animation is looping and self-contained. Start with "<svg" and end with "</svg>". No explanations, comments, or markdown outside the SVG code itself.`;
    const DEFAULT_SPARKY_AD_PROMPT = `You are Sparky, the k8OS assistant. Generate a short, witty, and slightly boastful advertisement about your capabilities or how helpful you are. Make it fun and friendly! Max 2-3 concise sentences. Output ONLY the ad text.`;
    const DEFAULT_SPARKY_HTML_GENERATOR_PROMPT = `You are Sparky, an AI assistant. The user wants to create something described as: "{USER_REQUEST}". Generate a complete, self-contained HTML page that fulfills this request. The HTML should be suitable to be displayed in an iframe. Output ONLY the raw HTML code, starting with <!DOCTYPE html> or <html> and ending with </html>. Do not include any explanations, markdown, or comments outside the HTML itself. If the request is for an interactive element, try to include basic JavaScript within <script> tags in the HTML. Be creative but keep it simple and functional.`;
    const DEFAULT_SPARKY_FILESYSTEM_GENERATOR_PROMPT = `You are Sparky, a k8OS AI assistant. The user wants to create a directory structure with files. User request: "{USER_REQUEST}".
The base location for these creations should be relative to a parent ID: "{BASE_PARENT_ID}". If "{BASE_PARENT_ID}" is "root", then top-level items in the plan should have "parentId": "root". Otherwise, top-level items in the plan should have "parentId": "{BASE_PARENT_ID}".
Analyze the request and generate a JSON array of actions to create the file system.
Each action object in the array should have:
- "action": "create_folder" or "create_file"
- "name": string (name of the file or folder)
- "parentId": string (ID of the parent folder. Use the value provided in "{BASE_PARENT_ID}" for top-level items of this request if "{BASE_PARENT_ID}" is not "root". Use "root" for top-level items if "{BASE_PARENT_ID}" is "root". For nested items, use the "id" you assign to the parent folder in a previous action).
- "id": string (a unique temporary ID for this item, e.g., "item1", "folderA", so it can be referenced as a parentId later by other actions in THIS SAME JSON response).
- "content": string (for "create_file" only, the content of the file. Can be empty string.)
- "mimeType": string (for "create_file" only, e.g., "text/plain", "text/html", "text/css", "application/javascript". Default to "text/plain" if unsure.)

Example (assuming {BASE_PARENT_ID} is "folderXYZ"): User wants "a subfolder 'WebApp' with 'index.html'".
Output JSON:
[
  { "action": "create_folder", "name": "WebApp", "parentId": "folderXYZ", "id": "webappFolder" },
  { "action": "create_file", "name": "index.html", "parentId": "webappFolder", "id": "indexFile", "content": "<h1>Hi</h1>", "mimeType": "text/html" }
]
Output ONLY the JSON array. No explanations, comments, or markdown outside the JSON. Ensure parentId references are correct within the generated sequence of actions, respecting the "{BASE_PARENT_ID}" context for the top-level items of this request.
`;
const DEFAULT_SPARKY_MULTIMODAL_PROMPT = `Analyze the user's prompt "{USER_PROMPT}" and the provided image. Generate a single, complete, runnable HTML file that combines the user's idea and the image's content. Your response must be ONLY the raw HTML code. Do not include any markdown, explanations, or comments. Start with <!DOCTYPE html> or <html>.`;
const DEFAULT_PHOTO_AI_EDIT_PROMPT = `You are an expert photo editing AI named Sparky. The user has provided an image and a text prompt. Your task is to edit the image based on the user's request and return ONLY the data URL of the edited image (e.g., "data:image/png;base64,iVBORw..."). Do not add any explanation, markdown, or other text. The user's prompt is: "{USER_PROMPT}"`;

const DEFAULT_SPARKY_ASSIST_MULTIMODAL_PROMPT = `You are an expert AI programmer. Rewrite the code based on the user's instruction and the provided image.
IMPORTANT: Respond ONLY with the complete, raw, rewritten code block. Do not add explanations, comments, or markdown formatting.

User's instruction: "{USER_INSTRUCTION}"
Image is provided as reference for the desired outcome.

Code to rewrite:
\`\`\`
{CODE_TO_REWRITE}
\`\`\`

Rewritten code:`;

    const wittyComments = {
        create_game: [
            "Poof! One game, coming right up. Try not to get addicted!",
            "My circuits are sizzling with game-making genius. Enjoy!",
            "Beep boop... game complete. Let me know if you win!",
            "There. I'm pretty sure this one's a future award-winner.",
        ],
        create_html: [
            "I've woven the very fabric of the web for you. Behold, HTML!",
            "Just whipped up a little something. Hope you like the pixels.",
            "There, a new webpage is born. I should get a stork costume.",
            "Another masterpiece for the internet's grand museum.",
        ],
        create_files: [
            "Files and folders, organized neatly. I'm basically a digital librarian.",
            "Consider your file system... structurated. You're welcome.",
            "Done! That was more fun than defragmenting my hard drive.",
            "I've tidied up your digital workspace. It's what I do.",
        ]
    };

    function getWittyComment(actionType) {
        const comments = wittyComments[actionType];
        if (!comments || comments.length === 0) {
            return "Just like that, it's done!"; // Fallback comment
        }
        return comments[Math.floor(Math.random() * comments.length)];
    }


    const apiProviderSelect = document.getElementById('apiProviderSelect');
    const apiKeyInputLabel = document.getElementById('apiKeyInputLabel');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const apiKeyInfoText = document.getElementById('apiKeyInfoText');
    const saveApiKeyButton = document.getElementById('saveApiKeyButton');
    const apiKeyStatus = document.getElementById('apiKeyStatus');
    const apiKeyLinksContainer = document.getElementById('apiKeyLinksContainer');
    const geminiApiKeyLink = document.getElementById('geminiApiKeyLink');
    const groqApiKeyLink = document.getElementById('groqApiKeyLink');
    const openaiApiKeyLink = document.getElementById('openaiApiKeyLink');
    const openrouterApiKeyLink = document.getElementById('openrouterApiKeyLink');
    const xaiApiKeyLink = document.getElementById('xaiApiKeyLink');
    const deepseekApiKeyLink = document.getElementById('deepseekApiKeyLink');
    const hfApiKeyLink = document.getElementById('hfApiKeyLink');
    const customSetupLink = document.getElementById('customSetupLink');


    const taskbarClock = document.getElementById('taskbarClock');
    const taskbarButtonsContainer = document.getElementById('taskbarButtonsContainer');
    const vibe_promptInput = document.getElementById('vibe_promptInput');
    const vibe_generateButton = document.getElementById('vibe_generateButton');
    const vibe_container = document.getElementById('vibe_container');
    const vibe_downloadButton = document.getElementById('vibe_downloadButton');
    const vibe_loadingIndicator = document.getElementById('vibe_loadingIndicator');
    const vibe_errorDisplay = document.getElementById('vibe_errorDisplay');
    const vibe_creator_type_select = document.getElementById('vibe_creator_type_select');
    const gifCreator_promptInput = document.getElementById('gifCreator_promptInput');
    const gifCreator_svgInput = document.getElementById('gifCreator_svgInput');
    const gifCreator_importSvgButton = document.getElementById('gifCreator_importSvgButton');
    const gifCreator_animationPromptInput = document.getElementById('gifCreator_animationPromptInput');
    const gifCreator_generateButton = document.getElementById('gifCreator_generateButton');
    const gifCreator_downloadButton = document.getElementById('gifCreator_downloadButton');
    const gifCreator_loadingIndicator = document.getElementById('gifCreator_loadingIndicator');
    const gifCreator_previewContainer = document.getElementById('gifCreator_previewContainer');
    const gifCreator_errorDisplay = document.getElementById('gifCreator_errorDisplay');
    const gameGen_promptInput = document.getElementById('gameGen_prompt');
    const gameGen_generateButton = document.getElementById('gameGen_generateButton');
    const gameGen_downloadZipButton = document.getElementById('gameGen_downloadZipButton');
    const gameGen_generatedCodeTextarea = document.getElementById('gameGen_generatedCode');
    const gameGen_loadingMessage = document.getElementById('gameGen_loadingMessage');
    const gameGen_errorMessage = document.getElementById('gameGen_errorMessage');
    const gameGen_apiErrorDisplay = document.getElementById('gameGen_apiErrorDisplay');
    const gameGen_planDisplay = document.getElementById('gameGen_planDisplay');
    const gameGen_assetStatus = document.getElementById('gameGen_assetStatus');
    const gameGen_debugSection = document.getElementById('gameGen_debugSection');
    const gameGen_debugCombinedInput = document.getElementById('gameGen_debugCombinedInput');
    const gameGen_debugAttemptButton = document.getElementById('gameGen_debugAttemptButton');
    const gamePlayerWindow_iframe = document.getElementById('gamePlayerWindow_iframe');
    const gamePlayer_refreshButton = document.getElementById('gamePlayer_refreshButton');
    const musicStudio_promptInput = document.getElementById('musicStudio_promptInput');
    const musicStudio_generateButton = document.getElementById('musicStudio_generateButton');
    const musicStudio_loadingIndicator = document.getElementById('musicStudio_loadingIndicator');
    const musicStudio_generatedCode = document.getElementById('musicStudio_generatedCode');
    const musicStudio_playButton = document.getElementById('musicStudio_playButton');
    const musicStudio_stopButton = document.getElementById('musicStudio_stopButton');
    const musicStudio_downloadJsButton = document.getElementById('musicStudio_downloadJsButton');
    const musicStudio_errorDisplay = document.getElementById('musicStudio_errorDisplay');
    const fe_fileListElement = document.getElementById('fe_fileList');
    const fe_statusElement = document.getElementById('fe_status');
    const fe_folderNameDisplayElement = document.getElementById('fe_folderNameDisplay');
    const fe_searchInput = document.getElementById('fe_fileSearchInput');
    const textEditor_saveButton = document.getElementById('textEditor_saveButton');
    const textEditor_sparkyAssistButton = document.getElementById('textEditor_sparkyAssistButton');
    const textEditor_contentArea = document.getElementById('textEditor_contentArea');
    const textEditor_status = document.getElementById('textEditor_status');
    const textEditor_currentFileName = document.getElementById('textEditor_currentFileName');
    let currentTextEditorFileId = null;


    const imageToCode_pasteZone = document.getElementById('imageToCode_pasteZone');
    const imageToCode_preview = document.getElementById('imageToCode_preview');
    const imageToCode_pasteInstructions = document.getElementById('imageToCode_pasteInstructions');
    const imageToCode_prompt = document.getElementById('imageToCode_prompt');
    const imageToCode_generateButton = document.getElementById('imageToCode_generateButton');
    const imageToCode_generatedCode = document.getElementById('imageToCode_generatedCode');
    const imageToCode_status = document.getElementById('imageToCode_status');
    let imageToCode_lastPastedFile = null;

    const desktopElement = document.getElementById('desktop');
    const desktopContextMenu = document.getElementById('desktopContextMenu');
    const taskbarContextMenu = document.getElementById('taskbarContextMenu');
    const startButton = document.getElementById('startButton');
    const startMenu = document.getElementById('startMenu');
    const startMenuUpdate = document.getElementById('startMenuUpdate');
    const startMenuReboot = document.getElementById('startMenuReboot');
    const startMenuFactoryReset = document.getElementById('startMenuFactoryReset');
    const startMenuShutdown = document.getElementById('startMenuShutdown');
    const rebootOverlay = document.getElementById('rebootOverlay');
    const rebootProgressText = document.getElementById('rebootProgressText');
    const systemSettings_appearance_bgColorPicker = document.getEleme
