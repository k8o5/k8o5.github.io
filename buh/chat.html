<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Wallet Solana Chat</title>
    
    <!-- 1. REQUIRED LIBRARIES -->
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <script>window.Buffer = window.buffer.Buffer;</script>
    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>

    <style>
        body { background: #050505; color: #00ff41; font-family: 'Courier New', monospace; padding: 20px; max-width: 800px; margin: 0 auto; }
        .box { border: 1px solid #333; padding: 20px; margin-bottom: 20px; background: #000; position: relative; }
        h2 { margin-top: 0; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 10px; color: #fff; display: flex; justify-content: space-between; align-items: center; }
        
        /* CHAT HISTORY */
        #chatBox { 
            height: 400px; overflow-y: auto; border: 1px solid #222; padding: 10px; 
            background: #0a0a0a; display: flex; flex-direction: column-reverse; 
        }
        .msg-row { margin-bottom: 12px; border-bottom: 1px solid #111; padding-bottom: 8px; }
        .msg-meta { font-size: 10px; color: #666; margin-bottom: 4px; }
        .msg-text { color: #fff; font-size: 14px; word-wrap: break-word; }
        .loading { text-align: center; color: #888; padding: 20px; }

        /* INPUTS & BUTTONS */
        input { background: #111; border: 1px solid #333; color: #fff; padding: 10px; width: 70%; }
        button { background: #00ff41; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; width: 28%; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        .refresh-btn { background: transparent; border: 1px solid #333; color: #888; width: auto; font-size: 10px; padding: 2px 10px; }
        .refresh-btn:hover { border-color: #fff; color: #fff; }

        /* MODAL (Wallet Selector) */
        #walletModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #000; border: 1px solid #00ff41; padding: 20px; width: 300px; text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }
        .wallet-option {
            display: block; width: 100%; padding: 15px; margin-bottom: 10px;
            background: #111; border: 1px solid #333; color: #fff; cursor: pointer; font-family: inherit;
        }
        .wallet-option:hover { background: #222; border-color: #00ff41; }
        .wallet-option img { width: 20px; vertical-align: middle; margin-right: 10px; }
        .close-modal { margin-top: 10px; color: #666; cursor: pointer; text-decoration: underline; font-size: 12px; }
    </style>
</head>
<body>

    <!-- WALLET SELECTOR MODAL -->
    <div id="walletModal">
        <div class="modal-content">
            <h3 style="color:#fff; margin-top:0">SELECT WALLET</h3>
            <div id="walletList">
                <!-- Wallets injected here -->
            </div>
            <div class="close-modal" onclick="closeModal()">Close</div>
        </div>
    </div>

    <!-- 1. CONNECT -->
    <div class="box">
        <h2>
            STATUS: <span id="status">Scanning...</span>
            <button class="refresh-btn" id="connectMainBtn" onclick="openWalletModal()">CONNECT WALLET</button>
        </h2>
        <div id="walletAddr" style="font-size:12px; color:#666">Not Connected</div>
    </div>

    <!-- 2. CHAT HISTORY -->
    <div class="box">
        <h2>
            LIVE CHAT ($k8o5)
            <button class="refresh-btn" onclick="fetchMessages()">REFRESH</button>
        </h2>
        <div id="chatBox">
            <div class="loading">Loading blockchain history...</div>
        </div>
    </div>

    <!-- 3. SEND INPUT -->
    <div class="box">
        <div style="display:flex; justify-content:space-between;">
            <input type="text" id="msgInput" placeholder="Write a message on-chain..." disabled>
            <button id="sendBtn" onclick="sendMessage()" disabled>SEND</button>
        </div>
        <div id="txLog" style="font-size:10px; margin-top:10px; color:#888;"></div>
    </div>

    <script>
        // --- CONFIG ---
        const TARGET_WALLET = "3FkfFXtMDVkKJ6SAouMSK4qYFmErYxSnAUx6vP52pump"; 
        const RPC_URL = "https://solana-rpc.publicnode.com";

        let provider = null; // The active wallet provider
        let connection = new solanaWeb3.Connection(RPC_URL, "confirmed");

        // --- INIT ---
        window.onload = () => {
            detectWallets();
            fetchMessages();
        };

        // --- WALLET DETECTION LOGIC ---
        function detectWallets() {
            const status = document.getElementById('status');
            const wallets = [];

            // 1. Phantom
            if (window.solana && window.solana.isPhantom) wallets.push('Phantom');
            // 2. Solflare
            if (window.solflare) wallets.push('Solflare');
            // 3. Backpack
            if (window.backpack) wallets.push('Backpack');
            // 4. Brave / Trust / Gloom (Standard Injection)
            if (window.solana && !window.solana.isPhantom) wallets.push('Standard/Brave');

            if (wallets.length > 0) {
                status.innerText = wallets.join(", ") + " Detected";
                status.style.color = "#00ff41";
            } else {
                status.innerText = "No Wallets Found";
                status.style.color = "red";
            }
        }

        // --- UI LOGIC ---
        function openWalletModal() {
            const list = document.getElementById('walletList');
            list.innerHTML = ''; // Clear

            // Add Buttons based on what exists
            if (window.solana && window.solana.isPhantom) createWalletBtn('Phantom', () => selectWallet(window.solana));
            if (window.solflare) createWalletBtn('Solflare', () => selectWallet(window.solflare));
            if (window.backpack) createWalletBtn('Backpack', () => selectWallet(window.backpack));
            
            // Catch-all
            if (window.solana && !window.solana.isPhantom) {
                createWalletBtn('Other (Brave/Trust)', () => selectWallet(window.solana));
            }

            if (list.innerHTML === '') {
                list.innerHTML = "<div style='color:#666; padding:10px'>No Solana wallets found.<br>Please install Phantom, Solflare, or Backpack.</div>";
            }

            document.getElementById('walletModal').style.display = 'flex';
        }

        function createWalletBtn(name, onClick) {
            const btn = document.createElement('button');
            btn.className = 'wallet-option';
            btn.innerText = name;
            btn.onclick = onClick;
            document.getElementById('walletList').appendChild(btn);
        }

        function closeModal() {
            document.getElementById('walletModal').style.display = 'none';
        }

        async function selectWallet(selectedProvider) {
            provider = selectedProvider;
            closeModal();
            try {
                const resp = await provider.connect();
                // Solflare returns an object, Phantom might behave differently, standardizing:
                const pubKey = resp.publicKey || provider.publicKey;
                handleConnect(pubKey);
            } catch (err) {
                console.error("Connection cancelled", err);
            }
        }

        function handleConnect(pk) {
            if(!pk) return;
            document.getElementById('walletAddr').innerText = pk.toString();
            document.getElementById('connectMainBtn').innerText = "CONNECTED";
            document.getElementById('connectMainBtn').disabled = true;
            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
        }

        // --- CHAT READ LOGIC ---
        async function fetchMessages() {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = '<div class="loading">Scanning Blockchain...</div>';

            try {
                const pubKey = new solanaWeb3.PublicKey(TARGET_WALLET);
                const signatures = await connection.getSignaturesForAddress(pubKey, { limit: 20 });

                if (signatures.length === 0) {
                    chatBox.innerHTML = '<div class="loading">No messages found.</div>';
                    return;
                }

                chatBox.innerHTML = ''; 

                const txs = await Promise.all(signatures.map(async (sigInfo) => {
                    try {
                        const tx = await connection.getParsedTransaction(sigInfo.signature, { maxSupportedTransactionVersion: 0 });
                        return { tx, sig: sigInfo.signature, time: sigInfo.blockTime };
                    } catch (e) { return null; }
                }));

                txs.filter(t => t).forEach(item => {
                    if(!item.tx || !item.tx.meta) return;
                    const logs = item.tx.meta.logMessages || [];
                    const sender = item.tx.transaction.message.accountKeys[0].pubkey.toString();
                    
                    const memoRegex = /Program log: Memo \(len \d+\): "(.*)"/;
                    let memoText = null;
                    
                    for (const log of logs) {
                        const match = log.match(memoRegex);
                        if (match) { memoText = match[1]; break; }
                    }

                    if (memoText) addMessageToUI(sender, memoText, item.sig, item.time);
                });

            } catch (err) {
                console.error(err);
                chatBox.innerHTML = '<div class="loading" style="color:red">Load Error. Try Refresh.</div>';
            }
        }

        function addMessageToUI(sender, text, sig, timestamp) {
            const box = document.getElementById('chatBox');
            const row = document.createElement('div');
            row.className = 'msg-row';
            const date = new Date(timestamp * 1000).toLocaleTimeString();
            const shortAddr = sender.slice(0,4) + '...' + sender.slice(-4);

            row.innerHTML = `
                <div class="msg-meta">
                    <span style="color:#00ff41; font-weight:bold;">${shortAddr}</span> • ${date} • 
                    <a href="https://solscan.io/tx/${sig}" target="_blank" style="color:#666; text-decoration:none;">TX</a>
                </div>
                <div class="msg-text">${escapeHtml(text)}</div>
            `;
            box.appendChild(row);
        }

        // --- CHAT WRITE LOGIC ---
        async function sendMessage() {
            const text = document.getElementById('msgInput').value;
            if(!text) return;
            if(!provider) return alert("Select a wallet first!");

            const btn = document.getElementById('sendBtn');
            const log = document.getElementById('txLog');
            btn.disabled = true;
            btn.innerText = "SENDING...";

            try {
                const tx = new solanaWeb3.Transaction();
                const from = provider.publicKey || (await provider.connect()).publicKey;

                // 1. Memo
                tx.add(new solanaWeb3.TransactionInstruction({
                    keys: [{ pubkey: from, isSigner: true, isWritable: true }],
                    programId: new solanaWeb3.PublicKey("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),
                    data: Buffer.from(text, 'utf-8')
                }));

                // 2. Transfer 0 SOL
                tx.add(solanaWeb3.SystemProgram.transfer({
                    fromPubkey: from,
                    toPubkey: new solanaWeb3.PublicKey(TARGET_WALLET),
                    lamports: 0
                }));

                const { blockhash } = await connection.getLatestBlockhash();
                tx.recentBlockhash = blockhash;
                tx.feePayer = from;

                const { signature } = await provider.signAndSendTransaction(tx);
                
                log.innerHTML = `<span style="color:#00ff41">Sent! Waiting...</span>`;
                
                setTimeout(() => {
                    document.getElementById('msgInput').value = "";
                    btn.innerText = "SEND";
                    btn.disabled = false;
                    log.innerHTML = `<a href="https://solscan.io/tx/${signature}" target="_blank" style="color:#00ff41">Success! View TX</a>`;
                    fetchMessages();
                }, 2000);

            } catch(err) {
                console.error(err);
                log.innerText = "Error: " + err.message;
                btn.disabled = false;
                btn.innerText = "SEND";
            }
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
