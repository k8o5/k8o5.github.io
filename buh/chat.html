<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAULT_V5_FIXED</title>
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --main: #fff; --bg: #000; --accent: #00ff41; --danger: #ff003c; }
        * { box-sizing: border-box; cursor: crosshair; }
        body { background: var(--bg); color: var(--main); font-family: 'Courier New', Courier, monospace; margin: 0; padding: 0; overflow-x: hidden; }

        /* BRUTALIST UI V5 */
        .wrapper { max-width: 900px; margin: 60px auto; padding: 0 20px; }
        .panel { border: 4px solid var(--main); background: var(--bg); box-shadow: 12px 12px 0px var(--main); padding: 30px; margin-bottom: 40px; }
        .panel-header { font-size: 2.5rem; font-weight: 900; line-height: 0.8; text-transform: uppercase; margin-bottom: 25px; border-bottom: 4px solid var(--main); padding-bottom: 10px; }
        
        button { background: var(--main); color: var(--bg); border: none; padding: 15px 25px; font-family: monospace; font-weight: 900; text-transform: uppercase; font-size: 1rem; transition: 0.1s; width: 100%; margin: 10px 0; }
        button:hover { background: var(--accent); transform: translate(-4px, -4px); box-shadow: 4px 4px 0 var(--main); }
        button:disabled { background: #333; color: #666; transform: none; box-shadow: none; cursor: not-allowed; }

        input, textarea { width: 100%; background: #111; border: 3px solid var(--main); color: var(--accent); padding: 15px; font-family: monospace; font-size: 1.1rem; margin-bottom: 15px; }
        
        .status-line { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .blink { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        .split { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        @media (max-width: 768px) { .split { grid-template-columns: 1fr; } }

        .note-card { border: 2px solid var(--main); padding: 20px; margin-bottom: 20px; background: #000; }
        .note-date { font-size: 0.7rem; color: #666; margin-bottom: 5px; }
        
        .hidden { display: none !important; }
        #reader { border: 4px solid var(--accent); margin-bottom: 20px; width: 100% !important; }
        #qr-code { background: #fff; padding: 10px; display: inline-block; border: 4px solid var(--accent); }
    </style>
</head>
<body>

<div class="wrapper">
    <!-- LOGIN SCREEN -->
    <div id="login-zone">
        <div class="panel">
            <div class="panel-header">VAULT_SYSTEM_V5<br>ENCRYPTED_CORE</div>
            <div class="status-line"><div class="blink"></div> SYSTEM_READY_WAITING_FOR_KEY</div>
            
            <input type="password" id="seedInput" placeholder="ENTER_12_WORDS_OR_PRIVATE_KEY">
            
            <div class="split">
                <button id="authBtn">AUTHORIZE_ACCESS</button>
                <button id="scanBtn" style="background: #000; color: #fff; border: 2px solid #fff;">SCAN_QR_ID</button>
            </div>
            <button id="genBtn" style="background: #111; color: #444; border: 1px solid #333; margin-top: 20px;">GENERATE_NEW_IDENTITY</button>
            
            <div id="reader-container" class="hidden">
                <div id="reader"></div>
                <button id="stopScanBtn">STOP_SCANNER</button>
            </div>
        </div>
    </div>

    <!-- VAULT SCREEN -->
    <div id="vault-zone" class="hidden">
        <div class="panel">
            <div class="panel-header">SECURE_WORKSPACE</div>
            <div class="status-line">
                <div class="blink"></div> NODE_STATUS: <span id="syncStatus" style="color: var(--accent);">INITIALIZING_HELIA...</span>
            </div>

            <textarea id="noteInput" rows="4" placeholder="INPUT_DATA_FOR_ENCRYPTION..."></textarea>
            <button id="saveBtn">ENCRYPT_AND_PUBLISH_TO_IPFS</button>
        </div>

        <div class="split">
            <div id="notes-list"></div>
            <div>
                <div class="panel">
                    <div style="font-size: 0.8rem; margin-bottom: 15px;">BACKUP_IDENTITY_QR</div>
                    <div id="qr-wrap"><div id="qr-code"></div></div>
                    <button id="logoffBtn" style="color: var(--danger); border: 2px solid var(--danger); background: transparent; margin-top: 20px;">TERMINATE_SESSION</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // Import Helia modules via ESM.sh
    import { createHelia } from 'https://esm.sh/helia';
    import { strings } from 'https://esm.sh/@helia/strings';
    import { ipns } from 'https://esm.sh/@helia/ipns';
    import { generateKeyPairFromSeed } from 'https://esm.sh/@libp2p/crypto/keys';

    let helia, s, heliaIpns, encKey, currentSeed;
    let notes = [];
    const KEY_NAME = 'vault-v5-final';

    // UI ELEMENTS
    const loginZone = document.getElementById('login-zone');
    const vaultZone = document.getElementById('vault-zone');
    const seedInput = document.getElementById('seedInput');

    // --- FUNKTIONEN AN WINDOW BINDEN ---
    // Dies lÃ¶st den "Uncaught ReferenceError"
    
    window.generateNew = () => {
        const w = ethers.Wallet.createRandom();
        seedInput.value = w.mnemonic.phrase;
        alert("WRITE DOWN YOUR SEED:\n\n" + w.mnemonic.phrase);
    };

    window.startScanner = () => {
        const readerCont = document.getElementById('reader-container');
        readerCont.classList.remove('hidden');
        const scanner = new Html5Qrcode("reader");
        window.activeScanner = scanner;
        
        scanner.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: 250 },
            (txt) => {
                seedInput.value = txt;
                window.stopScanner();
                window.doLogin();
            }
        ).catch(err => console.error("Scanner error", err));
    };

    window.stopScanner = () => {
        if(window.activeScanner) {
            window.activeScanner.stop();
            document.getElementById('reader-container').classList.add('hidden');
        }
    };

    window.doLogin = async () => {
        currentSeed = seedInput.value.trim();
        if(!currentSeed) return alert("SEED_REQUIRED");

        try {
            // Key Derivation
            const wallet = currentSeed.split(' ').length > 1 ? 
                           ethers.Wallet.fromMnemonic(currentSeed) : 
                           new ethers.Wallet(currentSeed);
            const entropy = ethers.utils.arrayify(ethers.utils.sha256(wallet.privateKey));
            
            // AES Setup
            encKey = await crypto.subtle.importKey("raw", entropy, "AES-GCM", false, ["encrypt", "decrypt"]);
            
            // Transition
            loginZone.classList.add('hidden');
            vaultZone.classList.remove('hidden');
            
            // QR Access Code
            new QRCode(document.getElementById("qr-code"), { text: currentSeed, width: 160, height: 160 });

            // Load local data first
            loadLocalCache();
            // Start Helia
            initHelia(entropy);
        } catch (e) {
            alert("KEY_INVALID: " + e.message);
        }
    };

    async function initHelia(entropy) {
        try {
            helia = await createHelia();
            s = strings(helia);
            heliaIpns = ipns(helia);
            
            const keyPair = await generateKeyPairFromSeed('Ed25519', entropy);
            await helia.libp2p.keychain.importKey(KEY_NAME, keyPair);
            
            document.getElementById('syncStatus').innerText = "ONLINE_SYNCING...";
            syncRemote();
        } catch (e) {
            document.getElementById('syncStatus').innerText = "LOCAL_ONLY_MODE";
        }
    }

    window.saveNote = async () => {
        const val = document.getElementById('noteInput').value;
        if(!val) return;

        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerText = "ENCRYPTING...";

        notes.unshift({ t: val, d: new Date().toLocaleString() });
        renderNotes();
        document.getElementById('noteInput').value = "";

        // Encrypt
        const encrypted = await encryptData(JSON.stringify(notes));
        
        // Save Local
        localStorage.setItem('v5_cache_' + btoa(currentSeed.substring(0,8)), JSON.stringify(encrypted));

        // Save Helia
        if(helia) {
            try {
                const cid = await s.add(JSON.stringify(encrypted));
                await heliaIpns.publish(KEY_NAME, cid);
                btn.innerText = "IPNS_PUBLISH_SUCCESS";
            } catch (e) {
                btn.innerText = "LOCAL_SAVE_OK_IPFS_DELAYED";
            }
        }
        
        setTimeout(() => { btn.disabled = false; btn.innerText = "ENCRYPT_AND_PUBLISH_TO_IPFS"; }, 2000);
    };

    // --- CRYPTO ---
    async function encryptData(text) {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encoded = new TextEncoder().encode(text);
        const cipher = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, encKey, encoded);
        return { iv: Array.from(iv), data: Array.from(new Uint8Array(cipher)) };
    }

    async function decryptData(obj) {
        const dec = await crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(obj.iv) }, encKey, new Uint8Array(obj.data));
        return JSON.parse(new TextDecoder().decode(dec));
    }

    // --- UTILS ---
    function renderNotes() {
        document.getElementById('notes-list').innerHTML = notes.map(n => `
            <div class="note-card">
                <div class="note-date">${n.d}</div>
                <div>${n.t}</div>
            </div>
        `).join('');
    }

    function loadLocalCache() {
        const cache = localStorage.getItem('v5_cache_' + btoa(currentSeed.substring(0,8)));
        if(cache) decryptData(JSON.parse(cache)).then(d => { notes = d; renderNotes(); });
    }

    async function syncRemote() {
        try {
            const peerId = await helia.libp2p.keychain.exportPeerId(KEY_NAME);
            const res = await heliaIpns.resolve(peerId);
            const raw = await s.get(res.cid);
            const remoteNotes = await decryptData(JSON.parse(raw));
            if(remoteNotes.length > notes.length) {
                notes = remoteNotes;
                renderNotes();
                document.getElementById('syncStatus').innerText = "REMOTE_SYNC_DONE";
            }
        } catch(e) { console.log("No remote record found yet."); }
    }

    // EVENT LISTENERS (Die sicherere Alternative zu onclick)
    document.getElementById('authBtn').addEventListener('click', window.doLogin);
    document.getElementById('genBtn').addEventListener('click', window.generateNew);
    document.getElementById('scanBtn').addEventListener('click', window.startScanner);
    document.getElementById('stopScanBtn').addEventListener('click', window.stopScanner);
    document.getElementById('saveBtn').addEventListener('click', window.saveNote);
    document.getElementById('logoffBtn').addEventListener('click', () => location.reload());

</script>
</body>
</html>
