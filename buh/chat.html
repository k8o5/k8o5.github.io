<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Solana Chat</title>
    
    <!-- 1. BUFFER POLYFILL (REQUIRED FOR SOLANA) -->
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <script>window.Buffer = window.buffer.Buffer;</script>

    <!-- 2. SOLANA WEB3.JS -->
    <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>

    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        .box { border: 1px solid #333; padding: 20px; margin-bottom: 20px; }
        button { background: #0f0; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        input { background: #111; border: 1px solid #333; color: #fff; padding: 10px; width: 300px; }
        .log { color: #666; font-size: 12px; margin-top: 5px; }
        .error { color: #f00; font-weight: bold; }
        .success { color: #0f0; font-weight: bold; }
    </style>
</head>
<body>

    <div class="box">
        <h2>1. STATUS</h2>
        <div id="status">Scanning for Phantom...</div>
        <div id="network">Network: Mainnet-Beta</div>
    </div>

    <div class="box">
        <h2>2. CONNECT</h2>
        <button id="connectBtn" onclick="connectWallet()">CONNECT WALLET</button>
        <div id="walletAddr" class="log">Not Connected</div>
    </div>

    <div class="box">
        <h2>3. CHAT (ON-CHAIN)</h2>
        <input type="text" id="msgInput" placeholder="Type message..." disabled>
        <button id="sendBtn" onclick="sendMessage()" disabled>SEND MESSAGE</button>
        <div id="txLog" class="log" style="margin-top:20px;"></div>
    </div>

    <script>
        // CONFIG
        const TARGET_WALLET = "3FkfFXtMDVkKJ6SAouMSK4qYFmErYxSnAUx6vP52pump"; 
        const RPC = "https://api.mainnet-beta.solana.com";

        let provider = null;
        let connection = new solanaWeb3.Connection(RPC, "confirmed");

        // --- 1. ROBUST PROVIDER FINDER ---
        // Loops for 2 seconds looking for Phantom injection
        window.addEventListener('load', async () => {
            const statusEl = document.getElementById('status');
            
            // Check if running on file:// protocol
            if (window.location.protocol === 'file:') {
                statusEl.innerHTML = "<span class='error'>WARNING: You are opening this as a local file.<br>Phantom blocks this by default.<br>Please use a Local Server (localhost) OR enable 'Allow access to file URLs' in Phantom extension settings.</span>";
            }

            let attempts = 0;
            const checkProvider = setInterval(() => {
                attempts++;
                // Check standard window.solana
                const p = window.solana;
                if (p && p.isPhantom) {
                    clearInterval(checkProvider);
                    provider = p;
                    statusEl.innerText = "Phantom Detected.";
                    console.log("Phantom found!");
                    
                    // Auto-detect if already connected
                    if(p.isConnected) handleConnect(p.publicKey);
                    return;
                }
                
                // Stop checking after 20 attempts (2 seconds)
                if (attempts > 20) {
                    clearInterval(checkProvider);
                    if(window.location.protocol !== 'file:') {
                        statusEl.innerText = "Phantom not found. Is it installed?";
                    }
                }
            }, 100);
        });

        // --- 2. CONNECT LOGIC ---
        async function connectWallet() {
            if (!provider) return alert("Phantom provider not found yet. Wait a second or refresh.");
            try {
                const resp = await provider.connect();
                handleConnect(resp.publicKey);
            } catch (err) {
                console.error(err);
                alert("User rejected connection");
            }
        }

        function handleConnect(pubKey) {
            document.getElementById('walletAddr').innerText = "Wallet: " + pubKey.toString();
            document.getElementById('connectBtn').innerText = "CONNECTED";
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
        }

        // --- 3. SEND LOGIC ---
        async function sendMessage() {
            const text = document.getElementById('msgInput').value;
            if(!text) return;
            if(!provider || !provider.publicKey) return alert("Connect wallet first");

            const btn = document.getElementById('sendBtn');
            const log = document.getElementById('txLog');
            
            btn.disabled = true;
            btn.innerText = "SIGNING...";
            log.innerHTML = "Building transaction...";

            try {
                const tx = new solanaWeb3.Transaction();
                const fromPubkey = provider.publicKey;

                // A. MEMO Instruction (The Message)
                const memoProgramId = new solanaWeb3.PublicKey("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr");
                tx.add(new solanaWeb3.TransactionInstruction({
                    keys: [{ pubkey: fromPubkey, isSigner: true, isWritable: true }],
                    programId: memoProgramId,
                    data: Buffer.from(text, 'utf-8')
                }));

                // B. Tiny Transfer (Optional - keeps account active)
                tx.add(solanaWeb3.SystemProgram.transfer({
                    fromPubkey: fromPubkey,
                    toPubkey: new solanaWeb3.PublicKey(TARGET_WALLET),
                    lamports: 0 // sending 0 SOL, just gas
                }));

                const { blockhash } = await connection.getLatestBlockhash();
                tx.recentBlockhash = blockhash;
                tx.feePayer = fromPubkey;

                const { signature } = await provider.signAndSendTransaction(tx);
                
                log.innerHTML = `<span class="success">Message Sent!</span><br>Sig: ${signature.slice(0,16)}...<br><a href="https://solscan.io/tx/${signature}" target="_blank" style="color:#fff">View on Solscan</a>`;
                document.getElementById('msgInput').value = "";
                btn.innerText = "SEND MESSAGE";
                btn.disabled = false;

            } catch (err) {
                console.error(err);
                log.innerHTML = `<span class="error">Failed: ${err.message}</span>`;
                btn.innerText = "SEND MESSAGE";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
