<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAULT</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --main: #fff; --bg: #000; --accent: #00ff41; --danger: #ff003c; }
        * { box-sizing: border-box; cursor: crosshair; }
        body { background: var(--bg); color: var(--main); font-family: 'Courier New', monospace; margin: 0; padding: 0; }

        /* UI  STABLE */
        .wrapper { max-width: 800px; margin: 40px auto; padding: 20px; }
        .panel { border: 6px solid var(--main); background: var(--bg); padding: 30px; box-shadow: 15px 15px 0px #333; margin-bottom: 30px; }
        .panel-header { font-size: 2.5rem; font-weight: 900; line-height: 0.9; text-transform: uppercase; border-bottom: 6px solid var(--main); padding-bottom: 10px; margin-bottom: 20px; }
        
        button { background: var(--main); color: var(--bg); border: none; padding: 18px; font-family: monospace; font-weight: 900; text-transform: uppercase; font-size: 1rem; width: 100%; margin: 5px 0; cursor: pointer; }
        button:hover { background: var(--accent); }
        button:disabled { opacity: 0.3; }

        input, textarea { width: 100%; background: #000; border: 3px solid var(--main); color: var(--accent); padding: 15px; font-family: monospace; font-size: 1.1rem; margin-bottom: 10px; }
        
        .status-line { font-size: 0.7rem; margin-bottom: 20px; letter-spacing: 1px; color: var(--accent); border: 1px solid var(--accent); padding: 5px; display: inline-block; }
        .note-card { border-left: 5px solid var(--accent); padding: 15px; margin-bottom: 15px; background: #111; }
        .hidden { display: none !important; }
        #qr-code { background: #fff; padding: 10px; display: inline-block; border: 3px solid var(--accent); }
    </style>
</head>
<body>

<div class="wrapper">
    <!-- LOGIN SCREEN -->
    <div id="login-zone">
        <div class="panel">
            <div class="panel-header">VAULT<br>OFFLINE_FIRST</div>
            <div class="status-line">SYSTEM_READY // SECURE_MODE_ACTIVE</div>
            
            <input type="password" id="seedInput" placeholder="SEED_PHRASE_OR_PRIVATE_KEY">
            <button id="authBtn">OPEN_VAULT</button>
            <button id="scanBtn" style="background:#000; color:#fff; border:2px solid #fff;">SCAN_QR</button>
            <button id="genBtn" style="background:#111; color:#555; font-size:0.7rem;">CREATE_NEW_WALLET</button>
            
            <div id="reader-container" class="hidden">
                <div id="reader"></div>
            </div>
        </div>
    </div>

    <!-- VAULT SCREEN -->
    <div id="vault-zone" class="hidden">
        <div class="panel">
            <div class="panel-header">WORKSPACE</div>
            <div id="syncStatus" class="status-line">HELIA_BOOTING...</div>

            <textarea id="noteInput" rows="3" placeholder="WRITE_SECRET_DATA..."></textarea>
            <button id="saveBtn">ENCRYPT_AND_SAVE</button>
        </div>

        <div id="notes-list"></div>

        <div class="panel" style="margin-top: 50px; border-width: 2px;">
            <div style="font-size: 0.7rem; margin-bottom: 10px;">AUTH_BACKUP_QR</div>
            <div id="qr-code"></div>
            <button onclick="location.reload()" style="background:var(--danger); color:#fff; margin-top:20px;">TERMINATE</button>
        </div>
    </div>
</div>

<script type="module">
    import { createHelia } from 'https://esm.sh/helia';
    import { strings } from 'https://esm.sh/@helia/strings';
    import { ipns } from 'https://esm.sh/@helia/ipns';
    import { generateKeyPairFromSeed } from 'https://esm.sh/@libp2p/crypto/keys';

    let helia, s, heliaIpns, encKey, currentSeed, notes = [];

    // --- INITIALISIERUNG ---
    
    // UI Refs
    const seedInput = document.getElementById('seedInput');
    const syncStatus = document.getElementById('syncStatus');

    window.doLogin = async () => {
        currentSeed = seedInput.value.trim();
        if(!currentSeed) return;

        try {
            // 1. Krypto-Identität ableiten
            const wallet = currentSeed.split(' ').length > 1 ? 
                           ethers.Wallet.fromMnemonic(currentSeed) : 
                           new ethers.Wallet(currentSeed);
            const entropy = ethers.utils.arrayify(ethers.utils.sha256(wallet.privateKey));
            
            encKey = await crypto.subtle.importKey("raw", entropy, "AES-GCM", false, ["encrypt", "decrypt"]);
            
            // 2. UI sofort umschalten (Offline-First)
            document.getElementById('login-zone').classList.add('hidden');
            document.getElementById('vault-zone').classList.remove('hidden');
            new QRCode(document.getElementById("qr-code"), { text: currentSeed, width: 150, height: 150 });

            loadLocal();

            // 3. Helia leise im Hintergrund starten (ohne das fehlerhafte Delegated Routing)
            initHelia(entropy);
        } catch (e) { alert("ERROR: INVALID_SEED"); }
    };

    async function initHelia(entropy) {
        try {
            // Wir nutzen die Standard-Helia Instanz, fangen aber Netzwerkfehler ab
            helia = await createHelia();
            s = strings(helia);
            heliaIpns = ipns(helia);
            
            const keyPair = await generateKeyPairFromSeed('Ed25519', entropy);
            await helia.libp2p.keychain.importKey('-key', keyPair);
            
            syncStatus.innerText = "IPFS_ONLINE_SYNC_ACTIVE";
            
            // Versuche Remote-Sync (Fehler hier ignorieren wir einfach)
            try {
                const peerId = await helia.libp2p.keychain.exportPeerId('-key');
                const res = await heliaIpns.resolve(peerId);
                const raw = await s.get(res.cid);
                const remote = await decrypt(JSON.parse(raw));
                if(remote.length > notes.length) {
                    notes = remote;
                    render();
                }
            } catch(e) { console.log("No IPNS record yet."); }

        } catch (e) {
            syncStatus.innerText = "LOCAL_ENCRYPTION_ONLY";
            console.warn("Network restricted, running in local mode.");
        }
    }

    // --- FUNKTIONEN ---

    window.saveNote = async () => {
        const val = document.getElementById('noteInput').value;
        if(!val) return;
        
        notes.unshift({ t: val, d: new Date().toLocaleString() });
        render();
        document.getElementById('noteInput').value = "";

        const encrypted = await encrypt(JSON.stringify(notes));
        // LocalStorage ist unser primärer Speicher
        localStorage.setItem('_cache_' + btoa(currentSeed.substring(0,8)), JSON.stringify(encrypted));

        // IPFS Sync im Hintergrund (Silent)
        if(helia) {
            try {
                const cid = await s.add(JSON.stringify(encrypted));
                await heliaIpns.publish('-key', cid);
                syncStatus.innerText = "SYNCED_TO_IPFS";
            } catch(e) { syncStatus.innerText = "SYNC_PENDING..."; }
        }
    };

    async function encrypt(text) {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encoded = new TextEncoder().encode(text);
        const cipher = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, encKey, encoded);
        return { iv: Array.from(iv), data: Array.from(new Uint8Array(cipher)) };
    }

    async function decrypt(obj) {
        const dec = await crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(obj.iv) }, encKey, new Uint8Array(obj.data));
        return JSON.parse(new TextDecoder().decode(dec));
    }

    function loadLocal() {
        const cache = localStorage.getItem('_cache_' + btoa(currentSeed.substring(0,8)));
        if(cache) decrypt(JSON.parse(cache)).then(d => { notes = d; render(); });
    }

    function render() {
        document.getElementById('notes-list').innerHTML = notes.map(n => `
            <div class="note-card">
                <div style="font-size:0.6rem; color:#555;">${n.d}</div>
                <div>${n.t}</div>
            </div>
        `).join('');
    }

    // --- EVENT LISTENERS ---
    document.getElementById('authBtn').addEventListener('click', window.doLogin);
    document.getElementById('saveBtn').addEventListener('click', window.saveNote);
    document.getElementById('genBtn').addEventListener('click', () => {
        const w = ethers.Wallet.createRandom();
        seedInput.value = w.mnemonic.phrase;
        alert("BACKUP_YOUR_SEED:\n\n" + w.mnemonic.phrase);
    });
    document.getElementById('scanBtn').addEventListener('click', () => {
        const reader = document.getElementById('reader-container');
        reader.classList.remove('hidden');
        const scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
            seedInput.value = txt;
            scanner.stop();
            reader.classList.add('hidden');
            window.doLogin();
        });
    });
</script>
</body>
</html>
