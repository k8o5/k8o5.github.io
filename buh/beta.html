<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOL-Phantom-AI-Bot</title>
    <!-- Solana Web3.js from CDN for transaction construction -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>
<body style="background-color: #000000; color: #00FF00; font-family: 'Courier New', Courier, monospace; margin: 20px;">

    <!-- APP CONTAINER -->
    <div style="max-width: 800px; margin: 0 auto; border: 2px solid #00FF00; padding: 20px;">
        
        <!-- HEADER -->
        <div style="border-bottom: 1px solid #00FF00; margin-bottom: 20px; padding-bottom: 10px;">
            <h1 style="margin: 0;">ðŸ‘» PHANTOM x OPENROUTER BOT</h1>
            <small>Autonomous AI Agent for Solana Trading</small>
        </div>

        <!-- 1. CONFIGURATION -->
        <div style="margin-bottom: 20px;">
            <h3 style="background-color: #003300; padding: 5px;">[1] SYSTEM CONFIG</h3>
            
            <div style="margin-bottom: 10px;">
                <label>OPENROUTER API KEY:</label><br>
                <input type="password" id="or-api-key" style="width: 100%; background: #111; border: 1px solid #00FF00; color: #fff; padding: 5px;" placeholder="sk-or-...">
            </div>

            <div style="margin-bottom: 10px;">
                <label>RPC URL (Optional, defaults to mainnet):</label><br>
                <input type="text" id="sol-rpc" value="https://api.mainnet-beta.solana.com" style="width: 100%; background: #111; border: 1px solid #00FF00; color: #fff; padding: 5px;">
            </div>
        </div>

        <!-- 2. WALLET CONNECTION -->
        <div style="margin-bottom: 20px;">
            <h3 style="background-color: #003300; padding: 5px;">[2] WALLET UPLINK</h3>
            <button id="btn-connect" onclick="connectWallet()" style="background: #00FF00; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer;">CONNECT PHANTOM</button>
            <div id="wallet-status" style="margin-top: 10px;">STATUS: DISCONNECTED</div>
            <div id="wallet-balance" style="margin-top: 5px;">BALANCE: - SOL</div>
        </div>

        <!-- 3. TRADING PARAMETERS -->
        <div style="margin-bottom: 20px;">
            <h3 style="background-color: #003300; padding: 5px;">[3] AGENT PARAMETERS</h3>
            
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>TARGET TOKEN (CA):</label>
                    <input type="text" id="target-token" placeholder="Example: So111..." style="width: 100%; background: #111; border: 1px solid #00FF00; color: #fff; padding: 5px;">
                </div>
                <div style="flex: 1;">
                    <label>AMOUNT (SOL):</label>
                    <input type="number" id="trade-amount" value="0.01" step="0.01" style="width: 100%; background: #111; border: 1px solid #00FF00; color: #fff; padding: 5px;">
                </div>
            </div>

            <div style="margin-top: 10px;">
                <label>MARKET CONTEXT / STRATEGY:</label>
                <textarea id="market-context" rows="3" style="width: 100%; background: #111; border: 1px solid #00FF00; color: #fff; padding: 5px;" placeholder="e.g. RSI is below 30, volume is spiking, tweet volume high. Should I ape?"></textarea>
            </div>
        </div>

        <!-- 4. EXECUTION -->
        <div style="margin-bottom: 20px;">
            <h3 style="background-color: #003300; padding: 5px;">[4] EXECUTION</h3>
            <button id="btn-run-ai" onclick="runAIBot()" style="background: #000; color: #00FF00; border: 2px solid #00FF00; padding: 15px 30px; font-weight: bold; font-size: 16px; cursor: pointer; width: 100%;">
                INITIALIZE AI ANALYSIS & TRADE
            </button>
        </div>

        <!-- TERMINAL OUTPUT -->
        <div style="border: 1px solid #333; height: 300px; overflow-y: scroll; background: #050505; padding: 10px;" id="console-output">
            <div>> System initialized...</div>
            <div>> Waiting for inputs...</div>
        </div>

    </div>

    <script>
        // --- GLOBAL STATE ---
        let walletAddress = null;
        let connection = null;
        const terminal = document.getElementById('console-output');

        // --- LOGGER ---
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${msg}`;
            if (type === 'error') div.style.color = 'red';
            if (type === 'success') div.style.color = 'cyan';
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // --- SOLANA WALLET FUNCTIONS ---
        async function connectWallet() {
            if ("phantom" in window) {
                const provider = window.phantom?.solana;
                if (provider?.isPhantom) {
                    try {
                        const resp = await provider.connect();
                        walletAddress = resp.publicKey.toString();
                        
                        document.getElementById('wallet-status').innerText = `STATUS: CONNECTED [${walletAddress.slice(0,6)}...]`;
                        document.getElementById('wallet-status').style.color = "cyan";
                        document.getElementById('btn-connect').style.display = 'none';
                        
                        log(`Wallet connected: ${walletAddress}`, 'success');
                        
                        // Init Connection
                        const rpc = document.getElementById('sol-rpc').value;
                        connection = new solanaWeb3.Connection(rpc, 'confirmed');
                        getBalance();

                    } catch (err) {
                        log(`Connection rejected: ${err.message}`, 'error');
                    }
                }
            } else {
                window.open("https://phantom.app/", "_blank");
                log("Phantom Wallet not found.", 'error');
            }
        }

        async function getBalance() {
            if (!walletAddress || !connection) return;
            try {
                const pubKey = new solanaWeb3.PublicKey(walletAddress);
                const balance = await connection.getBalance(pubKey);
                document.getElementById('wallet-balance').innerText = `BALANCE: ${balance / solanaWeb3.LAMPORTS_PER_SOL} SOL`;
            } catch (err) {
                log(`Error fetching balance: ${err.message}`, 'error');
            }
        }

        // --- OPENROUTER AI CORE ---
        async function callOpenRouter(prompt) {
            const apiKey = document.getElementById('or-api-key').value;
            if (!apiKey) {
                throw new Error("Missing OpenRouter API Key");
            }

            const sysPrompt = `
            You are a high-frequency Solana trading bot. 
            Analyze the user input and decide whether to BUY, SELL, or HOLD.
            
            Strictly Output valid JSON in this format:
            {
                "decision": "BUY" | "SELL" | "HOLD",
                "confidence": <number 0-100>,
                "reasoning": "<short explanation>",
                "action": "<technical description>"
            }
            Do not include markdown blocks. Just the JSON string.
            `;

            log("Contacting AI Neural Net...", 'info');

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href, 
                        "X-Title": "SolanaPhantomBot"
                    },
                    body: JSON.stringify({
                        "model": "meta-llama/llama-3-8b-instruct:free", // Using free model for default, change as needed
                        "messages": [
                            {"role": "system", "content": sysPrompt},
                            {"role": "user", "content": prompt}
                        ],
                        "temperature": 0.7
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(`AI Error: ${err.error?.message || response.statusText}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                return JSON.parse(content.replace(/```json/g, '').replace(/```/g, '').trim());

            } catch (error) {
                throw error;
            }
        }

        // --- MAIN BOT LOGIC ---
        async function runAIBot() {
            if (!walletAddress) {
                log("Please connect wallet first.", 'error');
                return;
            }

            const token = document.getElementById('target-token').value;
            const context = document.getElementById('market-context').value;
            const amount = document.getElementById('trade-amount').value;

            if (!token) {
                log("Target Token Address required.", 'error');
                return;
            }

            const prompt = `Target: ${token}. Amount: ${amount} SOL. Context: ${context}. Current Time: ${new Date().toISOString()}.`;

            try {
                // 1. AI Analysis
                const aiDecision = await callOpenRouter(prompt);
                
                log("--------------------------------", 'info');
                log(`AI DECISION: ${aiDecision.decision} (${aiDecision.confidence}%)`, aiDecision.decision === 'BUY' ? 'success' : 'info');
                log(`REASON: ${aiDecision.reasoning}`);
                log("--------------------------------", 'info');

                // 2. Execution Logic
                if (aiDecision.decision === "BUY" && aiDecision.confidence > 70) {
                    await executeSwap(token, amount);
                } else if (aiDecision.decision === "SELL" && aiDecision.confidence > 70) {
                    log("Sell logic triggered (Not implemented in demo to prevent loss).", 'info');
                } else {
                    log("Confidence too low or HOLD signal. No transaction executed.", 'info');
                }

            } catch (err) {
                log(`Bot Execution Failed: ${err.message}`, 'error');
            }
        }

        // --- TRANSACTION EXECUTION (Simulated Swap) ---
        async function executeSwap(tokenAddress, amountSol) {
            log(`Initiating Transaction: Swap ${amountSol} SOL for ${tokenAddress}...`);

            try {
                const provider = window.phantom?.solana;
                const pubKey = new solanaWeb3.PublicKey(walletAddress);
                const targetKey = new solanaWeb3.PublicKey(tokenAddress); // Just checking validity

                // IN A REAL BOT: You would construct a Jupiter Aggregator or Raydium swap instruction here.
                // FOR SAFETY/DEMO: We will create a simple Transfer transaction of SOL to self (0 net cost besides gas)
                // just to demonstrate the Phantom popup working correctly driven by AI.
                
                log("Constructing Blockchain Transaction...", 'info');
                
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: pubKey,
                        toPubkey: pubKey, // Sending to self for demo safety
                        lamports: solanaWeb3.LAMPORTS_PER_SOL * (amountSol / 1000) // Small amount for demo
                    })
                );

                // Get latest blockhash
                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = pubKey;

                log("Requesting Wallet Signature...", 'info');

                // Request signature from Phantom
                const { signature } = await provider.signAndSendTransaction(transaction);
                
                log(`Transaction Sent!`, 'success');
                log(`Signature: ${signature}`);
                log(`Check Explorer: https://solscan.io/tx/${signature}`);

            } catch (err) {
                log(`Transaction Failed/Cancelled: ${err.message}`, 'error');
            }
        }
    </script>
</body>
</html>
