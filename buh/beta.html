<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ΩMEGA // AI TRADER</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22black%22/><text y=%22.9em%22 x=%2250%22 text-anchor=%22middle%22 font-size=%2290%22 fill=%22%2300ff41%22>Ω</text></svg>">

    <!-- LIBS -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #050505;
            --fg: #e0e0e0;
            --accent: #00ff41;
            --danger: #ff003c;
            --ai: #00ffff;
            --border: 3px solid var(--fg);
        }
        body {
            background: var(--bg); color: var(--fg);
            font-family: 'Courier New', monospace;
            font-weight: bold; text-transform: uppercase;
            overflow-x: hidden;
            letter-spacing: -0.5px;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        a { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); transition: 0.2s; }
        a:hover { background: var(--accent); color: #000; }

        /* HEADER */
        header { 
            border-bottom: var(--border); padding-bottom: 20px; margin-bottom: 30px; 
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        h1 { font-size: 4rem; line-height: 0.8; }
        h1 span { color: var(--ai); }
        .server-status { font-size: 12px; color: #666; margin-top: 5px; }
        .connected { color: var(--accent); }

        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        /* PANELS */
        .panel {
            border: var(--border);
            background: #000;
            padding: 20px;
            position: relative;
            box-shadow: 8px 8px 0 #222;
        }
        .panel-title {
            background: var(--fg); color: var(--bg);
            padding: 5px 10px; display: inline-block;
            margin-bottom: 20px; font-size: 14px;
        }

        /* INPUTS */
        input, textarea {
            width: 100%; background: #111; border: 1px solid #333;
            color: var(--fg); font-family: inherit; font-size: 14px; 
            padding: 10px; margin-bottom: 5px; resize: vertical;
        }
        input:focus, textarea:focus { outline: none; border-color: var(--ai); background: #000; }
        label { font-size: 10px; color: #666; display: block; margin-top: 15px; margin-bottom: 5px; }

        .input-group { position: relative; }
        
        .max-btn {
            position: absolute; right: 0; top: 0; bottom: 5px;
            background: var(--accent); color: #000; border: none;
            padding: 0 10px; cursor: pointer; font-weight: bold; font-size: 12px;
        }

        .helper-link { font-size: 10px; display: block; margin-bottom: 15px; text-align: right; }

        /* BUTTONS */
        button {
            width: 100%; padding: 15px; background: transparent;
            border: var(--border); color: var(--fg);
            font-family: inherit; font-size: 16px; font-weight: 900;
            cursor: pointer; transition: 0.1s; margin-top: 10px;
        }
        button:hover { background: var(--fg); color: var(--bg); }
        
        button.btn-gen { border-color: var(--accent); color: var(--accent); }
        button.btn-gen:hover { background: var(--accent); color: #000; }
        
        button.btn-login { border-color: #fff; color: #fff; background: #222; }
        button.btn-login:hover { background: #fff; color: #000; }

        button.btn-logout { border-color: var(--danger); color: var(--danger); margin-top: 20px; }
        button.btn-logout:hover { background: var(--danger); color: #fff; }

        button.ai-btn { border-color: var(--ai); color: var(--ai); }
        button.ai-btn:hover { background: var(--ai); color: #000; box-shadow: 0 0 20px var(--ai); }
        
        /* LOGS */
        .terminal {
            height: 500px; overflow-y: auto;
            border: 1px solid #333; padding: 10px;
            font-size: 11px; background: #000;
        }
        .log-entry { margin-bottom: 5px; border-left: 2px solid #333; padding-left: 8px; word-break: break-all; }
        .log.ai { border-color: var(--ai); color: var(--ai); }
        .log.trade { border-color: var(--accent); color: var(--accent); }
        .log.err { border-color: var(--danger); color: var(--danger); }

        /* QR & STATS */
        #qrcode { background: #fff; padding: 5px; width: fit-content; margin: 10px auto; border: 2px solid var(--accent); }
        .big-num { font-size: 24px; color: var(--accent); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #333; }
        
        .ai-pulse { width: 10px; height: 10px; background: #333; display: inline-block; margin-left: 10px; }
        .thinking { background: var(--ai); animation: pulse 0.2s infinite; }
        @keyframes pulse { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>ΩMEGA<br><span>AI AGENT</span></h1>
            <div class="server-status" id="rpcStatus">CONNECTING TO NETWORK...</div>
        </div>
        <div style="text-align: right;">
            <div>SYSTEM: <span id="sysStatus">OFFLINE</span></div>
            <div style="font-size: 10px; color: #666;">MANDATORY EXPOSURE PROTOCOL</div>
        </div>
    </header>

    <div class="grid">
        <!-- SETUP -->
        <div class="panel">
            <div class="panel-title">1. CONFIGURATION</div>
            
            <label>OPENROUTER API KEY</label>
            <input type="password" id="apiKey" placeholder="sk-or-v1-...">
            <a href="https://openrouter.ai/keys" target="_blank" class="helper-link">GET KEY -></a>
            
            <label>AI MODEL</label>
            <input type="text" id="modelId" value="xiaomi/mimo-v2-flash:free">
            <a href="https://openrouter.ai/models" target="_blank" class="helper-link">BROWSE MODELS LIST -></a>
            
            <label>WALLET ACCESS</label>
            
            <!-- AUTH PANEL (LOGGED OUT) -->
            <div id="authPanel">
                <textarea id="privKey" rows="3" placeholder="PASTE KEY (JSON ARRAY OR PHANTOM BASE58)"></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn-gen" onclick="generateWallet()">GENERATE</button>
                    <button class="btn-login" onclick="loginWallet()">LOGIN</button>
                </div>
            </div>

            <!-- WALLET PANEL (LOGGED IN) -->
            <div id="walletPanel" class="hidden">
                <div style="border: 1px solid var(--accent); padding: 10px;">
                    <div style="text-align:center; color: var(--accent); margin-bottom:5px;">AUTHENTICATED</div>
                    <div id="qrcode"></div>
                    <div id="pubKey" style="font-size: 10px; margin: 5px 0; word-break:break-all; text-align:center;">...</div>
                    <div class="big-num" style="text-align:center;"><span id="balance">0.00</span> SOL</div>
                    <button onclick="refreshBalance()" style="font-size:10px; padding:5px;">REFRESH</button>
                </div>
                <button class="btn-logout" onclick="logoutWallet()">LOGOUT</button>
            </div>
        </div>

        <!-- TRADING -->
        <div class="panel">
            <div class="panel-title">2. TRADING TARGET</div>
            
            <label>TOKEN ADDRESS (CA)</label>
            <input type="text" id="tokenCA" placeholder="Ex: So111...">
            <div class="helper-link"><a href="https://k8o5.com" target="_blank">FIND TOKENS ON K8O5.COM -></a></div>
            
            <label>TRADE AMOUNT (SOL)</label>
            <div class="input-group">
                <input type="number" id="capital" value="0.1" step="0.01">
                <button class="max-btn" onclick="setMaxSol()">MAX</button>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="ai-btn" id="startBtn" onclick="toggleAI()">INITIALIZE AGENT</button>
            </div>

            <div style="margin-top: 20px; border: 1px dashed var(--ai); padding: 10px;">
                <label>LIVE STATUS</label>
                <div class="stat-row">
                    <span>STATE:</span>
                    <span id="agentState" style="color: var(--ai)">LIQUID (SOL)</span>
                </div>
                <div class="stat-row">
                    <span>ENTRY:</span>
                    <span id="entryPrice">---</span>
                </div>
                <div class="stat-row">
                    <span>PNL:</span>
                    <span id="pnl">0.00%</span>
                </div>
            </div>
        </div>

        <!-- LOGS -->
        <div class="panel">
            <div class="panel-title">
                3. NEURAL LOG
                <div class="ai-pulse" id="aiBrain"></div>
            </div>
            <div class="terminal" id="console">
                <div class="log-entry">> SYSTEM INITIALIZED</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- RPC LIST ---
    const RPC_NODES = [
        'https://mainnet.helius-rpc.com/?api-key=15858025-06c8-4e3e-90f0-322122606320', 
        'https://solana-mainnet.g.alchemy.com/v2/demo', 
        'https://api.mainnet-beta.solana.com',
        'https://solana-rpc.publicnode.com',
    ];
    
    let connection = null;

    window.onload = async () => {
        log('AUTO-CONNECTING TO SERVER...', 'sys');
        for (let rpc of RPC_NODES) {
            try {
                // Pre-check fetch
                await fetch(rpc, { method: 'POST', body: JSON.stringify({jsonrpc:"2.0",id:1,method:"getHealth"}), headers: {"Content-Type": "application/json"} });
                
                const conn = new solanaWeb3.Connection(rpc, 'confirmed');
                await conn.getLatestBlockhash();
                connection = conn;
                
                const el = document.getElementById('rpcStatus');
                el.innerText = `CONNECTED: ${new URL(rpc).hostname}`;
                el.classList.add('connected');
                log(`SERVER CONNECTED: ${new URL(rpc).hostname}`, 'sys');
                break;
            } catch (e) {
                console.log(`Failed ${rpc}`);
            }
        }
        if(!connection) log('CRITICAL: BROWSER BLOCKING RPC. TRY VPN OR DIFFERENT BROWSER.', 'err');
    };

    // --- BASE58 DECODER (STANDALONE) ---
    const B58_ALPHABET = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
    function from_b58(S) {
        var d=[],b=[],i,j,c,n;
        for(i in S){
            j=0,c=B58_ALPHABET.indexOf(S[i]);
            if(c<0)return undefined;
            c||b.length^i?i:b.push(0);
            while(j in d||c){
                n=d[j]; n=n?n*58+c:c; c=n>>8; d[j]=n%256; j++;
            }
        }
        while(j--)b.push(d[j]);
        return new Uint8Array(b);
    }

    // --- STATE ---
    let state = {
        running: false,
        wallet: null,
        keypair: null,
        balance: 0,
        holdingToken: false,
        entryPrice: 0,
    };
    
    // --- AUTHENTICATION ---
    function generateWallet() {
        const kp = solanaWeb3.Keypair.generate();
        document.getElementById('privKey').value = JSON.stringify(Array.from(kp.secretKey));
        log('NEW KEY GENERATED. CLICK LOGIN TO ACCESS.', 'sys');
    }

    function loginWallet() {
        const raw = document.getElementById('privKey').value.trim();
        if(!raw) return log('ENTER PRIVATE KEY', 'err');

        try {
            let secret;
            if(raw.startsWith('[') && raw.endsWith(']')) {
                // JSON Format
                secret = Uint8Array.from(JSON.parse(raw));
            } else {
                // Base58 Format (Phantom)
                secret = from_b58(raw);
                if(!secret) throw new Error("Invalid Base58");
            }

            state.keypair = solanaWeb3.Keypair.fromSecretKey(secret);
            state.wallet = state.keypair.publicKey.toBase58();
            
            // Switch UI
            document.getElementById('authPanel').classList.add('hidden');
            document.getElementById('walletPanel').classList.remove('hidden');
            document.getElementById('pubKey').innerText = state.wallet;
            
            // QR
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: state.wallet,
                width: 100, height: 100,
                colorDark : "#000000", colorLight : "#ffffff"
            });

            refreshBalance();
            log('LOGIN SUCCESSFUL.', 'sys');

        } catch(e) {
            log('LOGIN FAILED: KEY FORMAT NOT RECOGNIZED', 'err');
        }
    }

    function logoutWallet() {
        if(state.running) toggleAI();
        state.wallet = null;
        state.keypair = null;
        state.balance = 0;
        document.getElementById('walletPanel').classList.add('hidden');
        document.getElementById('authPanel').classList.remove('hidden');
        document.getElementById('privKey').value = ""; 
        log('LOGGED OUT. SESSION WIPED.', 'sys');
    }

    async function refreshBalance() {
        if(!state.wallet || !connection) return;
        try {
            const bal = await connection.getBalance(state.keypair.publicKey);
            state.balance = bal / 1e9;
            document.getElementById('balance').innerText = state.balance.toFixed(4);
        } catch(e) { log('BALANCE ERROR', 'err'); }
    }

    function setMaxSol() {
        if(state.balance > 0.01) {
            document.getElementById('capital').value = (state.balance - 0.005).toFixed(4);
        } else {
            log('INSUFFICIENT FUNDS FOR MAX', 'err');
        }
    }

    // --- AI LOOP ---
    async function toggleAI() {
        const btn = document.getElementById('startBtn');
        if(state.running) {
            state.running = false;
            btn.innerText = "INITIALIZE AGENT";
            btn.classList.remove('ai-btn');
            document.getElementById('sysStatus').innerText = "OFFLINE";
            log('AGENT STOPPED', 'sys');
            return;
        }

        if(!state.wallet) return log('LOGIN REQUIRED', 'err');
        const ca = document.getElementById('tokenCA').value;
        const apiKey = document.getElementById('apiKey').value;
        if(!ca || !apiKey) return log('MISSING CONFIG DATA', 'err');

        state.running = true;
        btn.innerText = "STOP AGENT";
        btn.classList.add('ai-btn');
        document.getElementById('sysStatus').innerText = "ONLINE";
        document.getElementById('sysStatus').style.color = "var(--ai)";
        
        log(`FETCHING TOKEN INFO...`, 'sys');
        runAiCycle();
    }

    async function runAiCycle() {
        if(!state.running) return;
        document.getElementById('aiBrain').classList.add('thinking');
        
        try {
            // 1. FETCH FULL DATA
            const ca = document.getElementById('tokenCA').value;
            const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${ca}`);
            const data = await res.json();
            
            if(!data.pairs || !data.pairs[0]) throw new Error("TOKEN DATA NOT FOUND");
            const pair = data.pairs[0];
            const price = parseFloat(pair.priceUsd);

            // Update UI
            if(state.holdingToken) {
                const pnl = ((price - state.entryPrice) / state.entryPrice) * 100;
                document.getElementById('pnl').innerText = pnl.toFixed(2) + "%";
                document.getElementById('pnl').style.color = pnl >= 0 ? 'var(--accent)' : 'var(--danger)';
            }

            // 2. ASK AI
            const decision = await consultOracle(pair, price);
            
            // 3. EXECUTE
            await executeDecision(decision, pair);

        } catch(e) {
            log(`LOOP ERROR: ${e.message}`, 'err');
        }

        document.getElementById('aiBrain').classList.remove('thinking');
        if(state.running) setTimeout(runAiCycle, 3000); 
    }

    async function consultOracle(pair, currentPrice) {
        const apiKey = document.getElementById('apiKey').value;
        const modelId = document.getElementById('modelId').value;
        
        const context = {
            user_status: state.holdingToken ? "HOLDING_TOKEN" : "LIQUID_SOL (NO TRADES OPEN)",
            entry_price: state.entryPrice,
            current_price: currentPrice,
            token_info: {
                name: pair.baseToken.name,
                liquidity: pair.liquidity?.usd,
                mcap: pair.marketCap
            },
            metrics: {
                m5: pair.priceChange.m5,
                h1: pair.priceChange.h1,
                vol: pair.volume.h24
            }
        };

        const prompt = `
            ACT AS A TRADING AI. SYSTEM RULE: MUST MAINTAIN MINIMUM 1 OPEN TRADE.
            DATA: ${JSON.stringify(context)}
            
            LOGIC RULES:
            1. IF STATUS IS "LIQUID_SOL": YOU MUST "BUY". WE NEED A TRADE OPEN. DO NOT HOLD CASH.
            2. IF STATUS IS "HOLDING_TOKEN": YOU CAN "HOLD" (KEEP TRADE OPEN) OR "SELL" (TAKE PROFIT/LOSS).
            
            RETURN JSON ONLY: { "action": "BUY" | "SELL" | "HOLD", "reason": "full reasoning string" }
        `;

        const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: modelId,
                messages: [{ role: "user", content: prompt }]
            })
        });

        const json = await res.json();
        const content = json.choices[0].message.content;
        const match = content.match(/\{[\s\S]*\}/); 
        return JSON.parse(match[0]);
    }

    async function executeDecision(decision, pair) {
        const action = decision.action.toUpperCase();
        log(`AI: [${action}] ${decision.reason}`, 'ai');

        if(action === 'HOLD') return;

        if(action === 'BUY' && !state.holdingToken) {
            log('OPENING REQUIRED TRADE...', 'trade');
            const amount = parseFloat(document.getElementById('capital').value);
            const tx = await jupiterSwap('buy', amount, pair.baseToken.address);
            if(tx) {
                state.holdingToken = true;
                state.entryPrice = parseFloat(pair.priceUsd);
                document.getElementById('agentState').innerText = "HOLDING";
                document.getElementById('agentState').style.color = "var(--accent)";
                document.getElementById('entryPrice').innerText = "$" + state.entryPrice;
            }
        }

        if(action === 'SELL' && state.holdingToken) {
            log('CLOSING TRADE...', 'trade');
            const accounts = await connection.getParsedTokenAccountsByOwner(state.keypair.publicKey, { mint: new solanaWeb3.PublicKey(pair.baseToken.address) });
            if(accounts.value.length > 0) {
                const qty = accounts.value[0].account.data.parsed.info.tokenAmount.amount;
                const tx = await jupiterSwap('sell', qty, pair.baseToken.address);
                if(tx) {
                    state.holdingToken = false;
                    state.entryPrice = 0;
                    document.getElementById('agentState').innerText = "LIQUID (SOL)";
                    document.getElementById('agentState').style.color = "var(--ai)";
                    refreshBalance();
                }
            } else {
                state.holdingToken = false;
            }
        }
    }

    async function jupiterSwap(type, amount, tokenMint) {
        try {
            const input = type === 'buy' ? 'So11111111111111111111111111111111111111112' : tokenMint;
            const output = type === 'buy' ? tokenMint : 'So11111111111111111111111111111111111111112';
            const amtParam = type === 'buy' ? Math.floor(amount * 1e9) : amount;

            const quoteUrl = `https://quote-api.jup.ag/v6/quote?inputMint=${input}&outputMint=${output}&amount=${amtParam}&slippageBps=100`;
            const quoteRes = await fetch(quoteUrl);
            
            if (!quoteRes.ok) throw new Error("JUP API BLOCKED");
            
            const quote = await quoteRes.json();
            if(quote.error) throw new Error(quote.error);

            const swap = await (await fetch('https://quote-api.jup.ag/v6/swap', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    quoteResponse: quote,
                    userPublicKey: state.wallet,
                    wrapAndUnwrapSol: true
                })
            })).json();

            const tx = solanaWeb3.VersionedTransaction.deserialize(Uint8Array.from(atob(swap.swapTransaction), c => c.charCodeAt(0)));
            tx.sign([state.keypair]);
            const txid = await connection.sendTransaction(tx);
            log(`TX SUCCESS: ${txid.slice(0,8)}...`, 'trade');
            return true;
        } catch(e) {
            log(`SWAP FAILED: ${e.message}`, 'err');
            return false;
        }
    }

    function log(msg, type='sys') {
        const div = document.createElement('div');
        div.className = `log-entry ${type}`;
        div.innerText = `> ${msg}`;
        const con = document.getElementById('console');
        con.appendChild(div);
        con.scrollTop = con.scrollHeight;
    }
</script>

</body>
</html>
