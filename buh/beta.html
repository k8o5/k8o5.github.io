<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOL-AI-TERMINAL</title>
    
    <!-- Generated Favicon (Green Dot) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%2300FF00%22/></svg>">

    <!-- Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    
    <style>
        :root {
            --primary: #00FF00;
            --bg: #000000;
            --panel: #050505;
            --border: #004400;
            --text-dim: #666;
            --error: #ff3333;
        }

        body {
            background-color: var(--bg);
            color: var(--primary);
            font-family: 'Courier New', Courier, monospace;
            margin: 20px;
            font-size: 14px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid var(--primary);
            padding: 2px;
        }

        .header {
            border-bottom: 1px solid var(--primary);
            padding: 15px;
            background: #001100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 20px; letter-spacing: 2px; }
        h3 { 
            background-color: var(--primary); 
            color: var(--bg); 
            padding: 5px 10px; 
            margin: 0; 
            font-size: 14px;
            letter-spacing: 1px;
        }

        .section {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .input-group { margin-bottom: 10px; }
        
        label { 
            display: block; 
            margin-bottom: 5px; 
            color: var(--text-dim); 
            font-size: 12px;
        }

        input, select, textarea { 
            width: 100%; 
            background: #111; 
            border: 1px solid var(--border); 
            color: #fff; 
            padding: 8px; 
            box-sizing: border-box;
            font-family: inherit;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        a { color: var(--primary); text-decoration: none; border-bottom: 1px dotted var(--primary); }

        .btn-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            padding: 15px 20px;
            font-weight: bold;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            flex: 1;
            transition: all 0.2s;
        }

        .btn-connect {
            background: var(--primary);
            color: var(--bg);
            border: none;
        }

        .btn-start {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .btn-start:hover { background: #002200; }

        .btn-stop {
            background: #330000;
            color: var(--error);
            border: 2px solid var(--error);
        }
        .btn-stop:hover { background: #550000; }

        .terminal {
            height: 350px;
            overflow-y: scroll;
            background: #000;
            padding: 10px;
            border-top: 1px solid var(--primary);
            font-size: 12px;
            line-height: 1.4;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #003300; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .status-badge {
            font-size: 10px;
            padding: 2px 6px;
            border: 1px solid var(--primary);
        }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- HEADER -->
        <div class="header">
            <h1>SOL // OPENROUTER // TERMINAL</h1>
            <div id="system-status" class="status-badge">SYSTEM STANDBY</div>
        </div>

        <!-- 1. CONFIGURATION -->
        <div class="section">
            <h3>[1] CONFIGURATION</h3>
            <div style="display: flex; gap: 20px; margin-top: 10px;">
                <div style="flex: 1;">
                    <label>OPENROUTER API KEY (<a href="https://openrouter.ai/keys" target="_blank">GET KEY</a>)</label>
                    <input type="password" id="or-api-key" placeholder="sk-or-...">
                </div>
                <div style="flex: 1;">
                    <label>AI MODEL ID (<a href="https://openrouter.ai/models" target="_blank">LIST</a>)</label>
                    <input type="text" id="ai-model" value="meta-llama/llama-3-8b-instruct:free">
                </div>
            </div>
            <div style="margin-top: 10px;">
                <label>RPC ENDPOINT</label>
                <input type="text" id="sol-rpc" value="https://api.mainnet-beta.solana.com">
            </div>
        </div>

        <!-- 2. WALLET -->
        <div class="section">
            <h3>[2] UPLINK</h3>
            <div style="margin-top: 10px;">
                <button id="btn-connect" class="btn-connect" onclick="connectWallet()">CONNECT WALLET</button>
                <div id="wallet-details" style="display:none; margin-top: 10px;">
                    <div id="wallet-address" style="color: var(--primary);">ADDRESS: --</div>
                    <div id="wallet-balance" style="color: var(--text-dim);">BALANCE: --</div>
                </div>
            </div>
        </div>

        <!-- 3. STRATEGY -->
        <div class="section">
            <h3>[3] STRATEGY PARAMETERS</h3>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex: 2;">
                    <label>TARGET CA (CONTRACT ADDRESS)</label>
                    <input type="text" id="target-token" placeholder="So111...">
                </div>
                <div style="flex: 1;">
                    <label>AMOUNT (SOL)</label>
                    <input type="number" id="trade-amount" value="0.01" step="0.001">
                </div>
                <div style="flex: 1;">
                    <label>LOOP INTERVAL (SECONDS)</label>
                    <input type="number" id="loop-interval" value="30" min="5">
                </div>
            </div>
            <div style="margin-top: 10px;">
                <label>CONTEXT INSTRUCTION</label>
                <textarea id="market-context" rows="2" placeholder="Describe logic: Buy if RSI < 30..."></textarea>
            </div>
        </div>

        <!-- 4. EXECUTION -->
        <div class="section">
            <h3>[4] OPERATIONS</h3>
            <div class="btn-container">
                <button id="btn-start" class="btn-start" onclick="startAutoPilot()">[ START AUTO-PILOT ]</button>
                <button id="btn-stop" class="btn-stop" onclick="stopAutoPilot()">[ TERMINATE ]</button>
            </div>
        </div>

        <!-- LOGS -->
        <div class="terminal" id="console-output">
            <div>> System initialized.</div>
            <div>> Awaiting configuration.</div>
        </div>

    </div>

    <script>
        // --- CORE VARIABLES ---
        let walletAddress = null;
        let connection = null;
        let isRunning = false;
        let loopTimer = null;
        const terminal = document.getElementById('console-output');

        // --- UTILITIES ---
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            
            let color = '#ccc';
            let prefix = 'INFO';

            if (type === 'error') { color = '#ff3333'; prefix = 'ERR'; }
            if (type === 'success') { color = '#00FF00'; prefix = 'OK'; }
            if (type === 'warn') { color = 'orange'; prefix = 'WARN'; }
            if (type === 'sys') { color = '#008800'; prefix = 'SYS'; }

            div.innerHTML = `<span style="color: #444;">[${time}]</span> <span style="color:${color}; font-weight:bold;">[${prefix}]</span> ${msg}`;
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function setStatus(status) {
            const el = document.getElementById('system-status');
            el.innerText = status;
            el.style.color = status.includes('RUNNING') ? '#00FF00' : '#666';
            el.style.borderColor = status.includes('RUNNING') ? '#00FF00' : '#666';
        }

        // --- WALLET ---
        async function connectWallet() {
            if ("phantom" in window) {
                const provider = window.phantom?.solana;
                if (provider?.isPhantom) {
                    try {
                        const resp = await provider.connect();
                        walletAddress = resp.publicKey.toString();
                        
                        document.getElementById('btn-connect').style.display = 'none';
                        document.getElementById('wallet-details').style.display = 'block';
                        document.getElementById('wallet-address').innerText = `ADDRESS: ${walletAddress}`;
                        
                        log(`Uplink established: ${walletAddress}`, 'success');
                        
                        const rpc = document.getElementById('sol-rpc').value;
                        connection = new solanaWeb3.Connection(rpc, 'confirmed');
                        updateBalance();

                    } catch (err) {
                        log(`Connection refused: ${err.message}`, 'error');
                    }
                }
            } else {
                window.open("https://phantom.app/", "_blank");
                log("Phantom Wallet driver not found.", 'error');
            }
        }

        async function updateBalance() {
            if (!walletAddress || !connection) return;
            try {
                const pubKey = new solanaWeb3.PublicKey(walletAddress);
                const balance = await connection.getBalance(pubKey);
                const sol = (balance / solanaWeb3.LAMPORTS_PER_SOL).toFixed(4);
                document.getElementById('wallet-balance').innerText = `BALANCE: ${sol} SOL`;
            } catch (err) {
                log(`Balance check failed: ${err.message}`, 'error');
            }
        }

        // --- AI ENGINE ---
        async function fetchAIAnalysis() {
            const apiKey = document.getElementById('or-api-key').value;
            const modelID = document.getElementById('ai-model').value; 
            const token = document.getElementById('target-token').value;
            const context = document.getElementById('market-context').value;
            const amount = document.getElementById('trade-amount').value;

            if (!apiKey) throw new Error("API Key missing");
            if (!token) throw new Error("Target Token CA missing");

            const prompt = `
            Task: Analyze trade for Token: ${token}. Amount: ${amount} SOL.
            Strategy: ${context}.
            Current System Time: ${new Date().toISOString()}.
            
            Return strictly valid JSON (no markdown):
            {
                "decision": "BUY" | "SELL" | "HOLD",
                "confidence": number (0-100),
                "reasoning": "Brief technical justification"
            }`;

            log(`Querying Model [${modelID}]...`, 'sys');

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href, 
                        "X-Title": "SolanaTerminal"
                    },
                    body: JSON.stringify({
                        "model": modelID, 
                        "messages": [
                            {"role": "system", "content": "You are a ruthless high-frequency trading algorithm. Output only JSON."},
                            {"role": "user", "content": prompt}
                        ],
                        "temperature": 0.7
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || response.statusText);
                }

                const data = await response.json();
                let raw = data.choices[0].message.content;
                // Sanitize markdown
                raw = raw.replace(/```json/g, '').replace(/```/g, '').trim();
                
                return JSON.parse(raw);

            } catch (error) {
                throw error;
            }
        }

        // --- MAIN LOOP ---
        async function startAutoPilot() {
            if (isRunning) return;
            if (!walletAddress) {
                log("Cannot start: Wallet disconnected.", 'error');
                return;
            }

            isRunning = true;
            setStatus('SYSTEM RUNNING');
            log("AUTO-PILOT SEQUENCE INITIATED.", 'success');
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-start').style.opacity = "0.5";
            
            runCycle();
        }

        function stopAutoPilot() {
            if (!isRunning) return;
            isRunning = false;
            clearTimeout(loopTimer);
            setStatus('SYSTEM HALTED');
            log("AUTO-PILOT TERMINATED BY USER.", 'warn');
            document.getElementById('btn-start').disabled = false;
            document.getElementById('btn-start').style.opacity = "1";
        }

        async function runCycle() {
            if (!isRunning) return;

            const intervalSeconds = document.getElementById('loop-interval').value || 30;
            const delayMs = intervalSeconds * 1000;

            try {
                // 1. Get Analysis
                const result = await fetchAIAnalysis();

                // 2. Normalize Confidence (0.85 -> 85)
                if (result.confidence <= 1) {
                    result.confidence = result.confidence * 100;
                }

                // 3. Log Result
                log(`ANALYSIS: ${result.decision} | CONFIDENCE: ${result.confidence}%`);
                log(`REASON: ${result.reasoning}`);

                // 4. Action
                if (result.decision === "BUY" && result.confidence >= 75) {
                    log(">>> EXECUTING BUY ORDER <<<", 'success');
                    await executeTrade();
                } else if (result.decision === "SELL" && result.confidence >= 75) {
                    log(">>> SELL SIGNAL DETECTED (Manual Confirm Required) <<<", 'warn');
                } else {
                    log("Holding position. Market conditions unmet.", 'sys');
                }

            } catch (err) {
                log(`Cycle Error: ${err.message}`, 'error');
            }

            // 5. Schedule Next Loop
            if (isRunning) {
                log(`Sleeping for ${intervalSeconds}s...`, 'sys');
                loopTimer = setTimeout(runCycle, delayMs);
            }
        }

        // --- TRANSACTION ---
        async function executeTrade() {
            try {
                const amount = document.getElementById('trade-amount').value;
                const provider = window.phantom?.solana;
                const pubKey = new solanaWeb3.PublicKey(walletAddress);
                
                // DEMO TRANSACTION (Send to Self)
                // In production, swap this for Jupiter/Raydium instruction
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: pubKey,
                        toPubkey: pubKey, 
                        lamports: solanaWeb3.LAMPORTS_PER_SOL * (amount / 1000) 
                    })
                );

                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = pubKey;

                log("Requesting Signature...", 'sys');
                const { signature } = await provider.signAndSendTransaction(transaction);
                
                log(`TX CONFIRMED: ${signature.slice(0,10)}...`, 'success');
                updateBalance();

            } catch (err) {
                log(`TX FAILED: ${err.message}`, 'error');
            }
        }
    </script>
</body>
</html>
