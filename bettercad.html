<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BetterCAD</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg-primary: #1a1a2e;
    --bg-secondary: #16213e;
    --bg-tertiary: #0f3460;
    --bg-panel: #1a1a2eee;
    --accent: #e94560;
    --accent2: #0ea5e9;
    --accent3: #10b981;
    --text: #e2e8f0;
    --text-dim: #94a3b8;
    --text-bright: #f8fafc;
    --border: #334155;
    --hover: #1e293b;
    --selected: #e9456022;
    --selected-border: #e94560;
    --success: #10b981;
    --warning: #f59e0b;
  }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg-primary);
    color: var(--text);
    overflow: hidden;
    height: 100vh;
    user-select: none;
  }

  /* Top Toolbar */
  #toolbar {
    display: flex;
    align-items: center;
    height: 48px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 0 8px;
    gap: 2px;
    z-index: 100;
  }
  .toolbar-brand {
    font-weight: 700;
    font-size: 15px;
    color: var(--accent);
    padding: 0 12px 0 8px;
    margin-right: 8px;
    border-right: 1px solid var(--border);
    letter-spacing: -0.5px;
  }
  .toolbar-group {
    display: flex;
    align-items: center;
    gap: 1px;
    padding: 0 4px;
    border-right: 1px solid var(--border);
    margin-right: 4px;
  }
  .toolbar-group:last-child { border-right: none; }
  .tool-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 38px;
    border: 1px solid transparent;
    border-radius: 6px;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 9px;
    gap: 2px;
    transition: all 0.15s;
    position: relative;
  }
  .tool-btn svg { width: 18px; height: 18px; }
  .tool-btn:hover { background: var(--hover); color: var(--text); border-color: var(--border); }
  .tool-btn.active { background: var(--selected); color: var(--accent); border-color: var(--selected-border); }
  .tool-btn .shortcut {
    position: absolute;
    bottom: -1px;
    right: 2px;
    font-size: 7px;
    color: var(--text-dim);
    opacity: 0.5;
  }

  /* Main Layout */
  #main {
    display: flex;
    height: calc(100vh - 48px - 28px);
  }

  /* Left Panel - Feature Tree */
  #left-panel {
    width: 240px;
    min-width: 200px;
    background: var(--bg-panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
    background: var(--bg-secondary);
  }
  .panel-header button {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 14px;
    padding: 2px;
    border-radius: 3px;
  }
  .panel-header button:hover { color: var(--text); background: var(--hover); }

  #feature-tree {
    flex: 1;
    overflow-y: auto;
    padding: 4px 0;
  }
  .tree-item {
    display: flex;
    align-items: center;
    padding: 5px 12px;
    gap: 8px;
    cursor: pointer;
    font-size: 12px;
    border-left: 2px solid transparent;
    transition: all 0.1s;
  }
  .tree-item:hover { background: var(--hover); }
  .tree-item.selected { background: var(--selected); border-left-color: var(--accent); color: var(--text-bright); }
  .tree-item.suppressed { opacity: 0.4; text-decoration: line-through; }
  .tree-item .icon {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
  }
  .tree-item .icon.sketch { color: #f59e0b; }
  .tree-item .icon.extrude { color: #0ea5e9; }
  .tree-item .icon.fillet { color: #a78bfa; }
  .tree-item .icon.revolve { color: #f472b6; }
  .tree-item .icon.boolean { color: #10b981; }
  .tree-item .icon.chamfer { color: #fb923c; }
  .tree-item .icon.pattern { color: #67e8f9; }
  .tree-item .icon.shell { color: #86efac; }
  .tree-item .name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tree-item .visibility {
    opacity: 0;
    cursor: pointer;
    font-size: 11px;
    color: var(--text-dim);
    padding: 2px;
  }
  .tree-item:hover .visibility { opacity: 1; }
  .tree-item .visibility:hover { color: var(--text); }
  .tree-divider {
    height: 1px;
    background: var(--border);
    margin: 4px 12px;
  }
  .tree-section {
    padding: 6px 12px 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
  }

  /* Viewport */
  #viewport-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: var(--bg-primary);
  }
  #viewport {
    width: 100%;
    height: 100%;
    cursor: crosshair;
  }

  /* View Cube */
  #viewcube {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 90px;
    height: 90px;
    perspective: 300px;
    z-index: 10;
  }
  #cube {
    width: 70px;
    height: 70px;
    position: relative;
    transform-style: preserve-3d;
    transform: rotateX(-25deg) rotateY(45deg);
    margin: 10px auto;
    transition: transform 0.4s ease;
    cursor: pointer;
  }
  .cube-face {
    position: absolute;
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    font-weight: 600;
    color: var(--text-dim);
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    opacity: 0.85;
    transition: all 0.2s;
  }
  .cube-face:hover { background: var(--accent); color: white; opacity: 1; }
  .cube-front  { transform: translateZ(35px); }
  .cube-back   { transform: rotateY(180deg) translateZ(35px); }
  .cube-right  { transform: rotateY(90deg) translateZ(35px); }
  .cube-left   { transform: rotateY(-90deg) translateZ(35px); }
  .cube-top    { transform: rotateX(90deg) translateZ(35px); }
  .cube-bottom { transform: rotateX(-90deg) translateZ(35px); }

  /* Axis indicator */
  #axis-indicator {
    position: absolute;
    bottom: 16px;
    left: 16px;
    z-index: 10;
  }

  /* Right Panel - Properties */
  #right-panel {
    width: 280px;
    min-width: 240px;
    background: var(--bg-panel);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .prop-section {
    border-bottom: 1px solid var(--border);
  }
  .prop-section-header {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    color: var(--text-dim);
    gap: 6px;
  }
  .prop-section-header:hover { color: var(--text); }
  .prop-section-header .arrow { font-size: 8px; transition: transform 0.2s; }
  .prop-section-header .arrow.open { transform: rotate(90deg); }
  .prop-section-body { padding: 4px 12px 10px; }
  .prop-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 12px;
  }
  .prop-label { color: var(--text-dim); font-size: 11px; }
  .prop-input {
    width: 100px;
    padding: 4px 8px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-size: 11px;
    text-align: right;
    outline: none;
    transition: border-color 0.2s;
  }
  .prop-input:focus { border-color: var(--accent2); }
  .prop-input-unit {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .prop-unit { font-size: 10px; color: var(--text-dim); }
  .prop-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 0;
    font-size: 12px;
    cursor: pointer;
  }
  .prop-checkbox input { accent-color: var(--accent); }
  .prop-select {
    padding: 4px 8px;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-size: 11px;
    outline: none;
    cursor: pointer;
  }
  .prop-color-row {
    display: flex;
    gap: 6px;
    padding: 4px 0;
  }
  .color-swatch {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.15s;
  }
  .color-swatch:hover { transform: scale(1.15); }
  .color-swatch.active { border-color: white; }

  /* Timeline */
  #timeline {
    height: 28px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 8px;
    font-size: 11px;
    color: var(--text-dim);
  }
  .timeline-marker {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent2);
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
  }
  .timeline-marker:hover { transform: scale(1.4); background: var(--accent); }
  .timeline-marker.current { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
  .timeline-line {
    flex: 1;
    height: 2px;
    background: var(--border);
    border-radius: 1px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 4px;
  }
  .timeline-progress {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: var(--accent);
    border-radius: 1px;
    transition: width 0.3s;
  }

  /* Context Menu */
  #context-menu {
    display: none;
    position: fixed;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px;
    min-width: 180px;
    z-index: 1000;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  #context-menu.show { display: block; }
  .ctx-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 12px;
    font-size: 12px;
    cursor: pointer;
    border-radius: 4px;
    gap: 12px;
  }
  .ctx-item:hover { background: var(--accent); color: white; }
  .ctx-item .ctx-shortcut { font-size: 10px; color: var(--text-dim); }
  .ctx-item:hover .ctx-shortcut { color: rgba(255,255,255,0.7); }
  .ctx-divider { height: 1px; background: var(--border); margin: 4px 8px; }

  /* Command Palette */
  #command-palette {
    display: none;
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    width: 500px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    z-index: 2000;
    box-shadow: 0 16px 64px rgba(0,0,0,0.5);
    overflow: hidden;
  }
  #command-palette.show { display: block; }
  #command-palette input {
    width: 100%;
    padding: 14px 16px;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    font-size: 14px;
    outline: none;
  }
  #command-results {
    max-height: 300px;
    overflow-y: auto;
    padding: 4px;
  }
  .cmd-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    gap: 10px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 13px;
  }
  .cmd-item:hover, .cmd-item.highlighted { background: var(--hover); }
  .cmd-item .cmd-icon { width: 24px; text-align: center; font-size: 14px; }
  .cmd-item .cmd-shortcut { margin-left: auto; font-size: 11px; color: var(--text-dim); }

  /* Overlay backdrop */
  #overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: 1999;
  }
  #overlay.show { display: block; }

  /* Sketch Mode Banner */
  #sketch-banner {
    display: none;
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--warning);
    color: #000;
    padding: 6px 20px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 50;
    gap: 12px;
    align-items: center;
  }
  #sketch-banner.show { display: flex; }
  #sketch-banner button {
    background: rgba(0,0,0,0.2);
    border: none;
    color: #000;
    padding: 3px 10px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
  }

  /* Dimension tooltip */
  .dimension-label {
    position: absolute;
    background: var(--bg-secondary);
    border: 1px solid var(--accent2);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    color: var(--accent2);
    pointer-events: none;
    white-space: nowrap;
  }

  /* Notification toast */
  #toast {
    position: fixed;
    bottom: 48px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 8px 20px;
    border-radius: 8px;
    font-size: 12px;
    z-index: 3000;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* Grid overlay on viewport */
  .grid-info {
    position: absolute;
    bottom: 16px;
    right: 16px;
    font-size: 10px;
    color: var(--text-dim);
    z-index: 10;
    text-align: right;
    line-height: 1.6;
  }

  /* Snap indicator */
  .snap-indicator {
    position: absolute;
    width: 12px;
    height: 12px;
    border: 2px solid var(--accent3);
    border-radius: 50%;
    pointer-events: none;
    z-index: 20;
    display: none;
    transform: translate(-50%, -50%);
  }
  .snap-indicator.show { display: block; }
  .snap-indicator.midpoint { border-radius: 0; transform: translate(-50%, -50%) rotate(45deg); }
  .snap-indicator.endpoint { border-radius: 2px; }

  /* Selection info bar */
  .selection-info {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 4px 16px;
    border-radius: 16px;
    font-size: 11px;
    color: var(--text-dim);
    z-index: 10;
    white-space: nowrap;
  }

  /* Material preview */
  .material-preview {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    border: 2px solid var(--border);
    cursor: pointer;
    transition: all 0.15s;
  }
  .material-preview:hover { border-color: var(--accent2); transform: scale(1.05); }
  .material-preview.active { border-color: var(--accent); }
</style>
</head>
<body>

<!-- Toolbar -->
<div id="toolbar">
  <div class="toolbar-brand">‚¨° BetterCAD</div>

  <div class="toolbar-group" id="file-tools">
    <button class="tool-btn" onclick="showToast('New project created')" title="New">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      <span style="font-size:8px">New</span>
    </button>
    <button class="tool-btn" title="Open">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      <span style="font-size:8px">Open</span>
    </button>
    <button class="tool-btn" onclick="showToast('Project saved')" title="Save">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
      <span style="font-size:8px">Save</span>
    </button>
  </div>

  <div class="toolbar-group" id="sketch-tools">
    <button class="tool-btn" id="btn-sketch" onclick="toggleSketchMode()" title="Create Sketch (S)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="12" y1="3" x2="12" y2="21"/></svg>
      <span style="font-size:8px">Sketch</span>
      <span class="shortcut">S</span>
    </button>
    <button class="tool-btn" id="btn-line" onclick="setTool('line')" title="Line (L)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="19" x2="19" y2="5"/><circle cx="5" cy="19" r="2"/><circle cx="19" cy="5" r="2"/></svg>
      <span style="font-size:8px">Line</span>
      <span class="shortcut">L</span>
    </button>
    <button class="tool-btn" id="btn-rect" onclick="setTool('rect')" title="Rectangle (R)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="6" width="16" height="12" rx="1"/></svg>
      <span style="font-size:8px">Rect</span>
      <span class="shortcut">R</span>
    </button>
    <button class="tool-btn" id="btn-circle" onclick="setTool('circle')" title="Circle (C)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="1"/></svg>
      <span style="font-size:8px">Circle</span>
      <span class="shortcut">C</span>
    </button>
    <button class="tool-btn" id="btn-arc" onclick="setTool('arc')" title="Arc (A)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 19 A 14 14 0 0 1 19 5"/><circle cx="5" cy="19" r="1.5"/><circle cx="19" cy="5" r="1.5"/></svg>
      <span style="font-size:8px">Arc</span>
      <span class="shortcut">A</span>
    </button>
    <button class="tool-btn" id="btn-spline" onclick="setTool('spline')" title="Spline">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 18 C 8 6, 16 22, 20 8"/></svg>
      <span style="font-size:8px">Spline</span>
    </button>
  </div>

  <div class="toolbar-group" id="solid-tools">
    <button class="tool-btn" id="btn-extrude" onclick="addFeature('extrude')" title="Extrude (E)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v12M5 10l7 7 7-7"/><rect x="4" y="17" width="16" height="4" rx="1"/></svg>
      <span style="font-size:8px">Extrude</span>
      <span class="shortcut">E</span>
    </button>
    <button class="tool-btn" id="btn-revolve" onclick="addFeature('revolve')" title="Revolve">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3c5 0 9 4 9 9s-4 9-9 9"/><path d="M12 3v18"/><path d="M12 7c2.8 0 5 2.2 5 5s-2.2 5-5 5"/></svg>
      <span style="font-size:8px">Revolve</span>
    </button>
    <button class="tool-btn" id="btn-fillet" onclick="addFeature('fillet')" title="Fillet (F)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20 L4 10 Q4 4 10 4 L20 4"/></svg>
      <span style="font-size:8px">Fillet</span>
      <span class="shortcut">F</span>
    </button>
    <button class="tool-btn" id="btn-chamfer" onclick="addFeature('chamfer')" title="Chamfer">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20 L4 10 L10 4 L20 4"/></svg>
      <span style="font-size:8px">Chamfer</span>
    </button>
    <button class="tool-btn" id="btn-shell" onclick="addFeature('shell')" title="Shell">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><rect x="6" y="6" width="12" height="12" rx="1" stroke-dasharray="3 2"/></svg>
      <span style="font-size:8px">Shell</span>
    </button>
  </div>

  <div class="toolbar-group" id="boolean-tools">
    <button class="tool-btn" onclick="addFeature('union')" title="Union">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="6"/><circle cx="15" cy="12" r="6"/></svg>
      <span style="font-size:8px">Union</span>
    </button>
    <button class="tool-btn" onclick="addFeature('subtract')" title="Subtract">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="6"/><circle cx="15" cy="12" r="6" stroke-dasharray="3 2"/></svg>
      <span style="font-size:8px">Cut</span>
    </button>
    <button class="tool-btn" onclick="addFeature('intersect')" title="Intersect">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="6" stroke-dasharray="3 2"/><circle cx="15" cy="12" r="6" stroke-dasharray="3 2"/><path d="M12 7.5c1.5 1.2 2.5 3 2.5 4.5s-1 3.3-2.5 4.5c-1.5-1.2-2.5-3-2.5-4.5s1-3.3 2.5-4.5z" fill="currentColor" opacity="0.3"/></svg>
      <span style="font-size:8px">Intersect</span>
    </button>
  </div>

  <div class="toolbar-group" id="pattern-tools">
    <button class="tool-btn" onclick="addFeature('linear-pattern')" title="Linear Pattern">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="8" width="5" height="8" rx="1"/><rect x="9.5" y="8" width="5" height="8" rx="1" opacity="0.5"/><rect x="17" y="8" width="5" height="8" rx="1" opacity="0.3"/></svg>
      <span style="font-size:8px">Pattern</span>
    </button>
    <button class="tool-btn" onclick="addFeature('mirror')" title="Mirror">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18" stroke-dasharray="3 2"/><rect x="3" y="7" width="6" height="10" rx="1"/><rect x="15" y="7" width="6" height="10" rx="1" opacity="0.5"/></svg>
      <span style="font-size:8px">Mirror</span>
    </button>
  </div>

  <div class="toolbar-group" id="view-tools">
    <button class="tool-btn" id="btn-measure" onclick="setTool('measure')" title="Measure (M)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h4m4 0h4m4 0h4"/><path d="M6 8v8M18 8v8"/></svg>
      <span style="font-size:8px">Measure</span>
      <span class="shortcut">M</span>
    </button>
    <button class="tool-btn" id="btn-section" onclick="toggleSection()" title="Section View">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="3" x2="12" y2="21" stroke-dasharray="4 2"/><line x1="14" y1="6" x2="20" y2="12" opacity="0.3"/><line x1="14" y1="10" x2="20" y2="16" opacity="0.3"/></svg>
      <span style="font-size:8px">Section</span>
    </button>
  </div>

  <div style="flex:1"></div>

  <div class="toolbar-group">
    <button class="tool-btn" onclick="undo()" title="Undo (Ctrl+Z)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
    </button>
    <button class="tool-btn" onclick="redo()" title="Redo (Ctrl+Y)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.13-9.36L23 10"/></svg>
    </button>
  </div>
</div>

<!-- Main Layout -->
<div id="main">

  <!-- Left Panel -->
  <div id="left-panel">
    <div class="panel-header">
      <span>Feature Tree</span>
      <button onclick="showToast('Feature tree options')" title="Options">‚ãØ</button>
    </div>
    <div id="feature-tree">
      <div class="tree-section">Origin</div>
      <div class="tree-item" onclick="selectFeature(this, 'origin-xy')">
        <span class="icon" style="color:#f59e0b">‚óá</span>
        <span class="name">XY Plane</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
      <div class="tree-item" onclick="selectFeature(this, 'origin-xz')">
        <span class="icon" style="color:#0ea5e9">‚óá</span>
        <span class="name">XZ Plane</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
      <div class="tree-item" onclick="selectFeature(this, 'origin-yz')">
        <span class="icon" style="color:#10b981">‚óá</span>
        <span class="name">YZ Plane</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
      <div class="tree-divider"></div>
      <div class="tree-section">Bodies</div>
      <div class="tree-item selected" onclick="selectFeature(this, 'sketch1')">
        <span class="icon sketch">‚úé</span>
        <span class="name">Sketch 1</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
      <div class="tree-item" onclick="selectFeature(this, 'extrude1')">
        <span class="icon extrude">‚¨Ü</span>
        <span class="name">Extrude 1 ‚Äî 25mm</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
      <div class="tree-item" onclick="selectFeature(this, 'fillet1')">
        <span class="icon fillet">‚ó†</span>
        <span class="name">Fillet 1 ‚Äî R3mm</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
      <div class="tree-item" onclick="selectFeature(this, 'sketch2')">
        <span class="icon sketch">‚úé</span>
        <span class="name">Sketch 2</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
      <div class="tree-item" onclick="selectFeature(this, 'extrude2')">
        <span class="icon extrude">‚¨á</span>
        <span class="name">Cut Extrude 1 ‚Äî 10mm</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
      <div class="tree-item" onclick="selectFeature(this, 'chamfer1')">
        <span class="icon chamfer">‚¨°</span>
        <span class="name">Chamfer 1 ‚Äî 2mm</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
      <div class="tree-item" onclick="selectFeature(this, 'pattern1')">
        <span class="icon pattern">‚´∂</span>
        <span class="name">Circular Pattern ‚Äî 6x</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
      <div class="tree-item" onclick="selectFeature(this, 'shell1')">
        <span class="icon shell">‚òê</span>
        <span class="name">Shell ‚Äî 1.5mm</span>
        <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
      </div>
    </div>
  </div>

  <!-- Viewport -->
  <div id="viewport-container">
    <canvas id="viewport"></canvas>

    <!-- View Cube -->
    <div id="viewcube">
      <div id="cube">
        <div class="cube-face cube-front" onclick="setView('front')">FRONT</div>
        <div class="cube-face cube-back" onclick="setView('back')">BACK</div>
        <div class="cube-face cube-right" onclick="setView('right')">RIGHT</div>
        <div class="cube-face cube-left" onclick="setView('left')">LEFT</div>
        <div class="cube-face cube-top" onclick="setView('top')">TOP</div>
        <div class="cube-face cube-bottom" onclick="setView('bottom')">BTM</div>
      </div>
    </div>

    <!-- Axis Indicator -->
    <svg id="axis-indicator" width="60" height="60" viewBox="0 0 60 60">
      <line x1="30" y1="30" x2="55" y2="22" stroke="#e94560" stroke-width="2"/>
      <text x="57" y="22" fill="#e94560" font-size="10" font-weight="bold">X</text>
      <line x1="30" y1="30" x2="22" y2="55" stroke="#10b981" stroke-width="2"/>
      <text x="16" y="58" fill="#10b981" font-size="10" font-weight="bold">Y</text>
      <line x1="30" y1="30" x2="30" y2="5" stroke="#0ea5e9" stroke-width="2"/>
      <text x="32" y="8" fill="#0ea5e9" font-size="10" font-weight="bold">Z</text>
      <circle cx="30" cy="30" r="3" fill="#94a3b8"/>
    </svg>

    <!-- Grid Info -->
    <div class="grid-info">
      <div id="cursor-pos">X: 0.00 Y: 0.00 Z: 0.00</div>
      <div>Grid: 1mm | Snap: On</div>
    </div>

    <!-- Sketch Mode Banner -->
    <div id="sketch-banner">
      <span>‚úé Sketch Mode ‚Äî XY Plane</span>
      <button onclick="toggleSketchMode()">Finish Sketch</button>
    </div>

    <!-- Snap Indicator -->
    <div class="snap-indicator" id="snap-indicator"></div>

    <!-- Selection Info -->
    <div class="selection-info" id="selection-info" style="display:none">
      Face selected ‚Äî Area: 625.00 mm¬≤
    </div>
  </div>

  <!-- Right Panel -->
  <div id="right-panel">
    <div class="panel-header">
      <span>Properties</span>
      <button>‚ãØ</button>
    </div>

    <div style="flex:1; overflow-y:auto;">
      <!-- Feature Properties -->
      <div class="prop-section" id="prop-feature">
        <div class="prop-section-header" onclick="toggleSection(this)">
          <span class="arrow open">‚ñ∂</span>
          <span>Extrude 1</span>
        </div>
        <div class="prop-section-body">
          <div class="prop-row">
            <span class="prop-label">Type</span>
            <select class="prop-select">
              <option selected>New Body</option>
              <option>Join</option>
              <option>Cut</option>
              <option>Intersect</option>
            </select>
          </div>
          <div class="prop-row">
            <span class="prop-label">Profile</span>
            <span style="font-size:11px; color:var(--accent2)">Sketch 1 ‚Üí Profile 1</span>
          </div>
          <div class="prop-row">
            <span class="prop-label">Direction</span>
            <select class="prop-select">
              <option selected>One Side</option>
              <option>Two Sides</option>
              <option>Symmetric</option>
            </select>
          </div>
          <div class="prop-row">
            <span class="prop-label">Distance</span>
            <div class="prop-input-unit">
              <input class="prop-input" type="number" value="25.00" step="0.1" onchange="updateParam(this)">
              <span class="prop-unit">mm</span>
            </div>
          </div>
          <div class="prop-row">
            <span class="prop-label">Taper Angle</span>
            <div class="prop-input-unit">
              <input class="prop-input" type="number" value="0.00" step="0.5">
              <span class="prop-unit">¬∞</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Dimensions -->
      <div class="prop-section">
        <div class="prop-section-header" onclick="toggleSection(this)">
          <span class="arrow open">‚ñ∂</span>
          <span>Sketch Dimensions</span>
        </div>
        <div class="prop-section-body">
          <div class="prop-row">
            <span class="prop-label">Width (d1)</span>
            <div class="prop-input-unit">
              <input class="prop-input" type="number" value="50.00" step="0.1">
              <span class="prop-unit">mm</span>
            </div>
          </div>
          <div class="prop-row">
            <span class="prop-label">Height (d2)</span>
            <div class="prop-input-unit">
              <input class="prop-input" type="number" value="30.00" step="0.1">
              <span class="prop-unit">mm</span>
            </div>
          </div>
          <div class="prop-row">
            <span class="prop-label">Hole √ò (d3)</span>
            <div class="prop-input-unit">
              <input class="prop-input" type="number" value="8.00" step="0.1">
              <span class="prop-unit">mm</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Appearance -->
      <div class="prop-section">
        <div class="prop-section-header" onclick="toggleSection(this)">
          <span class="arrow open">‚ñ∂</span>
          <span>Appearance</span>
        </div>
        <div class="prop-section-body">
          <div class="prop-color-row">
            <div class="color-swatch active" style="background:#6699cc" onclick="setColor(this)"></div>
            <div class="color-swatch" style="background:#e94560" onclick="setColor(this)"></div>
            <div class="color-swatch" style="background:#10b981" onclick="setColor(this)"></div>
            <div class="color-swatch" style="background:#f59e0b" onclick="setColor(this)"></div>
            <div class="color-swatch" style="background:#a78bfa" onclick="setColor(this)"></div>
            <div class="color-swatch" style="background:#94a3b8" onclick="setColor(this)"></div>
            <div class="color-swatch" style="background:#f8fafc" onclick="setColor(this)"></div>
          </div>
          <div class="prop-row">
            <span class="prop-label">Opacity</span>
            <div class="prop-input-unit">
              <input class="prop-input" type="number" value="100" min="0" max="100" step="5">
              <span class="prop-unit">%</span>
            </div>
          </div>
          <div class="prop-row">
            <span class="prop-label">Roughness</span>
            <div class="prop-input-unit">
              <input class="prop-input" type="number" value="0.40" min="0" max="1" step="0.05">
            </div>
          </div>
          <div class="prop-row">
            <span class="prop-label">Metalness</span>
            <div class="prop-input-unit">
              <input class="prop-input" type="number" value="0.20" min="0" max="1" step="0.05">
            </div>
          </div>
        </div>
      </div>

      <!-- Physical Properties -->
      <div class="prop-section">
        <div class="prop-section-header" onclick="toggleSection(this)">
          <span class="arrow">‚ñ∂</span>
          <span>Physical Properties</span>
        </div>
        <div class="prop-section-body" style="display:none">
          <div class="prop-row">
            <span class="prop-label">Volume</span>
            <span style="font-size:11px">28,450.5 mm¬≥</span>
          </div>
          <div class="prop-row">
            <span class="prop-label">Surface Area</span>
            <span style="font-size:11px">8,234.2 mm¬≤</span>
          </div>
          <div class="prop-row">
            <span class="prop-label">Material</span>
            <select class="prop-select">
              <option>Aluminum 6061</option>
              <option selected>Steel AISI 304</option>
              <option>ABS Plastic</option>
              <option>Titanium Ti-6Al-4V</option>
            </select>
          </div>
          <div class="prop-row">
            <span class="prop-label">Mass</span>
            <span style="font-size:11px">223.8 g</span>
          </div>
          <div class="prop-row">
            <span class="prop-label">Density</span>
            <span style="font-size:11px">7.87 g/cm¬≥</span>
          </div>
        </div>
      </div>

      <!-- Constraints -->
      <div class="prop-section">
        <div class="prop-section-header" onclick="toggleSection(this)">
          <span class="arrow">‚ñ∂</span>
          <span>Constraints (7)</span>
        </div>
        <div class="prop-section-body" style="display:none">
          <div style="font-size:11px; color:var(--success); padding:4px 0">‚úì Fully constrained</div>
          <div style="font-size:11px; padding:2px 0; color:var(--text-dim)">‚Ä¢ Horizontal √ó2</div>
          <div style="font-size:11px; padding:2px 0; color:var(--text-dim)">‚Ä¢ Vertical √ó2</div>
          <div style="font-size:11px; padding:2px 0; color:var(--text-dim)">‚Ä¢ Coincident √ó4</div>
          <div style="font-size:11px; padding:2px 0; color:var(--text-dim)">‚Ä¢ Dimension √ó3</div>
          <div style="font-size:11px; padding:2px 0; color:var(--text-dim)">‚Ä¢ Concentric √ó1</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Timeline -->
<div id="timeline">
  <span style="font-size:10px; width:60px">History</span>
  <div class="timeline-line">
    <div class="timeline-progress" style="width:100%"></div>
    <div class="timeline-marker" title="Sketch 1"></div>
    <div class="timeline-marker" title="Extrude 1"></div>
    <div class="timeline-marker" title="Fillet 1"></div>
    <div class="timeline-marker" title="Sketch 2"></div>
    <div class="timeline-marker" title="Cut Extrude 1"></div>
    <div class="timeline-marker" title="Chamfer 1"></div>
    <div class="timeline-marker" title="Pattern"></div>
    <div class="timeline-marker current" title="Shell"></div>
  </div>
  <span style="font-size:10px; color:var(--text-dim)">8 / 8</span>
</div>

<!-- Context Menu -->
<div id="context-menu">
  <div class="ctx-item" onclick="hideContextMenu(); addFeature('extrude')">
    <span>‚¨Ü Extrude</span><span class="ctx-shortcut">E</span>
  </div>
  <div class="ctx-item" onclick="hideContextMenu(); addFeature('fillet')">
    <span>‚ó† Fillet</span><span class="ctx-shortcut">F</span>
  </div>
  <div class="ctx-item" onclick="hideContextMenu(); addFeature('chamfer')">
    <span>‚¨° Chamfer</span>
  </div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" onclick="hideContextMenu()">
    <span>üìã Copy</span><span class="ctx-shortcut">Ctrl+C</span>
  </div>
  <div class="ctx-item" onclick="hideContextMenu()">
    <span>üìÑ Paste</span><span class="ctx-shortcut">Ctrl+V</span>
  </div>
  <div class="ctx-item" onclick="hideContextMenu()">
    <span>üóë Delete</span><span class="ctx-shortcut">Del</span>
  </div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" onclick="hideContextMenu()">
    <span>üëÅ Hide</span><span class="ctx-shortcut">H</span>
  </div>
  <div class="ctx-item" onclick="hideContextMenu()">
    <span>üîí Suppress</span>
  </div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" onclick="hideContextMenu()">
    <span>üìê Edit Sketch</span>
  </div>
  <div class="ctx-item" onclick="hideContextMenu()">
    <span>‚úèÔ∏è Rename</span><span class="ctx-shortcut">F2</span>
  </div>
</div>

<!-- Command Palette -->
<div id="overlay" onclick="hideCommandPalette()"></div>
<div id="command-palette">
  <input type="text" id="cmd-input" placeholder="Type a command..." oninput="filterCommands(this.value)">
  <div id="command-results">
    <div class="cmd-item highlighted" onclick="hideCommandPalette(); addFeature('extrude')">
      <span class="cmd-icon">‚¨Ü</span><span>Extrude</span><span class="cmd-shortcut">E</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); addFeature('revolve')">
      <span class="cmd-icon">‚Üª</span><span>Revolve</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); addFeature('fillet')">
      <span class="cmd-icon">‚ó†</span><span>Fillet</span><span class="cmd-shortcut">F</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); addFeature('chamfer')">
      <span class="cmd-icon">‚¨°</span><span>Chamfer</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); addFeature('shell')">
      <span class="cmd-icon">‚òê</span><span>Shell</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); toggleSketchMode()">
      <span class="cmd-icon">‚úé</span><span>Create Sketch</span><span class="cmd-shortcut">S</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); setTool('line')">
      <span class="cmd-icon">‚ï±</span><span>Line</span><span class="cmd-shortcut">L</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); setTool('rect')">
      <span class="cmd-icon">‚ñ≠</span><span>Rectangle</span><span class="cmd-shortcut">R</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); setTool('circle')">
      <span class="cmd-icon">‚óã</span><span>Circle</span><span class="cmd-shortcut">C</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); setTool('measure')">
      <span class="cmd-icon">üìè</span><span>Measure</span><span class="cmd-shortcut">M</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); showToast('Exported as STEP')">
      <span class="cmd-icon">üíæ</span><span>Export STEP</span>
    </div>
    <div class="cmd-item" onclick="hideCommandPalette(); showToast('Exported as STL')">
      <span class="cmd-icon">üíæ</span><span>Export STL</span>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
// ============================================================
// STATE
// ============================================================
let state = {
  tool: 'select',
  sketchMode: false,
  selectedFeature: 'extrude1',
  camera: { rotX: -25, rotY: 45, zoom: 1, panX: 0, panY: 0 },
  isDragging: false,
  dragButton: -1,
  lastMouse: { x: 0, y: 0 },
  shapes: [],
  sketchEntities: [],
  drawingPoints: [],
  undoStack: [],
  redoStack: [],
  bodyColor: '#6699cc'
};

// ============================================================
// CANVAS / 3D RENDERING
// ============================================================
const canvas = document.getElementById('viewport');
const ctx = canvas.getContext('2d');

function resize() {
  const container = document.getElementById('viewport-container');
  canvas.width = container.clientWidth * devicePixelRatio;
  canvas.height = container.clientHeight * devicePixelRatio;
  canvas.style.width = container.clientWidth + 'px';
  canvas.style.height = container.clientHeight + 'px';
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  render();
}
window.addEventListener('resize', resize);

// Simple 3D projection
function project(x, y, z) {
  const { rotX, rotY, zoom, panX, panY } = state.camera;
  const rx = rotX * Math.PI / 180;
  const ry = rotY * Math.PI / 180;

  // Rotate Y
  let x1 = x * Math.cos(ry) - z * Math.sin(ry);
  let z1 = x * Math.sin(ry) + z * Math.cos(ry);
  let y1 = y;

  // Rotate X
  let y2 = y1 * Math.cos(rx) - z1 * Math.sin(rx);
  let z2 = y1 * Math.sin(rx) + z1 * Math.cos(rx);

  const w = canvas.width / devicePixelRatio;
  const h = canvas.height / devicePixelRatio;
  const scale = zoom * Math.min(w, h) / 200;

  return {
    x: w / 2 + x1 * scale + panX,
    y: h / 2 - y2 * scale + panY,
    z: z2
  };
}

function drawLine3D(x1, y1, z1, x2, y2, z2, color, width) {
  const p1 = project(x1, y1, z1);
  const p2 = project(x2, y2, z2);
  ctx.beginPath();
  ctx.moveTo(p1.x, p1.y);
  ctx.lineTo(p2.x, p2.y);
  ctx.strokeStyle = color;
  ctx.lineWidth = width || 1;
  ctx.stroke();
}

function drawGrid() {
  const gridSize = 50;
  const step = 5;
  ctx.globalAlpha = 0.15;
  for (let i = -gridSize; i <= gridSize; i += step) {
    drawLine3D(i, 0, -gridSize, i, 0, gridSize, '#94a3b8', 0.5);
    drawLine3D(-gridSize, 0, i, gridSize, 0, i, '#94a3b8', 0.5);
  }
  ctx.globalAlpha = 1;

  // Axes
  drawLine3D(0, 0, 0, 60, 0, 0, '#e94560', 2);
  drawLine3D(0, 0, 0, 0, 60, 0, '#0ea5e9', 2);
  drawLine3D(0, 0, 0, 0, 0, 60, '#10b981', 2);
}

// Draw a 3D box with edges (the main body)
function drawBox(sx, sy, sz, ex, ey, ez, fillColor, edgeColor) {
  const vertices = [
    [sx, sy, sz], [ex, sy, sz], [ex, ey, sz], [sx, ey, sz],
    [sx, sy, ez], [ex, sy, ez], [ex, ey, ez], [sx, ey, ez]
  ];
  const faces = [
    [0,1,2,3], [4,5,6,7], [0,1,5,4], [2,3,7,6], [0,3,7,4], [1,2,6,5]
  ];
  const normals = [
    [0,0,-1], [0,0,1], [0,-1,0], [0,1,0], [-1,0,0], [1,0,0]
  ];

  // Sort faces by average Z depth
  const projected = vertices.map(v => project(v[0], v[1], v[2]));
  const facesWithDepth = faces.map((f, i) => {
    const avgZ = f.reduce((s, vi) => s + projected[vi].z, 0) / 4;
    return { indices: f, depth: avgZ, normal: normals[i] };
  });
  facesWithDepth.sort((a, b) => b.depth - a.depth);

  for (const face of facesWithDepth) {
    const pts = face.indices.map(i => projected[i]);

    // Simple lighting
    const rx = state.camera.rotX * Math.PI / 180;
    const ry = state.camera.rotY * Math.PI / 180;
    const lightDir = [0.3, 0.8, 0.5];
    const n = face.normal;
    let dot = n[0]*lightDir[0] + n[1]*lightDir[1] + n[2]*lightDir[2];
    dot = Math.max(0.25, Math.min(1, (dot + 1) / 2));

    // Parse color and apply lighting
    const r = parseInt(fillColor.slice(1,3), 16);
    const g = parseInt(fillColor.slice(3,5), 16);
    const b = parseInt(fillColor.slice(5,7), 16);

    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y);
    ctx.closePath();
    ctx.fillStyle = `rgb(${Math.round(r*dot)},${Math.round(g*dot)},${Math.round(b*dot)})`;
    ctx.fill();

    ctx.strokeStyle = edgeColor || '#334155';
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }
}

// Draw a cylinder approximation
function drawCylinder(cx, cz, radius, height, segments, fillColor, edgeColor) {
  const topPts = [];
  const botPts = [];
  for (let i = 0; i <= segments; i++) {
    const a = (i / segments) * Math.PI * 2;
    const x = cx + Math.cos(a) * radius;
    const z = cz + Math.sin(a) * radius;
    topPts.push(project(x, height, z));
    botPts.push(project(x, 0, z));
  }

  // Side
  ctx.beginPath();
  for (let i = 0; i < topPts.length; i++) {
    if (i === 0) ctx.moveTo(botPts[i].x, botPts[i].y);
    else ctx.lineTo(botPts[i].x, botPts[i].y);
  }
  for (let i = topPts.length - 1; i >= 0; i--) {
    ctx.lineTo(topPts[i].x, topPts[i].y);
  }
  ctx.closePath();
  ctx.fillStyle = fillColor;
  ctx.globalAlpha = 0.6;
  ctx.fill();
  ctx.globalAlpha = 1;
  ctx.strokeStyle = edgeColor || '#334155';
  ctx.lineWidth = 1;
  ctx.stroke();

  // Top ellipse
  ctx.beginPath();
  for (let i = 0; i < topPts.length; i++) {
    if (i === 0) ctx.moveTo(topPts[i].x, topPts[i].y);
    else ctx.lineTo(topPts[i].x, topPts[i].y);
  }
  ctx.closePath();
  ctx.fillStyle = fillColor;
  ctx.globalAlpha = 0.8;
  ctx.fill();
  ctx.globalAlpha = 1;
  ctx.strokeStyle = edgeColor || '#334155';
  ctx.lineWidth = 1.5;
  ctx.stroke();
}

// Draw filleted box (main demo shape)
function drawFilletedBody() {
  const color = state.bodyColor;

  // Main body - slightly complex shape
  drawBox(-25, 0, -15, 25, 25, 15, color, '#ffffff44');

  // Cutout holes (drawn as dark cylinders)
  drawCylinder(10, 0, 4, 26, 20, '#1a1a2e', '#ffffff22');
  drawCylinder(-10, 0, 4, 26, 20, '#1a1a2e', '#ffffff22');

  // Small features
  drawBox(-20, 25, -10, -12, 30, 10, color, '#ffffff44');
  drawBox(12, 25, -10, 20, 30, 10, color, '#ffffff44');

  // Fillet indicators (small arcs at edges)
  ctx.strokeStyle = '#a78bfa44';
  ctx.lineWidth = 3;
  const corners = [
    [-25, 25, -15], [25, 25, -15], [25, 25, 15], [-25, 25, 15]
  ];
  for (const c of corners) {
    const p = project(c[0], c[1], c[2]);
    ctx.beginPath();
    ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
    ctx.stroke();
  }
}

// Draw sketch entities when in sketch mode
function drawSketchOverlay() {
  if (!state.sketchMode) return;

  ctx.save();
  ctx.setLineDash([5, 5]);
  ctx.strokeStyle = '#f59e0b';
  ctx.lineWidth = 1;

  // Draw sketch rectangle
  const corners2D = [[-25, 0, -15], [25, 0, -15], [25, 0, 15], [-25, 0, 15]];
  const projected = corners2D.map(c => project(c[0], c[1], c[2]));

  ctx.beginPath();
  ctx.moveTo(projected[0].x, projected[0].y);
  for (let i = 1; i < projected.length; i++) ctx.lineTo(projected[i].x, projected[i].y);
  ctx.closePath();
  ctx.stroke();

  // Dimension lines
  ctx.setLineDash([]);
  ctx.strokeStyle = '#0ea5e9';
  ctx.lineWidth = 1;
  ctx.font = '11px system-ui';
  ctx.fillStyle = '#0ea5e9';

  // Width dimension
  const dw1 = project(-25, 0, -20);
  const dw2 = project(25, 0, -20);
  ctx.beginPath();
  ctx.moveTo(dw1.x, dw1.y);
  ctx.lineTo(dw2.x, dw2.y);
  ctx.stroke();
  const dwMid = { x: (dw1.x + dw2.x) / 2, y: (dw1.y + dw2.y) / 2 };
  ctx.fillText('50.00', dwMid.x - 15, dwMid.y - 6);

  // Height dimension
  const dh1 = project(-30, 0, -15);
  const dh2 = project(-30, 0, 15);
  ctx.beginPath();
  ctx.moveTo(dh1.x, dh1.y);
  ctx.lineTo(dh2.x, dh2.y);
  ctx.stroke();
  const dhMid = { x: (dh1.x + dh2.x) / 2, y: (dh1.y + dh2.y) / 2 };
  ctx.fillText('30.00', dhMid.x - 30, dhMid.y + 4);

  // Constraint icons
  ctx.fillStyle = '#10b981';
  ctx.font = '9px system-ui';
  for (const c of corners2D) {
    const p = project(c[0], c[1], c[2]);
    ctx.beginPath();
    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
    ctx.fillStyle = '#f59e0b';
    ctx.fill();
    ctx.strokeStyle = '#f59e0b';
    ctx.lineWidth = 1;
    ctx.stroke();
  }

  // Circle sketch entities
  const circleCenter1 = project(10, 0, 0);
  const circleCenter2 = project(-10, 0, 0);
  ctx.strokeStyle = '#f59e0b';
  ctx.lineWidth = 1.5;
  ctx.setLineDash([]);

  [circleCenter1, circleCenter2].forEach(cc => {
    ctx.beginPath();
    ctx.arc(cc.x, cc.y, 15 * state.camera.zoom, 0, Math.PI * 2);
    ctx.stroke();
    // Center mark
    ctx.beginPath();
    ctx.moveTo(cc.x - 4, cc.y);
    ctx.lineTo(cc.x + 4, cc.y);
    ctx.moveTo(cc.x, cc.y - 4);
    ctx.lineTo(cc.x, cc.y + 4);
    ctx.strokeStyle = '#f59e0b88';
    ctx.stroke();
    ctx.strokeStyle = '#f59e0b';
  });

  // Diameter dimension
  ctx.fillStyle = '#0ea5e9';
  ctx.font = '10px system-ui';
  ctx.fillText('√ò8.00', circleCenter1.x + 18, circleCenter1.y - 4);
  ctx.fillText('√ò8.00', circleCenter2.x + 18, circleCenter2.y - 4);

  ctx.restore();
}

// Draw currently-being-drawn sketch entity
function drawActiveSketch() {
  if (state.drawingPoints.length === 0) return;

  ctx.save();
  ctx.strokeStyle = '#e94560';
  ctx.lineWidth = 2;
  ctx.setLineDash([]);

  if (state.tool === 'line' && state.drawingPoints.length >= 1) {
    const p = project(state.drawingPoints[0].x, 0, state.drawingPoints[0].z);
    ctx.beginPath();
    ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
    ctx.fillStyle = '#e94560';
    ctx.fill();
  }

  ctx.restore();
}

function render() {
  const w = canvas.width / devicePixelRatio;
  const h = canvas.height / devicePixelRatio;

  // Background gradient
  const grad = ctx.createLinearGradient(0, 0, 0, h);
  grad.addColorStop(0, '#1a1a2e');
  grad.addColorStop(1, '#0f0f1e');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, w, h);

  drawGrid();
  drawFilletedBody();
  drawSketchOverlay();
  drawActiveSketch();
}

// ============================================================
// CAMERA CONTROLS
// ============================================================
canvas.addEventListener('mousedown', (e) => {
  state.isDragging = true;
  state.dragButton = e.button;
  state.lastMouse = { x: e.clientX, y: e.clientY };
});

canvas.addEventListener('mousemove', (e) => {
  // Update cursor position display
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  const w = rect.width;
  const h = rect.height;

  // Approximate world coords (simplified)
  const wx = ((mx - w/2 - state.camera.panX) / (state.camera.zoom * Math.min(w,h) / 200)).toFixed(2);
  const wy = (-(my - h/2 - state.camera.panY) / (state.camera.zoom * Math.min(w,h) / 200)).toFixed(2);
  document.getElementById('cursor-pos').textContent = `X: ${wx}  Y: ${wy}  Z: 0.00`;

  if (!state.isDragging) return;

  const dx = e.clientX - state.lastMouse.x;
  const dy = e.clientY - state.lastMouse.y;

  if (state.dragButton === 0 && e.shiftKey || state.dragButton === 1) {
    // Pan
    state.camera.panX += dx;
    state.camera.panY += dy;
  } else if (state.dragButton === 0 || state.dragButton === 2) {
    // Orbit
    state.camera.rotY += dx * 0.5;
    state.camera.rotX += dy * 0.5;
    state.camera.rotX = Math.max(-90, Math.min(90, state.camera.rotX));

    // Update viewcube
    document.getElementById('cube').style.transform =
      `rotateX(${-state.camera.rotX}deg) rotateY(${state.camera.rotY}deg)`;
  }

  state.lastMouse = { x: e.clientX, y: e.clientY };
  render();
});

canvas.addEventListener('mouseup', () => { state.isDragging = false; });
canvas.addEventListener('mouseleave', () => { state.isDragging = false; });

canvas.addEventListener('wheel', (e) => {
  e.preventDefault();
  const factor = e.deltaY > 0 ? 0.9 : 1.1;
  state.camera.zoom *= factor;
  state.camera.zoom = Math.max(0.1, Math.min(10, state.camera.zoom));
  render();
}, { passive: false });

canvas.addEventListener('contextmenu', (e) => {
  e.preventDefault();
  showContextMenu(e.clientX, e.clientY);
});

// ============================================================
// VIEW CUBE
// ============================================================
function setView(view) {
  const views = {
    front:  { rotX: 0, rotY: 0 },
    back:   { rotX: 0, rotY: 180 },
    right:  { rotX: 0, rotY: 90 },
    left:   { rotX: 0, rotY: -90 },
    top:    { rotX: -90, rotY: 0 },
    bottom: { rotX: 90, rotY: 0 },
    iso:    { rotX: -25, rotY: 45 }
  };
  const v = views[view] || views.iso;

  // Animate
  const startRotX = state.camera.rotX;
  const startRotY = state.camera.rotY;
  const duration = 400;
  const startTime = performance.now();

  function animate(time) {
    const t = Math.min(1, (time - startTime) / duration);
    const ease = t < 0.5 ? 2*t*t : -1+(4-2*t)*t; // ease in-out quad
    state.camera.rotX = startRotX + (v.rotX - startRotX) * ease;
    state.camera.rotY = startRotY + (v.rotY - startRotY) * ease;
    document.getElementById('cube').style.transform =
      `rotateX(${-state.camera.rotX}deg) rotateY(${state.camera.rotY}deg)`;
    render();
    if (t < 1) requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
}

// ============================================================
// TOOLS
// ============================================================
function setTool(tool) {
  state.tool = tool;
  state.drawingPoints = [];
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('btn-' + tool);
  if (btn) btn.classList.add('active');

  if (['line','rect','circle','arc','spline'].includes(tool) && !state.sketchMode) {
    toggleSketchMode();
  }

  showToast(`Tool: ${tool.charAt(0).toUpperCase() + tool.slice(1)}`);
}

function toggleSketchMode() {
  state.sketchMode = !state.sketchMode;
  const banner = document.getElementById('sketch-banner');
  const btn = document.getElementById('btn-sketch');

  if (state.sketchMode) {
    banner.classList.add('show');
    btn.classList.add('active');
    showToast('Entered sketch mode');
  } else {
    banner.classList.remove('show');
    btn.classList.remove('active');
    state.tool = 'select';
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    showToast('Finished sketch');
  }
  render();
}

function toggleSection() {
  showToast('Section view toggled');
}

// ============================================================
// FEATURES
// ============================================================
const featureIcons = {
  extrude: { icon: '‚¨Ü', cls: 'extrude' },
  revolve: { icon: '‚Üª', cls: 'revolve' },
  fillet: { icon: '‚ó†', cls: 'fillet' },
  chamfer: { icon: '‚¨°', cls: 'chamfer' },
  shell: { icon: '‚òê', cls: 'shell' },
  union: { icon: '‚äï', cls: 'boolean' },
  subtract: { icon: '‚äñ', cls: 'boolean' },
  intersect: { icon: '‚äó', cls: 'boolean' },
  'linear-pattern': { icon: '‚´∂', cls: 'pattern' },
  mirror: { icon: '‚åÅ', cls: 'pattern' }
};

let featureCount = 8;

function addFeature(type) {
  featureCount++;
  const info = featureIcons[type] || { icon: '‚óè', cls: '' };
  const name = type.charAt(0).toUpperCase() + type.slice(1).replace('-', ' ') + ' ' + featureCount;

  const tree = document.getElementById('feature-tree');
  const item = document.createElement('div');
  item.className = 'tree-item';
  item.onclick = function() { selectFeature(this, 'feature-' + featureCount); };
  item.innerHTML = `
    <span class="icon ${info.cls}">${info.icon}</span>
    <span class="name">${name}</span>
    <span class="visibility" onclick="event.stopPropagation()">üëÅ</span>
  `;
  tree.appendChild(item);

  // Add timeline marker
  const timeline = document.querySelector('.timeline-line');
  document.querySelectorAll('.timeline-marker').forEach(m => m.classList.remove('current'));
  const marker = document.createElement('div');
  marker.className = 'timeline-marker current';
  marker.title = name;
  timeline.appendChild(marker);

  // Update progress
  const progress = document.querySelector('.timeline-progress');
  progress.style.width = '100%';

  selectFeature(item, 'feature-' + featureCount);
  showToast(`Added: ${name}`);

  // Push to undo stack
  state.undoStack.push({ action: 'add', type, id: featureCount });
  state.redoStack = [];
}

function selectFeature(el, id) {
  document.querySelectorAll('.tree-item').forEach(i => i.classList.remove('selected'));
  el.classList.add('selected');
  state.selectedFeature = id;

  // Show selection info
  const info = document.getElementById('selection-info');
  info.style.display = 'block';
  info.textContent = `Selected: ${el.querySelector('.name').textContent}`;
  setTimeout(() => { info.style.display = 'none'; }, 2000);
}

// ============================================================
// PROPERTIES PANEL
// ============================================================
function toggleSection(header) {
  const body = header.nextElementSibling;
  const arrow = header.querySelector('.arrow');
  if (body.style.display === 'none') {
    body.style.display = 'block';
    arrow.classList.add('open');
  } else {
    body.style.display = 'none';
    arrow.classList.remove('open');
  }
}

function updateParam(input) {
  showToast(`Updated parameter: ${input.value}mm`);
  render();
}

function setColor(el) {
  document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  state.bodyColor = el.style.background;
  render();
  showToast('Color updated');
}

// ============================================================
// CONTEXT MENU
// ============================================================
function showContextMenu(x, y) {
  const menu = document.getElementById('context-menu');
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  menu.classList.add('show');
  document.addEventListener('click', hideContextMenu, { once: true });
}

function hideContextMenu() {
  document.getElementById('context-menu').classList.remove('show');
}

// ============================================================
// COMMAND PALETTE
// ============================================================
function showCommandPalette() {
  document.getElementById('command-palette').classList.add('show');
  document.getElementById('overlay').classList.add('show');
  const input = document.getElementById('cmd-input');
  input.value = '';
  input.focus();
  filterCommands('');
}

function hideCommandPalette() {
  document.getElementById('command-palette').classList.remove('show');
  document.getElementById('overlay').classList.remove('show');
}

function filterCommands(query) {
  const items = document.querySelectorAll('.cmd-item');
  const q = query.toLowerCase();
  let first = true;
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    const match = !q || text.includes(q);
    item.style.display = match ? 'flex' : 'none';
    item.classList.remove('highlighted');
    if (match && first) {
      item.classList.add('highlighted');
      first = false;
    }
  });
}

// ============================================================
// UNDO / REDO
// ============================================================
function undo() {
  if (state.undoStack.length === 0) {
    showToast('Nothing to undo');
    return;
  }
  const action = state.undoStack.pop();
  state.redoStack.push(action);
  showToast('Undo: ' + action.type);

  // Remove last tree item
  const tree = document.getElementById('feature-tree');
  if (tree.lastElementChild && tree.lastElementChild.classList.contains('tree-item')) {
    tree.removeChild(tree.lastElementChild);
  }
}

function redo() {
  if (state.redoStack.length === 0) {
    showToast('Nothing to redo');
    return;
  }
  const action = state.redoStack.pop();
  state.undoStack.push(action);
  addFeature(action.type);
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(() => toast.classList.remove('show'), 2000);
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', (e) => {
  // Don't trigger shortcuts when typing in inputs
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

  if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undo(); }
  else if (e.ctrlKey && e.key === 'y') { e.preventDefault(); redo(); }
  else if (e.ctrlKey && e.key === 'k' || e.key === '/') { e.preventDefault(); showCommandPalette(); }
  else if (e.key === 'Escape') {
    hideCommandPalette();
    hideContextMenu();
    if (state.sketchMode) toggleSketchMode();
    state.tool = 'select';
    state.drawingPoints = [];
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  }
  else if (e.key === 's' || e.key === 'S') { if (!e.ctrlKey) toggleSketchMode(); }
  else if (e.key === 'l' || e.key === 'L') setTool('line');
  else if (e.key === 'r' || e.key === 'R') setTool('rect');
  else if (e.key === 'c' || e.key === 'C') setTool('circle');
  else if (e.key === 'a' || e.key === 'A') setTool('arc');
  else if (e.key === 'e' || e.key === 'E') addFeature('extrude');
  else if (e.key === 'f' || e.key === 'F') addFeature('fillet');
  else if (e.key === 'm' || e.key === 'M') setTool('measure');
  else if (e.key === 'h' || e.key === 'H') showToast('Selection hidden');
  else if (e.key === 'Delete') showToast('Feature deleted');
  else if (e.key === '1') setView('front');
  else if (e.key === '2') setView('back');
  else if (e.key === '3') setView('right');
  else if (e.key === '4') setView('left');
  else if (e.key === '5') setView('top');
  else if (e.key === '6') setView('bottom');
  else if (e.key === '0') setView('iso');
});

// ============================================================
// INIT
// ============================================================
resize();
showToast('BetterCAD loaded ‚Äî Press / for command palette');
</script>
</body>
</html>
