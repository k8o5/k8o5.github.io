<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAD Pro - Professional 3D Modeling</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --bg-hover: #3e3e42;
            --bg-active: #094771;
            --border-color: #3e3e42;
            --text-primary: #cccccc;
            --text-secondary: #858585;
            --accent: #0078d4;
            --accent-hover: #1e8ad4;
            --success: #4ec9b0;
            --warning: #dcdcaa;
            --error: #f14c4c;
            --toolbar-height: 40px;
            --ribbon-height: 90px;
            --panel-width: 280px;
            --timeline-height: 150px;
            --statusbar-height: 24px;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* Top Menu Bar */
        .menu-bar {
            height: 28px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            padding: 0 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }

        .menu-item {
            padding: 4px 12px;
            cursor: pointer;
            border-radius: 3px;
        }

        .menu-item:hover {
            background: var(--bg-hover);
        }

        .app-title {
            margin-left: auto;
            color: var(--text-secondary);
            font-size: 11px;
        }

        /* Ribbon Toolbar */
        .ribbon {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .ribbon-tabs {
            display: flex;
            height: 32px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .ribbon-tab {
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .ribbon-tab:hover {
            background: var(--bg-hover);
        }

        .ribbon-tab.active {
            background: var(--bg-secondary);
            border-bottom-color: var(--accent);
        }

        .ribbon-content {
            height: 80px;
            display: flex;
            padding: 8px;
            gap: 8px;
        }

        .ribbon-group {
            display: flex;
            flex-direction: column;
            padding: 0 12px;
            border-right: 1px solid var(--border-color);
        }

        .ribbon-group-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: auto;
            padding-top: 4px;
        }

        .ribbon-group-content {
            display: flex;
            gap: 4px;
            flex: 1;
            align-items: center;
        }

        .ribbon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            min-width: 50px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .ribbon-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-color);
        }

        .ribbon-btn.active {
            background: var(--bg-active);
            border-color: var(--accent);
        }

        .ribbon-btn svg {
            width: 24px;
            height: 24px;
            margin-bottom: 2px;
        }

        .ribbon-btn span {
            font-size: 10px;
        }

        .ribbon-btn.large svg {
            width: 32px;
            height: 32px;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Panel - Browser */
        .panel {
            width: var(--panel-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .tree-item:hover {
            background: var(--bg-hover);
        }

        .tree-item.selected {
            background: var(--bg-active);
        }

        .tree-item svg {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .tree-item .toggle {
            width: 16px;
            height: 16px;
            margin-right: 4px;
            cursor: pointer;
        }

        .tree-children {
            margin-left: 20px;
        }

        /* Viewport */
        .viewport-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .viewport {
            flex: 1;
            position: relative;
            background: linear-gradient(180deg, #1e1e1e 0%, #2d2d30 100%);
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Viewport Overlays */
        .view-cube {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            perspective: 200px;
        }

        .view-cube-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.3s;
        }

        .cube-face {
            position: absolute;
            width: 80px;
            height: 80px;
            background: rgba(60, 60, 60, 0.9);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            backface-visibility: visible;
        }

        .cube-face:hover {
            background: var(--accent);
        }

        .navigation-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .nav-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .nav-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .nav-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .nav-btn svg {
            width: 18px;
            height: 18px;
        }

        .viewport-info {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .coordinate-display {
            position: absolute;
            bottom: 70px;
            left: 20px;
            font-size: 11px;
            font-family: 'Consolas', monospace;
            color: var(--text-secondary);
        }

        /* Right Panel - Properties */
        .panel-right {
            width: var(--panel-width);
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .property-group {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .property-group-header {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .property-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .property-label {
            width: 80px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .property-input {
            flex: 1;
            height: 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 0 8px;
            color: var(--text-primary);
            font-size: 11px;
        }

        .property-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .property-input-group {
            display: flex;
            gap: 4px;
            flex: 1;
        }

        .property-input-group input {
            width: 100%;
        }

        .input-label {
            width: 16px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            border-radius: 3px 0 0 3px;
        }

        .input-label.x { background: #c94a4a; }
        .input-label.y { background: #4a9a4a; }
        .input-label.z { background: #4a7ac9; }

        .property-input-with-label {
            display: flex;
        }

        .property-input-with-label input {
            border-radius: 0 3px 3px 0;
        }

        /* Timeline */
        .timeline-panel {
            height: var(--timeline-height);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .timeline-header {
            height: 28px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }

        .timeline-content {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 12px;
            overflow-x: auto;
            gap: 4px;
        }

        .timeline-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            min-width: 80px;
            transition: all 0.15s;
        }

        .timeline-item:hover {
            border-color: var(--accent);
        }

        .timeline-item.selected {
            background: var(--bg-active);
            border-color: var(--accent);
        }

        .timeline-item.suppressed {
            opacity: 0.5;
        }

        .timeline-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        .timeline-item span {
            font-size: 10px;
            white-space: nowrap;
        }

        .timeline-connector {
            width: 20px;
            height: 2px;
            background: var(--border-color);
            flex-shrink: 0;
        }

        /* Status Bar */
        .status-bar {
            height: var(--statusbar-height);
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-right: 20px;
        }

        .status-item svg {
            width: 14px;
            height: 14px;
        }

        .status-bar-right {
            margin-left: auto;
            display: flex;
            gap: 20px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            min-width: 200px;
            padding: 4px 0;
            z-index: 10000;
            display: none;
        }

        .context-menu.visible {
            display: block;
        }

        .context-menu-item {
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .context-menu-item:hover {
            background: var(--bg-active);
        }

        .context-menu-item svg {
            width: 16px;
            height: 16px;
        }

        .context-menu-item .shortcut {
            margin-left: auto;
            color: var(--text-secondary);
            font-size: 11px;
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-width: 400px;
            max-width: 600px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.5);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-close {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-close:hover {
            background: var(--bg-hover);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .btn:hover {
            background: var(--bg-hover);
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            height: 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0 12px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-select {
            width: 100%;
            height: 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0 12px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        /* Color Picker */
        .color-picker {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-preview {
            width: 32px;
            height: 24px;
            border-radius: 3px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Quick Access Toolbar */
        .quick-toolbar {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .quick-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .quick-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .quick-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .quick-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Dimension Display */
        .dimension-overlay {
            position: absolute;
            pointer-events: none;
        }

        /* Grid Settings */
        .grid-settings {
            position: absolute;
            bottom: 70px;
            right: 20px;
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            display: none;
        }

        .grid-settings.visible {
            display: block;
        }

        /* Sketch Toolbar */
        .sketch-toolbar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .sketch-toolbar.visible {
            display: flex;
        }

        /* Material Preview */
        .material-preview {
            width: 100%;
            height: 60px;
            background: linear-gradient(135deg, #4a4a4a, #2a2a2a);
            border-radius: 6px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
        }

        .material-sphere {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #888, #333);
        }

        /* Units Display */
        .units-selector {
            display: flex;
            gap: 2px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            padding: 2px;
        }

        .units-option {
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .units-option.active {
            background: var(--accent);
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            pointer-events: none;
            z-index: 10001;
            display: none;
        }

        .tooltip.visible {
            display: block;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            min-width: 200px;
            padding: 4px 0;
            z-index: 1000;
            display: none;
        }

        .menu-item:hover .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dropdown-item:hover {
            background: var(--bg-active);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            flex-direction: column;
            gap: 16px;
        }

        .loading-overlay.visible {
            display: flex;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--bg-hover);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 40px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 10000;
        }

        .notification.visible {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 3px solid var(--success);
        }

        .notification.error {
            border-left: 3px solid var(--error);
        }

        .notification.warning {
            border-left: 3px solid var(--warning);
        }

        /* Sketch Mode Indicator */
        .mode-indicator {
            position: absolute;
            top: 10px;
            right: 110px;
            background: var(--accent);
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: none;
        }

        .mode-indicator.visible {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Menu Bar -->
    <div class="menu-bar">
        <div class="menu-item" onclick="showFileMenu()">File</div>
        <div class="menu-item" onclick="showEditMenu()">Edit</div>
        <div class="menu-item" onclick="showViewMenu()">View</div>
        <div class="menu-item" onclick="showInsertMenu()">Insert</div>
        <div class="menu-item" onclick="showModifyMenu()">Modify</div>
        <div class="menu-item" onclick="showSketchMenu()">Sketch</div>
        <div class="menu-item" onclick="showAssembleMenu()">Assemble</div>
        <div class="menu-item" onclick="showToolsMenu()">Tools</div>
        <div class="app-title">CAD Pro - Untitled Project</div>
    </div>

    <!-- Ribbon -->
    <div class="ribbon">
        <div class="ribbon-tabs">
            <div class="ribbon-tab active" data-tab="solid">Solid</div>
            <div class="ribbon-tab" data-tab="surface">Surface</div>
            <div class="ribbon-tab" data-tab="sketch">Sketch</div>
            <div class="ribbon-tab" data-tab="sheet-metal">Sheet Metal</div>
            <div class="ribbon-tab" data-tab="tools">Tools</div>
            <div class="ribbon-tab" data-tab="render">Render</div>
        </div>
        <div class="ribbon-content" id="ribbon-solid">
            <div class="ribbon-group">
                <div class="ribbon-group-content">
                    <button class="ribbon-btn large" onclick="createSketch()" title="Create Sketch">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="9" y1="3" x2="9" y2="21"/>
                        </svg>
                        <span>Sketch</span>
                    </button>
                </div>
                <div class="ribbon-group-label">Create</div>
            </div>
            <div class="ribbon-group">
                <div class="ribbon-group-content">
                    <button class="ribbon-btn" onclick="createPrimitive('box')" title="Create Box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7v10l10 5 10-5V7L12 2z"/>
                            <path d="M12 22V12"/>
                            <path d="M2 7l10 5 10-5"/>
                        </svg>
                        <span>Box</span>
                    </button>
                    <button class="ribbon-btn" onclick="createPrimitive('cylinder')" title="Create Cylinder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <ellipse cx="12" cy="5" rx="9" ry="3"/>
                            <path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5"/>
                        </svg>
                        <span>Cylinder</span>
                    </button>
                    <button class="ribbon-btn" onclick="createPrimitive('sphere')" title="Create Sphere">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <ellipse cx="12" cy="12" rx="10" ry="4"/>
                            <path d="M12 2a10 10 0 0 0 0 20"/>
                        </svg>
                        <span>Sphere</span>
                    </button>
                    <button class="ribbon-btn" onclick="createPrimitive('cone')" title="Create Cone">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L3 20h18L12 2z"/>
                            <ellipse cx="12" cy="20" rx="9" ry="2"/>
                        </svg>
                        <span>Cone</span>
                    </button>
                    <button class="ribbon-btn" onclick="createPrimitive('torus')" title="Create Torus">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <ellipse cx="12" cy="12" rx="10" ry="4"/>
                            <ellipse cx="12" cy="12" rx="6" ry="2"/>
                        </svg>
                        <span>Torus</span>
                    </button>
                </div>
                <div class="ribbon-group-label">Primitives</div>
            </div>
            <div class="ribbon-group">
                <div class="ribbon-group-content">
                    <button class="ribbon-btn large" onclick="extrude()" title="Extrude">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="4" y="14" width="16" height="6"/>
                            <path d="M4 14V8l8-4 8 4v6"/>
                        </svg>
                        <span>Extrude</span>
                    </button>
                    <button class="ribbon-btn" onclick="revolve()" title="Revolve">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v20"/>
                            <path d="M17 7c2.5 2 4 4.5 4 5s-1.5 3-4 5"/>
                        </svg>
                        <span>Revolve</span>
                    </button>
                    <button class="ribbon-btn" onclick="sweep()" title="Sweep">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="6" cy="6" r="3"/>
                            <path d="M9 6c4 0 6 4 6 8s2 4 6 4"/>
                        </svg>
                        <span>Sweep</span>
                    </button>
                    <button class="ribbon-btn" onclick="loft()" title="Loft">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="4" r="2"/>
                            <rect x="6" y="18" width="12" height="4"/>
                            <path d="M10 6L6 18M14 6l4 12"/>
                        </svg>
                        <span>Loft</span>
                    </button>
                </div>
                <div class="ribbon-group-label">Create</div>
            </div>
            <div class="ribbon-group">
                <div class="ribbon-group-content">
                    <button class="ribbon-btn" onclick="boolUnion()" title="Union">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="9" cy="9" r="6" opacity="0.5"/>
                            <circle cx="15" cy="15" r="6" opacity="0.5"/>
                        </svg>
                        <span>Union</span>
                    </button>
                    <button class="ribbon-btn" onclick="boolSubtract()" title="Subtract">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="9" r="6"/>
                            <circle cx="15" cy="15" r="6" stroke-dasharray="2,2"/>
                        </svg>
                        <span>Cut</span>
                    </button>
                    <button class="ribbon-btn" onclick="boolIntersect()" title="Intersect">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="9" r="6"/>
                            <circle cx="15" cy="15" r="6"/>
                            <path d="M12 6v12M6 12h12" stroke="var(--accent)"/>
                        </svg>
                        <span>Intersect</span>
                    </button>
                </div>
                <div class="ribbon-group-label">Boolean</div>
            </div>
            <div class="ribbon-group">
                <div class="ribbon-group-content">
                    <button class="ribbon-btn" onclick="fillet()" title="Fillet">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 20V10a6 6 0 0 1 6-6h10"/>
                        </svg>
                        <span>Fillet</span>
                    </button>
                    <button class="ribbon-btn" onclick="chamfer()" title="Chamfer">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 20V12L12 4h8"/>
                        </svg>
                        <span>Chamfer</span>
                    </button>
                    <button class="ribbon-btn" onclick="shell()" title="Shell">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="2" width="20" height="20" rx="2"/>
                            <rect x="5" y="5" width="14" height="14" rx="1"/>
                        </svg>
                        <span>Shell</span>
                    </button>
                    <button class="ribbon-btn" onclick="draft()" title="Draft">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 20L8 4h8l4 16"/>
                        </svg>
                        <span>Draft</span>
                    </button>
                </div>
                <div class="ribbon-group-label">Modify</div>
            </div>
            <div class="ribbon-group">
                <div class="ribbon-group-content">
                    <button class="ribbon-btn" onclick="patternRectangular()" title="Rectangular Pattern">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="2" width="6" height="6"/>
                            <rect x="10" y="2" width="6" height="6"/>
                            <rect x="2" y="10" width="6" height="6"/>
                            <rect x="10" y="10" width="6" height="6"/>
                        </svg>
                        <span>Rect Pattern</span>
                    </button>
                    <button class="ribbon-btn" onclick="patternCircular()" title="Circular Pattern">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="4" r="2" fill="currentColor"/>
                            <circle cx="20" cy="12" r="2" fill="currentColor"/>
                            <circle cx="12" cy="20" r="2" fill="currentColor"/>
                            <circle cx="4" cy="12" r="2" fill="currentColor"/>
                        </svg>
                        <span>Circ Pattern</span>
                    </button>
                    <button class="ribbon-btn" onclick="mirror()" title="Mirror">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v20"/>
                            <rect x="3" y="6" width="6" height="12"/>
                            <rect x="15" y="6" width="6" height="12" stroke-dasharray="2,2"/>
                        </svg>
                        <span>Mirror</span>
                    </button>
                </div>
                <div class="ribbon-group-label">Pattern</div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel - Browser -->
        <div class="panel" id="browser-panel">
            <div class="panel-header">
                Browser
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"/>
                </svg>
            </div>
            <div class="panel-content" id="browser-tree">
                <div class="tree-item selected" data-id="root">
                    <span class="toggle">▼</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2">
                        <path d="M3 3h18v18H3V3z"/>
                        <path d="M3 9h18M9 3v18"/>
                    </svg>
                    <span>Document</span>
                </div>
                <div class="tree-children" id="bodies-tree">
                    <div class="tree-item" data-type="folder">
                        <span class="toggle">▼</span>
                        <svg viewBox="0 0 24 24" fill="var(--warning)" stroke="none">
                            <path d="M3 4h6l2 2h10v14H3V4z"/>
                        </svg>
                        <span>Bodies</span>
                    </div>
                    <div class="tree-children" id="bodies-list"></div>
                    <div class="tree-item" data-type="folder">
                        <span class="toggle">▼</span>
                        <svg viewBox="0 0 24 24" fill="var(--success)" stroke="none">
                            <path d="M3 4h6l2 2h10v14H3V4z"/>
                        </svg>
                        <span>Sketches</span>
                    </div>
                    <div class="tree-children" id="sketches-list"></div>
                    <div class="tree-item" data-type="folder">
                        <span class="toggle">▶</span>
                        <svg viewBox="0 0 24 24" fill="var(--text-secondary)" stroke="none">
                            <path d="M3 4h6l2 2h10v14H3V4z"/>
                        </svg>
                        <span>Construction</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Viewport -->
        <div class="viewport-container">
            <div class="viewport">
                <canvas id="canvas"></canvas>
                
                <!-- View Cube -->
                <div class="view-cube" id="view-cube">
                    <div class="view-cube-inner" id="view-cube-inner">
                        <div class="cube-face" style="transform: translateZ(40px)" onclick="setView('front')">FRONT</div>
                        <div class="cube-face" style="transform: rotateY(180deg) translateZ(40px)" onclick="setView('back')">BACK</div>
                        <div class="cube-face" style="transform: rotateY(-90deg) translateZ(40px)" onclick="setView('left')">LEFT</div>
                        <div class="cube-face" style="transform: rotateY(90deg) translateZ(40px)" onclick="setView('right')">RIGHT</div>
                        <div class="cube-face" style="transform: rotateX(90deg) translateZ(40px)" onclick="setView('top')">TOP</div>
                        <div class="cube-face" style="transform: rotateX(-90deg) translateZ(40px)" onclick="setView('bottom')">BOTTOM</div>
                    </div>
                </div>

                <!-- Viewport Info -->
                <div class="viewport-info">
                    <div id="view-name">Perspective</div>
                </div>

                <!-- Mode Indicator -->
                <div class="mode-indicator" id="mode-indicator">SKETCH MODE</div>

                <!-- Quick Toolbar -->
                <div class="quick-toolbar">
                    <button class="quick-btn active" id="select-tool" onclick="setTool('select')" title="Select (V)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4l16 8-6 2-2 6-8-16z"/>
                        </svg>
                    </button>
                    <button class="quick-btn" id="move-tool" onclick="setTool('move')" title="Move (M)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2l4 4h-3v5h5V8l4 4-4 4v-3h-5v5h3l-4 4-4-4h3v-5H6v3l-4-4 4-4v3h5V6H8l4-4z"/>
                        </svg>
                    </button>
                    <button class="quick-btn" id="rotate-tool" onclick="setTool('rotate')" title="Rotate (R)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12a9 9 0 11-9-9"/>
                            <path d="M21 3v6h-6"/>
                        </svg>
                    </button>
                    <button class="quick-btn" id="scale-tool" onclick="setTool('scale')" title="Scale (S)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="4" y="4" width="8" height="8"/>
                            <rect x="8" y="8" width="12" height="12"/>
                        </svg>
                    </button>
                    <div style="height:1px;background:var(--border-color);margin:4px 0;width:100%"></div>
                    <button class="quick-btn" onclick="toggleGrid()" title="Toggle Grid (G)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3h18v18H3V3z"/>
                            <path d="M3 9h18M3 15h18M9 3v18M15 3v18"/>
                        </svg>
                    </button>
                    <button class="quick-btn" onclick="toggleSnap()" title="Toggle Snap (X)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="2"/>
                            <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                        </svg>
                    </button>
                </div>

                <!-- Navigation Bar -->
                <div class="navigation-bar">
                    <button class="nav-btn" onclick="setView('home')" title="Home View">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                        </svg>
                    </button>
                    <button class="nav-btn" onclick="fitAll()" title="Fit All">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                        </svg>
                    </button>
                    <button class="nav-btn" onclick="setView('front')" title="Front View">F</button>
                    <button class="nav-btn" onclick="setView('top')" title="Top View">T</button>
                    <button class="nav-btn" onclick="setView('right')" title="Right View">R</button>
                    <button class="nav-btn" onclick="setView('isometric')" title="Isometric View">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                    </button>
                    <div style="width:1px;height:24px;background:var(--border-color)"></div>
                    <button class="nav-btn active" id="orbit-mode" onclick="setNavMode('orbit')" title="Orbit">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M2 12h20"/>
                        </svg>
                    </button>
                    <button class="nav-btn" id="pan-mode" onclick="setNavMode('pan')" title="Pan">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 9l-3 3 3 3"/>
                            <path d="M9 5l3-3 3 3"/>
                            <path d="M15 19l3 3 3-3"/>
                            <path d="M19 9l3 3-3 3"/>
                            <path d="M2 12h20"/>
                            <path d="M12 2v20"/>
                        </svg>
                    </button>
                    <button class="nav-btn" id="zoom-mode" onclick="setNavMode('zoom')" title="Zoom">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                            <path d="M11 8v6M8 11h6"/>
                        </svg>
                    </button>
                </div>

                <!-- Coordinate Display -->
                <div class="coordinate-display" id="coords">X: 0.000  Y: 0.000  Z: 0.000</div>
            </div>

            <!-- Timeline -->
            <div class="timeline-panel">
                <div class="timeline-header">
                    <span>Timeline</span>
                    <div style="margin-left:auto;display:flex;gap:8px">
                        <button class="btn" onclick="undo()" title="Undo (Ctrl+Z)">↶ Undo</button>
                        <button class="btn" onclick="redo()" title="Redo (Ctrl+Y)">↷ Redo</button>
                    </div>
                </div>
                <div class="timeline-content" id="timeline"></div>
            </div>
        </div>

        <!-- Right Panel - Properties -->
        <div class="panel-right" id="properties-panel">
            <div class="panel-header">
                Properties
            </div>
            <div class="panel-content">
                <div class="property-group" id="transform-props">
                    <div class="property-group-header">Transform</div>
                    <div class="property-row">
                        <span class="property-label">Position</span>
                        <div class="property-input-group">
                            <div class="property-input-with-label">
                                <span class="input-label x">X</span>
                                <input type="number" class="property-input" id="pos-x" value="0" step="0.1">
                            </div>
                            <div class="property-input-with-label">
                                <span class="input-label y">Y</span>
                                <input type="number" class="property-input" id="pos-y" value="0" step="0.1">
                            </div>
                            <div class="property-input-with-label">
                                <span class="input-label z">Z</span>
                                <input type="number" class="property-input" id="pos-z" value="0" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Rotation</span>
                        <div class="property-input-group">
                            <div class="property-input-with-label">
                                <span class="input-label x">X</span>
                                <input type="number" class="property-input" id="rot-x" value="0" step="1">
                            </div>
                            <div class="property-input-with-label">
                                <span class="input-label y">Y</span>
                                <input type="number" class="property-input" id="rot-y" value="0" step="1">
                            </div>
                            <div class="property-input-with-label">
                                <span class="input-label z">Z</span>
                                <input type="number" class="property-input" id="rot-z" value="0" step="1">
                            </div>
                        </div>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Scale</span>
                        <div class="property-input-group">
                            <div class="property-input-with-label">
                                <span class="input-label x">X</span>
                                <input type="number" class="property-input" id="scale-x" value="1" step="0.1">
                            </div>
                            <div class="property-input-with-label">
                                <span class="input-label y">Y</span>
                                <input type="number" class="property-input" id="scale-y" value="1" step="0.1">
                            </div>
                            <div class="property-input-with-label">
                                <span class="input-label z">Z</span>
                                <input type="number" class="property-input" id="scale-z" value="1" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="property-group" id="dimension-props">
                    <div class="property-group-header">Dimensions</div>
                    <div id="dimension-fields"></div>
                </div>
                <div class="property-group" id="material-props">
                    <div class="property-group-header">Appearance</div>
                    <div class="material-preview">
                        <div class="material-sphere" id="material-preview-sphere"></div>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Color</span>
                        <div class="color-picker">
                            <input type="color" id="material-color" value="#4a9eff" style="width:32px;height:24px;padding:0;border:none;cursor:pointer">
                            <input type="text" class="property-input" id="material-color-hex" value="#4a9eff" style="width:80px">
                        </div>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Metalness</span>
                        <input type="range" id="material-metalness" min="0" max="1" step="0.01" value="0.3" style="flex:1">
                    </div>
                    <div class="property-row">
                        <span class="property-label">Roughness</span>
                        <input type="range" id="material-roughness" min="0" max="1" step="0.01" value="0.5" style="flex:1">
                    </div>
                </div>
                <div class="property-group" id="info-props">
                    <div class="property-group-header">Information</div>
                    <div class="property-row">
                        <span class="property-label">Volume</span>
                        <span id="info-volume">0.000 mm³</span>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Surface</span>
                        <span id="info-surface">0.000 mm²</span>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Faces</span>
                        <span id="info-faces">0</span>
                    </div>
                    <div class="property-row">
                        <span class="property-label">Vertices</span>
                        <span id="info-vertices">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                <path d="M22 4L12 14.01l-3-3"/>
            </svg>
            <span id="status-text">Ready</span>
        </div>
        <div class="status-item">
            <span>Objects: <span id="object-count">0</span></span>
        </div>
        <div class="status-item">
            <span>Selected: <span id="selected-count">0</span></span>
        </div>
        <div class="status-bar-right">
            <div class="units-selector">
                <span class="units-option active" onclick="setUnits('mm')">mm</span>
                <span class="units-option" onclick="setUnits('cm')">cm</span>
                <span class="units-option" onclick="setUnits('m')">m</span>
                <span class="units-option" onclick="setUnits('in')">in</span>
            </div>
            <span id="memory-usage">Memory: 0 MB</span>
            <span id="fps-display">FPS: 60</span>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="duplicateSelected()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2"/>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
            </svg>
            Duplicate
            <span class="shortcut">Ctrl+D</span>
        </div>
        <div class="context-menu-item" onclick="deleteSelected()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
            Delete
            <span class="shortcut">Del</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="groupSelected()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
            </svg>
            Group
            <span class="shortcut">Ctrl+G</span>
        </div>
        <div class="context-menu-item" onclick="hideSelected()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
            Hide
            <span class="shortcut">H</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="editParameters()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
            Edit Parameters
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-new-project">
        <div class="modal">
            <div class="modal-header">
                New Project
                <div class="modal-close" onclick="closeModal('modal-new-project')">✕</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="new-project-name" value="Untitled Project">
                </div>
                <div class="form-group">
                    <label class="form-label">Units</label>
                    <select class="form-select" id="new-project-units">
                        <option value="mm">Millimeters (mm)</option>
                        <option value="cm">Centimeters (cm)</option>
                        <option value="m">Meters (m)</option>
                        <option value="in">Inches (in)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-new-project')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewProject()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-export">
        <div class="modal">
            <div class="modal-header">
                Export
                <div class="modal-close" onclick="closeModal('modal-export')">✕</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Format</label>
                    <select class="form-select" id="export-format">
                        <option value="cadpro">.cadpro (CAD Project)</option>
                        <option value="stl">.stl (Stereolithography)</option>
                        <option value="obj">.obj (Wavefront OBJ)</option>
                        <option value="gltf">.gltf (GL Transmission Format)</option>
                        <option value="step">.step (STEP/ISO 10303)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">File Name</label>
                    <input type="text" class="form-input" id="export-filename" value="export">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-export')">Cancel</button>
                <button class="btn btn-primary" onclick="doExport()">Export</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-primitive">
        <div class="modal">
            <div class="modal-header">
                <span id="primitive-modal-title">Create Box</span>
                <div class="modal-close" onclick="closeModal('modal-primitive')">✕</div>
            </div>
            <div class="modal-body" id="primitive-params"></div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-primitive')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmPrimitive()">Create</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notification-text">Saved successfully</span>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <span>Loading...</span>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ============================================
        // CAD PRO - Professional 3D CAD Application
        // ============================================

        // Global State
        const state = {
            projectName: 'Untitled Project',
            units: 'mm',
            objects: [],
            selectedObjects: [],
            history: [],
            historyIndex: -1,
            maxHistory: 100,
            currentTool: 'select',
            navMode: 'orbit',
            sketchMode: false,
            gridVisible: true,
            snapEnabled: true,
            snapSize: 10,
            autoSaveInterval: 30000,
            lastSave: null
        };

        // Three.js Setup
        let scene, camera, renderer, controls;
        let gridHelper, axesHelper;
        let transformControls;
        let raycaster, mouse;
        let selectedMesh = null;

        // Initialize Application
        function init() {
            setupThreeJS();
            setupEventListeners();
            setupAutoSave();
            loadFromLocalStorage();
            animate();
            updateUI();
            showNotification('CAD Pro initialized', 'success');
        }

        function setupThreeJS() {
            const canvas = document.getElementById('canvas');
            const container = canvas.parentElement;

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1e1e1e);

            // Camera
            camera = new THREE.PerspectiveCamera(
                45,
                container.clientWidth / container.clientHeight,
                0.1,
                10000
            );
            camera.position.set(100, 80, 100);
            camera.lookAt(0, 0, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                antialias: true,
                alpha: true
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1;

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 500;
            directionalLight.shadow.camera.left = -100;
            directionalLight.shadow.camera.right = 100;
            directionalLight.shadow.camera.top = 100;
            directionalLight.shadow.camera.bottom = -100;
            scene.add(directionalLight);

            const fillLight = new THREE.DirectionalLight(0x4488ff, 0.3);
            fillLight.position.set(-50, 50, -50);
            scene.add(fillLight);

            // Grid
            gridHelper = new THREE.GridHelper(1000, 100, 0x444444, 0x333333);
            scene.add(gridHelper);

            // Axes Helper
            axesHelper = new THREE.AxesHelper(50);
            scene.add(axesHelper);

            // Ground plane (for shadows)
            const groundGeometry = new THREE.PlaneGeometry(1000, 1000);
            const groundMaterial = new THREE.ShadowMaterial({ opacity: 0.3 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            ground.name = 'ground';
            scene.add(ground);

            // Raycaster
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Orbit Controls (manual implementation)
            setupOrbitControls();

            // Handle resize
            window.addEventListener('resize', onWindowResize);
        }

        // Manual Orbit Controls
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let spherical = { radius: 150, phi: Math.PI / 4, theta: Math.PI / 4 };

        function setupOrbitControls() {
            const canvas = renderer.domElement;

            canvas.addEventListener('mousedown', (e) => {
                if (e.button === 0 && state.currentTool === 'select') {
                    checkSelection(e);
                } else if (e.button === 1 || (e.button === 0 && state.navMode === 'pan')) {
                    isDragging = true;
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                } else if (e.button === 2 || (e.button === 0 && state.navMode === 'orbit')) {
                    isDragging = true;
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                updateCoordinates(e);
                
                if (!isDragging) return;

                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;

                if (state.navMode === 'orbit' || e.buttons === 2) {
                    spherical.theta -= deltaX * 0.005;
                    spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi + deltaY * 0.005));
                } else if (state.navMode === 'pan' || e.buttons === 4) {
                    const offset = new THREE.Vector3(-deltaX * 0.5, deltaY * 0.5, 0);
                    offset.applyQuaternion(camera.quaternion);
                    camera.position.add(offset);
                }

                updateCameraPosition();
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                spherical.radius = Math.max(10, Math.min(1000, spherical.radius + e.deltaY * 0.5));
                updateCameraPosition();
            });

            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });

            updateCameraPosition();
        }

        function updateCameraPosition() {
            const target = new THREE.Vector3(0, 0, 0);
            camera.position.x = target.x + spherical.radius * Math.sin(spherical.phi) * Math.cos(spherical.theta);
            camera.position.y = target.y + spherical.radius * Math.cos(spherical.phi);
            camera.position.z = target.z + spherical.radius * Math.sin(spherical.phi) * Math.sin(spherical.theta);
            camera.lookAt(target);
            updateViewCube();
        }

        function updateViewCube() {
            const cube = document.getElementById('view-cube-inner');
            if (cube) {
                const euler = new THREE.Euler().setFromQuaternion(camera.quaternion, 'YXZ');
                cube.style.transform = `rotateX(${-euler.x}rad) rotateY(${-euler.y}rad)`;
            }
        }

        function updateCoordinates(e) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
            const point = new THREE.Vector3();
            raycaster.ray.intersectPlane(plane, point);

            if (point) {
                document.getElementById('coords').textContent = 
                    `X: ${point.x.toFixed(3)}  Y: ${point.y.toFixed(3)}  Z: ${point.z.toFixed(3)}`;
            }
        }

        function checkSelection(e) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const selectables = state.objects.map(o => o.mesh).filter(m => m);
            const intersects = raycaster.intersectObjects(selectables, true);

            if (intersects.length > 0) {
                let target = intersects[0].object;
                while (target.parent && !state.objects.find(o => o.mesh === target)) {
                    target = target.parent;
                }
                selectObject(target);
            } else {
                deselectAll();
            }
        }

        function selectObject(mesh) {
            deselectAll();
            
            const obj = state.objects.find(o => o.mesh === mesh);
            if (!obj) return;

            selectedMesh = mesh;
            state.selectedObjects = [obj];

            // Highlight
            if (mesh.material) {
                mesh.userData.originalMaterial = mesh.material.clone();
                mesh.material.emissive = new THREE.Color(0x0066ff);
                mesh.material.emissiveIntensity = 0.2;
            }

            updatePropertiesPanel();
            updateBrowserSelection(obj.id);
            document.getElementById('selected-count').textContent = '1';
        }

        function deselectAll() {
            state.selectedObjects.forEach(obj => {
                if (obj.mesh && obj.mesh.userData.originalMaterial) {
                    obj.mesh.material.emissive = new THREE.Color(0x000000);
                    obj.mesh.material.emissiveIntensity = 0;
                }
            });
            selectedMesh = null;
            state.selectedObjects = [];
            document.getElementById('selected-count').textContent = '0';
            clearPropertiesPanel();
        }

        function onWindowResize() {
            const container = renderer.domElement.parentElement;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // Animation Loop
        let lastTime = 0;
        let frameCount = 0;
        let fps = 60;

        function animate(time) {
            requestAnimationFrame(animate);
            
            // FPS calculation
            frameCount++;
            if (time - lastTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = time;
                document.getElementById('fps-display').textContent = `FPS: ${fps}`;
            }

            renderer.render(scene, camera);
        }

        // ============================================
        // PRIMITIVE CREATION
        // ============================================

        let pendingPrimitive = null;

        function createPrimitive(type) {
            pendingPrimitive = type;
            const modal = document.getElementById('modal-primitive');
            const title = document.getElementById('primitive-modal-title');
            const params = document.getElementById('primitive-params');

            title.textContent = `Create ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            
            let html = '';
            switch(type) {
                case 'box':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Width (X)</label>
                            <input type="number" class="form-input" id="param-width" value="50" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Height (Y)</label>
                            <input type="number" class="form-input" id="param-height" value="50" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Depth (Z)</label>
                            <input type="number" class="form-input" id="param-depth" value="50" step="1">
                        </div>
                    `;
                    break;
                case 'cylinder':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Radius</label>
                            <input type="number" class="form-input" id="param-radius" value="25" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Height</label>
                            <input type="number" class="form-input" id="param-height" value="50" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Segments</label>
                            <input type="number" class="form-input" id="param-segments" value="32" step="1" min="3">
                        </div>
                    `;
                    break;
                case 'sphere':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Radius</label>
                            <input type="number" class="form-input" id="param-radius" value="25" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Width Segments</label>
                            <input type="number" class="form-input" id="param-wsegments" value="32" step="1" min="3">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Height Segments</label>
                            <input type="number" class="form-input" id="param-hsegments" value="16" step="1" min="2">
                        </div>
                    `;
                    break;
                case 'cone':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Radius</label>
                            <input type="number" class="form-input" id="param-radius" value="25" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Height</label>
                            <input type="number" class="form-input" id="param-height" value="50" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Segments</label>
                            <input type="number" class="form-input" id="param-segments" value="32" step="1" min="3">
                        </div>
                    `;
                    break;
                case 'torus':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Radius</label>
                            <input type="number" class="form-input" id="param-radius" value="30" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tube Radius</label>
                            <input type="number" class="form-input" id="param-tube" value="10" step="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Radial Segments</label>
                            <input type="number" class="form-input" id="param-rsegments" value="16" step="1" min="3">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tubular Segments</label>
                            <input type="number" class="form-input" id="param-tsegments" value="32" step="1" min="3">
                        </div>
                    `;
                    break;
            }

            params.innerHTML = html;
            modal.classList.add('visible');
        }

        function confirmPrimitive() {
            let geometry;
            let params = {};
            
            switch(pendingPrimitive) {
                case 'box':
                    params = {
                        width: parseFloat(document.getElementById('param-width').value),
                        height: parseFloat(document.getElementById('param-height').value),
                        depth: parseFloat(document.getElementById('param-depth').value)
                    };
                    geometry = new THREE.BoxGeometry(params.width, params.height, params.depth);
                    break;
                case 'cylinder':
                    params = {
                        radius: parseFloat(document.getElementById('param-radius').value),
                        height: parseFloat(document.getElementById('param-height').value),
                        segments: parseInt(document.getElementById('param-segments').value)
                    };
                    geometry = new THREE.CylinderGeometry(params.radius, params.radius, params.height, params.segments);
                    break;
                case 'sphere':
                    params = {
                        radius: parseFloat(document.getElementById('param-radius').value),
                        widthSegments: parseInt(document.getElementById('param-wsegments').value),
                        heightSegments: parseInt(document.getElementById('param-hsegments').value)
                    };
                    geometry = new THREE.SphereGeometry(params.radius, params.widthSegments, params.heightSegments);
                    break;
                case 'cone':
                    params = {
                        radius: parseFloat(document.getElementById('param-radius').value),
                        height: parseFloat(document.getElementById('param-height').value),
                        segments: parseInt(document.getElementById('param-segments').value)
                    };
                    geometry = new THREE.ConeGeometry(params.radius, params.height, params.segments);
                    break;
                case 'torus':
                    params = {
                        radius: parseFloat(document.getElementById('param-radius').value),
                        tube: parseFloat(document.getElementById('param-tube').value),
                        radialSegments: parseInt(document.getElementById('param-rsegments').value),
                        tubularSegments: parseInt(document.getElementById('param-tsegments').value)
                    };
                    geometry = new THREE.TorusGeometry(params.radius, params.tube, params.radialSegments, params.tubularSegments);
                    break;
            }

            const material = new THREE.MeshStandardMaterial({
                color: 0x4a9eff,
                metalness: 0.3,
                roughness: 0.5
            });

            const mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.position.y = pendingPrimitive === 'box' ? params.height / 2 : 
                              pendingPrimitive === 'cylinder' ? params.height / 2 :
                              pendingPrimitive === 'cone' ? params.height / 2 :
                              pendingPrimitive === 'sphere' ? params.radius :
                              params.radius + params.tube;

            scene.add(mesh);

            const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
            const obj = {
                id: id,
                name: `${pendingPrimitive.charAt(0).toUpperCase() + pendingPrimitive.slice(1)} ${state.objects.length + 1}`,
                type: pendingPrimitive,
                params: params,
                mesh: mesh,
                position: mesh.position.clone(),
                rotation: mesh.rotation.clone(),
                scale: mesh.scale.clone(),
                material: {
                    color: '#4a9eff',
                    metalness: 0.3,
                    roughness: 0.5
                },
                visible: true,
                locked: false
            };

            state.objects.push(obj);
            addToHistory('create', obj);
            updateBrowser();
            updateTimeline();
            updateUI();

            closeModal('modal-primitive');
            selectObject(mesh);
            showNotification(`${obj.name} created`, 'success');
        }

        // ============================================
        // HISTORY / UNDO-REDO
        // ============================================

        function addToHistory(action, data) {
            // Remove any redo history
            if (state.historyIndex < state.history.length - 1) {
                state.history = state.history.slice(0, state.historyIndex + 1);
            }

            state.history.push({
                action: action,
                data: JSON.parse(JSON.stringify(data, (key, value) => {
                    if (value instanceof THREE.Object3D) return undefined;
                    return value;
                })),
                timestamp: Date.now()
            });

            if (state.history.length > state.maxHistory) {
                state.history.shift();
            } else {
                state.historyIndex++;
            }

            saveToLocalStorage();
        }

        function undo() {
            if (state.historyIndex < 0) {
                showNotification('Nothing to undo', 'warning');
                return;
            }

            const entry = state.history[state.historyIndex];
            
            switch(entry.action) {
                case 'create':
                    const obj = state.objects.find(o => o.id === entry.data.id);
                    if (obj && obj.mesh) {
                        scene.remove(obj.mesh);
                        state.objects = state.objects.filter(o => o.id !== entry.data.id);
                    }
                    break;
                // Add more undo actions as needed
            }

            state.historyIndex--;
            updateBrowser();
            updateTimeline();
            updateUI();
            showNotification('Undo successful', 'success');
        }

        function redo() {
            if (state.historyIndex >= state.history.length - 1) {
                showNotification('Nothing to redo', 'warning');
                return;
            }

            state.historyIndex++;
            const entry = state.history[state.historyIndex];

            switch(entry.action) {
                case 'create':
                    // Recreate the object
                    createPrimitiveFromData(entry.data);
                    break;
            }

            updateBrowser();
            updateTimeline();
            updateUI();
            showNotification('Redo successful', 'success');
        }

        function createPrimitiveFromData(data) {
            let geometry;
            switch(data.type) {
                case 'box':
                    geometry = new THREE.BoxGeometry(data.params.width, data.params.height, data.params.depth);
                    break;
                case 'cylinder':
                    geometry = new THREE.CylinderGeometry(data.params.radius, data.params.radius, data.params.height, data.params.segments);
                    break;
                case 'sphere':
                    geometry = new THREE.SphereGeometry(data.params.radius, data.params.widthSegments, data.params.heightSegments);
                    break;
                case 'cone':
                    geometry = new THREE.ConeGeometry(data.params.radius, data.params.height, data.params.segments);
                    break;
                case 'torus':
                    geometry = new THREE.TorusGeometry(data.params.radius, data.params.tube, data.params.radialSegments, data.params.tubularSegments);
                    break;
            }

            const material = new THREE.MeshStandardMaterial({
                color: data.material.color,
                metalness: data.material.metalness,
                roughness: data.material.roughness
            });

            const mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.position.set(data.position.x, data.position.y, data.position.z);
            mesh.rotation.set(data.rotation._x, data.rotation._y, data.rotation._z);
            mesh.scale.set(data.scale.x, data.scale.y, data.scale.z);

            scene.add(mesh);

            data.mesh = mesh;
            state.objects.push(data);
        }

        // ============================================
        // UI UPDATES
        // ============================================

        function updateBrowser() {
            const bodiesList = document.getElementById('bodies-list');
            bodiesList.innerHTML = '';

            state.objects.forEach(obj => {
                const item = document.createElement('div');
                item.className = 'tree-item';
                item.dataset.id = obj.id;
                item.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="${obj.visible ? 'var(--accent)' : 'var(--text-secondary)'}" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    <span>${obj.name}</span>
                `;
                item.onclick = () => {
                    if (obj.mesh) selectObject(obj.mesh);
                };
                bodiesList.appendChild(item);
            });
        }

        function updateBrowserSelection(id) {
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.id === id) {
                    item.classList.add('selected');
                }
            });
        }

        function updateTimeline() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';

            state.history.forEach((entry, index) => {
                if (index > 0) {
                    const connector = document.createElement('div');
                    connector.className = 'timeline-connector';
                    timeline.appendChild(connector);
                }

                const item = document.createElement('div');
                item.className = `timeline-item ${index <= state.historyIndex ? 'selected' : ''}`;
                
                let icon = '';
                switch(entry.action) {
                    case 'create':
                        icon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>`;
                        break;
                    case 'modify':
                        icon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                        </svg>`;
                        break;
                    case 'delete':
                        icon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/>
                        </svg>`;
                        break;
                    default:
                        icon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>`;
                }

                item.innerHTML = `${icon}<span>${entry.action}</span>`;
                item.onclick = () => jumpToHistoryState(index);
                timeline.appendChild(item);
            });
        }

        function jumpToHistoryState(index) {
            // This would require a more complex implementation
            showNotification('History navigation not fully implemented', 'warning');
        }

        function updateUI() {
            document.getElementById('object-count').textContent = state.objects.length;
            
            // Memory usage (approximate)
            const memory = (performance.memory?.usedJSHeapSize / 1048576 || 0).toFixed(1);
            document.getElementById('memory-usage').textContent = `Memory: ${memory} MB`;
        }

        function updatePropertiesPanel() {
            if (state.selectedObjects.length === 0) return;

            const obj = state.selectedObjects[0];
            const mesh = obj.mesh;

            if (!mesh) return;

            // Transform
            document.getElementById('pos-x').value = mesh.position.x.toFixed(2);
            document.getElementById('pos-y').value = mesh.position.y.toFixed(2);
            document.getElementById('pos-z').value = mesh.position.z.toFixed(2);

            document.getElementById('rot-x').value = THREE.MathUtils.radToDeg(mesh.rotation.x).toFixed(1);
            document.getElementById('rot-y').value = THREE.MathUtils.radToDeg(mesh.rotation.y).toFixed(1);
            document.getElementById('rot-z').value = THREE.MathUtils.radToDeg(mesh.rotation.z).toFixed(1);

            document.getElementById('scale-x').value = mesh.scale.x.toFixed(2);
            document.getElementById('scale-y').value = mesh.scale.y.toFixed(2);
            document.getElementById('scale-z').value = mesh.scale.z.toFixed(2);

            // Material
            if (mesh.material) {
                const color = '#' + mesh.material.color.getHexString();
                document.getElementById('material-color').value = color;
                document.getElementById('material-color-hex').value = color;
                document.getElementById('material-metalness').value = mesh.material.metalness;
                document.getElementById('material-roughness').value = mesh.material.roughness;
            }

            // Dimensions (based on type)
            const dimFields = document.getElementById('dimension-fields');
            let html = '';
            
            if (obj.params) {
                for (const [key, value] of Object.entries(obj.params)) {
                    html += `
                        <div class="property-row">
                            <span class="property-label">${key.charAt(0).toUpperCase() + key.slice(1)}</span>
                            <input type="number" class="property-input" value="${value}" 
                                   onchange="updateParameter('${obj.id}', '${key}', this.value)">
                        </div>
                    `;
                }
            }
            dimFields.innerHTML = html;

            // Info
            if (mesh.geometry) {
                const geo = mesh.geometry;
                geo.computeBoundingBox();
                const box = geo.boundingBox;
                const size = new THREE.Vector3();
                box.getSize(size);
                
                const volume = size.x * size.y * size.z;
                const surface = 2 * (size.x * size.y + size.y * size.z + size.z * size.x);
                
                document.getElementById('info-volume').textContent = volume.toFixed(3) + ' mm³';
                document.getElementById('info-surface').textContent = surface.toFixed(3) + ' mm²';
                
                // Estimate faces/vertices for BufferGeometry
                const vertexCount = geo.attributes.position.count;
                const faceCount = geo.index ? geo.index.count / 3 : vertexCount / 3;
                
                document.getElementById('info-faces').textContent = Math.floor(faceCount);
                document.getElementById('info-vertices').textContent = vertexCount;
            }
        }

        function clearPropertiesPanel() {
            document.getElementById('pos-x').value = 0;
            document.getElementById('pos-y').value = 0;
            document.getElementById('pos-z').value = 0;
            document.getElementById('dimension-fields').innerHTML = '';
            document.getElementById('info-volume').textContent = '0.000 mm³';
            document.getElementById('info-surface').textContent = '0.000 mm²';
            document.getElementById('info-faces').textContent = '0';
            document.getElementById('info-vertices').textContent = '0';
        }

        // ============================================
        // EVENT LISTENERS & LOGIC
        // ============================================

        function setupEventListeners() {
            // Ribbon Tabs
            document.querySelectorAll('.ribbon-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.ribbon-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    // In a full app, this would switch ribbon content
                });
            });

            // Transform Inputs
            ['pos', 'rot', 'scale'].forEach(type => {
                ['x', 'y', 'z'].forEach(axis => {
                    const id = `${type}-${axis}`;
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', (e) => {
                            if (!selectedMesh) return;
                            const val = parseFloat(e.target.value);
                            
                            if (type === 'pos') selectedMesh.position[axis] = val;
                            if (type === 'rot') selectedMesh.rotation[axis] = THREE.MathUtils.degToRad(val);
                            if (type === 'scale') selectedMesh.scale[axis] = val;
                            
                            // Update stored object data
                            const obj = state.selectedObjects[0];
                            if (obj) {
                                obj.position = selectedMesh.position.clone();
                                obj.rotation = selectedMesh.rotation.clone();
                                obj.scale = selectedMesh.scale.clone();
                            }
                            
                            // Trigger auto-save
                            requestAutoSave();
                        });
                    }
                });
            });

            // Material Inputs
            document.getElementById('material-color').addEventListener('input', (e) => {
                if (!selectedMesh) return;
                selectedMesh.material.color.set(e.target.value);
                document.getElementById('material-color-hex').value = e.target.value;
                updateObjectMaterialData();
            });

            document.getElementById('material-metalness').addEventListener('input', (e) => {
                if (!selectedMesh) return;
                selectedMesh.material.metalness = parseFloat(e.target.value);
                updateObjectMaterialData();
            });

            document.getElementById('material-roughness').addEventListener('input', (e) => {
                if (!selectedMesh) return;
                selectedMesh.material.roughness = parseFloat(e.target.value);
                updateObjectMaterialData();
            });

            // Keyboards Shortcuts
            window.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT') return; // Don't trigger when typing

                switch(e.key.toLowerCase()) {
                    case 'delete': deleteSelected(); break;
                    case 'z': if (e.ctrlKey) undo(); break;
                    case 'y': if (e.ctrlKey) redo(); break;
                    case 'h': hideSelected(); break;
                    case 'f': fitAll(); break;
                    case 'v': setTool('select'); break;
                    case 'm': setTool('move'); break;
                    case 'r': setTool('rotate'); break;
                    case 's': setTool('scale'); break;
                    case 'g': toggleGrid(); break;
                }
            });
        }

        function updateObjectMaterialData() {
            const obj = state.selectedObjects[0];
            if (obj && selectedMesh) {
                obj.material = {
                    color: '#' + selectedMesh.material.color.getHexString(),
                    metalness: selectedMesh.material.metalness,
                    roughness: selectedMesh.material.roughness
                };
            }
        }

        function updateParameter(id, key, value) {
            const obj = state.objects.find(o => o.id === id);
            if (!obj) return;

            obj.params[key] = parseFloat(value);
            
            // Recreate geometry
            if (obj.mesh) {
                scene.remove(obj.mesh);
                obj.mesh.geometry.dispose();
                createPrimitiveFromData(obj); // Reuse this to regenerate mesh
                
                // Restore selection
                selectObject(obj.mesh);
                showNotification('Parameter updated', 'success');
            }
        }

        // ============================================
        // TOOLS & VIEW
        // ============================================

        function setTool(tool) {
            state.currentTool = tool;
            
            // UI Update
            document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById(`${tool}-tool`);
            if (btn) btn.classList.add('active');

            document.getElementById('status-text').textContent = `Tool: ${tool.charAt(0).toUpperCase() + tool.slice(1)}`;
        }

        function setNavMode(mode) {
            state.navMode = mode;
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById(`${mode}-mode`);
            if (btn) btn.classList.add('active');
        }

        function setView(view) {
            const dist = 150;
            switch(view) {
                case 'home':
                case 'isometric':
                    spherical = { radius: dist, phi: Math.PI / 4, theta: Math.PI / 4 };
                    break;
                case 'front':
                    spherical = { radius: dist, phi: Math.PI / 2, theta: 0 };
                    break;
                case 'back':
                    spherical = { radius: dist, phi: Math.PI / 2, theta: Math.PI };
                    break;
                case 'left':
                    spherical = { radius: dist, phi: Math.PI / 2, theta: -Math.PI / 2 };
                    break;
                case 'right':
                    spherical = { radius: dist, phi: Math.PI / 2, theta: Math.PI / 2 };
                    break;
                case 'top':
                    spherical = { radius: dist, phi: 0.01, theta: 0 };
                    break;
                case 'bottom':
                    spherical = { radius: dist, phi: Math.PI - 0.01, theta: 0 };
                    break;
            }
            updateCameraPosition();
            document.getElementById('view-name').textContent = view.charAt(0).toUpperCase() + view.slice(1);
        }

        function fitAll() {
            if (state.objects.length === 0) {
                setView('home');
                return;
            }

            const box = new THREE.Box3();
            state.objects.forEach(obj => {
                if (obj.mesh) box.expandByObject(obj.mesh);
            });

            const center = new THREE.Vector3();
            box.getCenter(center);
            
            // Reset orbit target (simplified)
            spherical.radius = 150;
            updateCameraPosition();
        }

        function toggleGrid() {
            state.gridVisible = !state.gridVisible;
            if (gridHelper) gridHelper.visible = state.gridVisible;
            if (axesHelper) axesHelper.visible = state.gridVisible;
            // Also toggle ground plane if needed
            const ground = scene.getObjectByName('ground');
            if(ground) ground.visible = state.gridVisible;
        }

        function deleteSelected() {
            if (state.selectedObjects.length === 0) return;

            const count = state.selectedObjects.length;
            
            state.selectedObjects.forEach(obj => {
                if (obj.mesh) {
                    scene.remove(obj.mesh);
                    if (obj.mesh.geometry) obj.mesh.geometry.dispose();
                    if (obj.mesh.material) obj.mesh.material.dispose();
                }
                
                state.objects = state.objects.filter(o => o.id !== obj.id);
            });

            addToHistory('delete', null); // Simplified history entry
            deselectAll();
            updateBrowser();
            updateTimeline();
            updateUI();
            showNotification(`Deleted ${count} object(s)`, 'success');
        }

        function duplicateSelected() {
            if (state.selectedObjects.length === 0) return;
            
            const original = state.selectedObjects[0];
            const cloneData = JSON.parse(JSON.stringify(original, (key, value) => {
                if (value instanceof THREE.Object3D) return undefined;
                return value;
            }));
            
            cloneData.id = Date.now().toString(36);
            cloneData.name = original.name + ' (Copy)';
            cloneData.position.x += 10; // Offset slightly
            
            createPrimitiveFromData(cloneData);
            updateBrowser();
            showNotification('Object duplicated', 'success');
        }

        function hideSelected() {
            state.selectedObjects.forEach(obj => {
                if (obj.mesh) {
                    obj.visible = !obj.visible;
                    obj.mesh.visible = obj.visible;
                }
            });
            updateBrowser(); // Re-render to update eye icon
        }

        // ============================================
        // STORAGE & PROJECT
        // ============================================

        function saveToLocalStorage() {
            const projectData = {
                name: state.projectName,
                units: state.units,
                objects: state.objects.map(o => ({
                    ...o,
                    mesh: undefined // Don't save Three.js objects
                })),
                timestamp: Date.now()
            };
            
            localStorage.setItem('cad_pro_project', JSON.stringify(projectData));
            state.lastSave = Date.now();
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('cad_pro_project');
            if (data) {
                try {
                    const project = JSON.parse(data);
                    state.projectName = project.name;
                    state.units = project.units;
                    document.querySelector('.app-title').textContent = `CAD Pro - ${state.projectName}`;
                    
                    // Recreate objects
                    if (project.objects) {
                        project.objects.forEach(objData => {
                            createPrimitiveFromData(objData);
                        });
                    }
                    updateBrowser();
                } catch(e) {
                    console.error('Failed to load project', e);
                }
            }
        }

        function setupAutoSave() {
            setInterval(() => {
                if (state.objects.length > 0) {
                    saveToLocalStorage();
                }
            }, state.autoSaveInterval);
        }

        function requestAutoSave() {
            // Debounced save could go here
            saveToLocalStorage();
        }

        function showFileMenu() { showModal('modal-new-project'); } // Simplified
        function showExportMenu() { showModal('modal-export'); }
        
        function createNewProject() {
            const name = document.getElementById('new-project-name').value;
            state.projectName = name;
            state.units = document.getElementById('new-project-units').value;
            
            // Clear scene
            while(scene.children.length > 0){ 
                scene.remove(scene.children[0]); 
            }
            state.objects = [];
            state.selectedObjects = [];
            state.history = [];
            state.historyIndex = -1;
            
            // Re-init basics
            setupThreeJS(); // Re-adds lights/grid
            
            closeModal('modal-new-project');
            document.querySelector('.app-title').textContent = `CAD Pro - ${name}`;
            updateBrowser();
            showNotification('New project created', 'success');
        }

        function doExport() {
            const format = document.getElementById('export-format').value;
            const filename = document.getElementById('export-filename').value;
            
            showLoading(true);
            
            setTimeout(() => {
                // Mock export
                showLoading(false);
                closeModal('modal-export');
                showNotification(`Project exported as ${filename}.${format}`, 'success');
            }, 1000);
        }

        // ============================================
        // UI HELPERS
        // ============================================

        function closeModal(id) {
            document.getElementById(id).classList.remove('visible');
        }

        function showModal(id) {
            document.getElementById(id).classList.add('visible');
        }

        function showNotification(text, type = 'info') {
            const notif = document.getElementById('notification');
            const txt = document.getElementById('notification-text');
            
            txt.textContent = text;
            notif.className = `notification visible ${type}`;
            
            setTimeout(() => {
                notif.classList.remove('visible');
            }, 3000);
        }

        function showLoading(show) {
            const el = document.getElementById('loading');
            if (show) el.classList.add('visible');
            else el.classList.remove('visible');
        }

        function setUnits(unit) {
            state.units = unit;
            document.querySelectorAll('.units-option').forEach(opt => {
                if(opt.textContent === unit) opt.classList.add('active');
                else opt.classList.remove('active');
            });
            showNotification(`Units set to ${unit}`, 'info');
        }

        // Context Menu Handler
        window.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const menu = document.getElementById('context-menu');
            if (state.selectedObjects.length > 0) {
                menu.style.left = e.clientX + 'px';
                menu.style.top = e.clientY + 'px';
                menu.classList.add('visible');
            }
        });

        window.addEventListener('click', () => {
            document.getElementById('context-menu').classList.remove('visible');
        });

        // Placeholder functions for menu items
        function showFileMenu() { showModal('modal-new-project'); }
        function showEditMenu() { showNotification('Edit Menu', 'info'); }
        function showViewMenu() { showNotification('View Menu', 'info'); }
        function showInsertMenu() { showNotification('Insert Menu', 'info'); }
        function showModifyMenu() { showNotification('Modify Menu', 'info'); }
        function showSketchMenu() { showNotification('Sketch Menu', 'info'); }
        function showAssembleMenu() { showNotification('Assemble Menu', 'info'); }
        function showToolsMenu() { showModal('modal-export'); }
        
        // Placeholder functions for ribbon buttons not implemented yet
        function createSketch() { 
            state.sketchMode = !state.sketchMode;
            document.getElementById('mode-indicator').classList.toggle('visible', state.sketchMode);
            if(state.sketchMode) setView('top');
            showNotification(state.sketchMode ? 'Entering Sketch Mode' : 'Exiting Sketch Mode');
        }
        function extrude() { showNotification('Select a profile to extrude', 'warning'); }
        function revolve() { showNotification('Select a profile and axis', 'warning'); }
        function sweep() { showNotification('Select profile and path', 'warning'); }
        function loft() { showNotification('Select profiles', 'warning'); }
        function boolUnion() { showNotification('Select bodies to combine', 'warning'); }
        function boolSubtract() { showNotification('Select target and tool bodies', 'warning'); }
        function boolIntersect() { showNotification('Select overlapping bodies', 'warning'); }
        function fillet() { showNotification('Select edges to fillet', 'warning'); }
        function chamfer() { showNotification('Select edges to chamfer', 'warning'); }
        function shell() { showNotification('Select face to remove', 'warning'); }
        function draft() { showNotification('Select neutral plane and faces', 'warning'); }
        function patternRectangular() { showNotification('Feature not implemented in demo', 'warning'); }
        function patternCircular() { showNotification('Feature not implemented in demo', 'warning'); }
        function mirror() { showNotification('Select object and mirror plane', 'warning'); }
        function groupSelected() { showNotification('Objects grouped', 'success'); }
        function editParameters() { showNotification('Use Properties panel', 'info'); }

        // Start Application
        init();

    </script>
</body>
</html>
