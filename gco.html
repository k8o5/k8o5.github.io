<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Chess Online</title>
    
    <!-- 1. JQUERY (Benötigt für Chessboard.js) -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    
    <!-- 2. CHESSBOARD.JS (Grafik) -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    
    <!-- 3. CHESS.JS (Logik) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- 4. PEERJS (Netzwerk) & QR CODE -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* AAA STYLING */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #1e1e1e; 
            color: #e0e0e0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
        }

        h1 { margin-bottom: 10px; font-weight: 300; letter-spacing: 2px; }

        .container { 
            width: 100%; 
            max-width: 500px; 
            padding: 20px; 
            text-align: center; 
        }

        /* Screens */
        .screen { display: none; animation: fadeIn 0.5s; }
        .active { display: block; }

        /* Buttons & Inputs */
        .btn { 
            background: #4caf50; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            font-size: 1.1rem; 
            border-radius: 50px; 
            cursor: pointer; 
            margin: 10px; 
            transition: all 0.3s; 
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
        .btn-outline { background: transparent; border: 2px solid #4caf50; color: #4caf50; }
        .btn-outline:hover { background: #4caf50; color: white; }

        input { 
            background: #333; 
            border: 1px solid #555; 
            color: white; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
            font-size: 1.2rem; 
            width: 60%;
            text-transform: uppercase;
        }

        /* Lobby */
        #display-code { 
            font-family: monospace; 
            font-size: 2.5rem; 
            color: #ffd700; 
            background: #333; 
            padding: 10px; 
            border-radius: 8px; 
            margin: 10px 0; 
            letter-spacing: 5px;
        }
        #qrcode { 
            background: white; 
            padding: 15px; 
            display: inline-block; 
            border-radius: 10px; 
            margin-top: 15px; 
        }

        /* Chess Board */
        #myBoard { 
            width: 100%; 
            margin: 0 auto; 
            border: 5px solid #444;
            border-radius: 4px;
        }
        
        .status-bar {
            margin-top: 15px;
            padding: 10px;
            background: #333;
            border-radius: 8px;
            font-weight: bold;
        }
        .turn-indicator { color: #4caf50; }
        .turn-wait { color: #ff9800; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>MASTER CHESS</h1>

        <!-- MENU SCREEN -->
        <div id="menu-screen" class="screen active">
            <p>Ein kostenloses P2P Schachspiel.</p>
            <button class="btn" onclick="createLobby()">Spiel Hosten</button>
            <br>
            <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                <input type="text" id="join-code" placeholder="CODE EINGEBEN" maxlength="4">
                <br>
                <button class="btn btn-outline" onclick="joinLobby()">Beitreten</button>
            </div>
        </div>

        <!-- LOBBY SCREEN -->
        <div id="lobby-screen" class="screen">
            <h3>Lobby Code</h3>
            <div id="display-code">...</div>
            <div id="qrcode"></div>
            <p style="color: #aaa; margin-top: 20px;">Warte auf Gegner...</p>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div id="status" class="status-bar">Verbinde...</div>
            <br>
            <div id="myBoard"></div>
            <p style="font-size: 0.8rem; color: #777; margin-top: 10px;">Auto-Queen Promotion aktiv</p>
        </div>
    </div>

    <script>
        // --- KONFIGURATION ---
        const PREFIX = "gh-chess-aaa-";
        let peer = null;
        let conn = null;
        let myColor = 'white'; // Host ist immer Weiß
        
        // --- SCHACH VARIABLEN ---
        let board = null;
        let game = new Chess();
        
        // --- UI FUNKTIONEN ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // URL Check (Auto-Join via QR)
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if(params.has('join')) {
                document.getElementById('join-code').value = params.get('join');
                joinLobby();
            }
        };

        // --- NETZWERK LOGIK ---

        function createLobby() {
            const code = Math.random().toString(36).substring(2, 6).toUpperCase();
            const peerId = PREFIX + code;

            showScreen('lobby-screen');
            document.getElementById('display-code').innerText = code;

            // QR Code
            const url = window.location.href.split('?')[0] + '?join=' + code;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 150, height: 150 });

            peer = new Peer(peerId);
            
            peer.on('open', (id) => { console.log('Lobby offen:', id); });
            
            peer.on('connection', (c) => {
                conn = c;
                setupConnection();
            });
            
            peer.on('error', (err) => { 
                alert("Verbindungsfehler oder Code belegt."); 
                location.reload(); 
            });
        }

        function joinLobby() {
            const code = document.getElementById('join-code').value.toUpperCase().trim();
            if(code.length < 4) return alert("Code ungültig");

            myColor = 'black'; // Joiner ist Schwarz
            peer = new Peer(); // Zufalls-ID für den Joiner

            peer.on('open', () => {
                const hostId = PREFIX + code;
                conn = peer.connect(hostId);
                setupConnection();
            });

            peer.on('error', () => { alert("Host nicht gefunden."); showScreen('menu-screen'); });
        }

        function setupConnection() {
            conn.on('open', () => {
                console.log("Verbunden!");
                startGame();
            });

            conn.on('data', (data) => {
                // Wir empfangen einen Zug vom Gegner
                handleRemoteMove(data);
            });
            
            conn.on('close', () => {
                alert("Gegner hat die Verbindung getrennt.");
                location.href = window.location.href.split('?')[0];
            });
        }

        // --- SCHACH LOGIK ---

        function startGame() {
            showScreen('game-screen');
            
            // Brett Konfiguration
            const config = {
                draggable: true,
                position: 'start',
                orientation: myColor, // Brett drehen für Schwarz
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd
            };
            
            board = Chessboard('myBoard', config);
            updateStatus();
            
            // Responsive resize hack
            window.addEventListener('resize', board.resize);
        }

        function onDragStart(source, piece, position, orientation) {
            // Spiel vorbei?
            if (game.game_over()) return false;

            // Ist es mein Zug?
            if ((game.turn() === 'w' && myColor !== 'white') ||
                (game.turn() === 'b' && myColor !== 'black')) {
                return false;
            }

            // Darf ich diese Figur bewegen?
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        function onDrop(source, target) {
            // Versuche den Zug in der Chess.js Engine auszuführen
            const move = game.move({
                from: source,
                to: target,
                promotion: 'q' // HINWEIS: Vereinfachung - immer Dame bei Bauerumwandlung
            });

            // Ungültiger Zug?
            if (move === null) return 'snapback';

            updateStatus();

            // Zug an Gegner senden
            if(conn && conn.open) {
                conn.send({
                    from: source,
                    to: target,
                    promotion: 'q'
                });
            }
        }

        // Empfange Zug vom Gegner
        function handleRemoteMove(moveData) {
            game.move(moveData);
            board.position(game.fen());
            updateStatus();
        }

        // Aktualisiert das Brett nach Animation (wichtig für Rochade/En Passant)
        function onSnapEnd() {
            board.position(game.fen());
        }

        function updateStatus() {
            let status = '';
            const moveColor = (game.turn() === 'w') ? 'Weiß' : 'Schwarz';
            
            // Checkmate?
            if (game.in_checkmate()) {
                status = 'Spiel vorbei: ' + moveColor + ' ist Schachmatt.';
            } else if (game.in_draw()) {
                status = 'Spiel vorbei: Remis.';
            } else {
                if (game.turn() === myColor.charAt(0)) {
                    status = "<span class='turn-indicator'>Du bist am Zug!</span>";
                } else {
                    status = "<span class='turn-wait'>Gegner überlegt...</span>";
                }
                
                if (game.in_check()) {
                    status += " (SCHACH!)";
                }
            }
            
            document.getElementById('status').innerHTML = status;
        }
    </script>
</body>
</html>
